<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Soltra App â€” Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Auth wrapper -->
  <div id="auth-wrapper">
    <div class="auth-card">
      <h2>Sign in to Soltra</h2>
      <p class="auth-subtitle">Use your email to manage your contractor payouts.</p>

      <form id="auth-form">
        <input type="email" name="email" placeholder="you@company.com" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit" class="btn auth-btn"><span>Sign in</span></button>
      </form>

      <button id="auth-toggle-mode" class="auth-toggle">
        New here? Create an account
      </button>

      <p id="auth-message" class="auth-message"></p>
      <button id="signout-btn" class="mini-btn" style="display:none;">Sign out</button>
    </div>
  </div>

  <!-- Simple app header (logo + back to site) -->
  <header class="site-header">
    <div class="nav-logo">
      <img src="soltra-s.png" alt="Soltra logo" class="nav-logo-img" />
      <span class="nav-logo-text">Soltra</span>
    </div>

    <nav class="site-nav">
      <a href="index.html">Back to site</a>
    </nav>

    <div class="site-nav-cta"></div>
  </header>

  <!-- APP SHELL -->
  <section class="app-shell">
    <div class="app-layout">
      <!-- Sidebar -->
      <aside class="app-sidebar">
        <div class="sidebar-logo">
          <div class="sidebar-mark">S</div>
          <span>Soltra</span>
        </div>

        <nav class="app-tabs">
          <button class="tab-button" data-target="dashboard">
            <span>Overview</span>
          </button>
        
          <button class="tab-button" data-target="contractors">
            <span>Contractors</span>
            <span class="tab-pill" id="sidebar-contractors-count"></span>
          </button>
        
          <button class="tab-button" data-target="payouts">
            <span>Payouts</span>
            <span class="tab-pill" id="sidebar-payouts-count"></span>
          </button>
        
          <button class="tab-button" data-target="reports">
            <span>Reports</span>
          </button>
        </nav>


        <div class="sidebar-foot">
          <span class="sidebar-label">Environment</span>
          <span class="sidebar-pill">Sandbox</span>
        </div>
      </aside>

      <!-- Main content -->
      <div class="app-main">
        <header class="app-header">
          <div>
            <h2>Soltra Dashboard</h2>
            <p>Track stablecoin payouts, contractors, and reporting in one place.</p>
          </div>
          <div class="app-header-controls">
            <select class="app-select">
              <option>This month</option>
              <option>Last month</option>
              <option>Last 90 days</option>
            </select>
            <div class="user-pill">
              <span class="user-avatar">L</span>
              <span class="user-name">You</span>
            </div>
          </div>
        </header>

        <div class="app-main-inner">
          <!-- DASHBOARD VIEW -->
          <div id="view-dashboard" class="app-view">
            <div class="shell dashboard-shell">
              <!-- Onboarding banner -->
              <div id="onboarding-banner" class="onboarding-banner hidden">
                <div class="onboarding-main">
                  <h3>Get started in two steps</h3>
                  <p class="onboarding-text">
                    Add a contractor, log your first payout, and weâ€™ll populate this dashboard
                    with real USDC activity.
                  </p>
          
                  <div class="onboarding-steps">
                    <div class="onboarding-step">
                      <div class="onboarding-step-number">1</div>
                      <div class="onboarding-step-body">
                        <div class="onboarding-step-title">Add a contractor</div>
                        <div class="onboarding-step-text">
                          Save a contributor with a wallet address so you can select them later.
                        </div>
                        <button
                          type="button"
                          class="mini-btn onboarding-cta"
                          id="onboarding-go-contractors"
                        >
                          Go to Contractors
                        </button>
                      </div>
                    </div>
          
                    <div class="onboarding-step">
                      <div class="onboarding-step-number">2</div>
                      <div class="onboarding-step-body">
                        <div class="onboarding-step-title">Log a payout</div>
                        <div class="onboarding-step-text">
                          Record an on-chain USDC transfer with chain, amount, and TX hash.
                        </div>
                        <button
                          type="button"
                          class="mini-btn onboarding-cta"
                          id="onboarding-go-payouts"
                        >
                          Go to Payouts
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
          
                <button
                  type="button"
                  class="onboarding-dismiss"
                  id="onboarding-dismiss"
                  aria-label="Dismiss"
                >
                  Ã—
                </button>
              </div>
              
              <!-- Top bar: title + filters -->
              <div class="dash-header">
                <div>
                  <h2 class="dash-title">Dashboard</h2>
                  <p class="dash-subtitle">
                    Overview of your USDC payouts and contractors across chains.
                  </p>
                </div>
              
                <div class="dash-filters-wrap">
                  <div class="dash-filters">
                    <div class="dash-filter-group">
                      <label for="dash-range">Range</label>
                      <select id="dash-range">
                        <option value="7d">Last 7 days</option>
                        <option value="30d" selected>Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="all">All time</option>
                      </select>
                    </div>
              
                    <div class="dash-filter-group">
                      <label for="dash-chain">Chain</label>
                      <select id="dash-chain">
                        <option value="all" selected>All chains</option>
                        <option value="BASE">Base</option>
                        <option value="POLYGON">Polygon</option>
                        <option value="ETHEREUM">Ethereum</option>
                      </select>
                    </div>
                  </div>
              
                  <div class="dash-updated" id="dash-updated"></div>
                </div>
              </div>


              <!-- KPI cards -->
              <div class="dash-kpi-row">
                <div class="dash-card">
                  <div class="dash-card-label">Total payouts</div>
                  <div id="dash-total-30d" class="dash-card-value">$0</div>
                  <div id="dash-payout-count" class="dash-card-sub">0 payouts</div>
                </div>

                <div class="dash-card">
                  <div class="dash-card-label">Active contractors</div>
                  <div id="dash-contractors" class="dash-card-value">0</div>
                  <div class="dash-card-sub">With payouts in this range</div>
                </div>

                <div class="dash-card">
                  <div class="dash-card-label">Chains used</div>
                  <div id="dash-chains" class="dash-card-value">0</div>
                  <div id="dash-chain-list" class="dash-card-sub">No activity yet.</div>
                </div>
              </div>

              <!-- Recent payouts table -->
              <div class="dash-card dash-table-card">
                <div class="dash-card-header">
                  <div>
                    <div class="dash-card-label">Recent payouts</div>
                    <div class="dash-card-sub">
                      Latest on-chain payouts matching your filters.
                    </div>
                  </div>
                </div>

                <div class="dash-table-wrapper">
                  <table class="dash-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Contractor</th>
                        <th>Amount</th>
                        <th>Chain</th>
                        <th>Tx hash</th>
                      </tr>
                    </thead>
                    <tbody id="dash-payouts-table">
                      <tr>
                        <td colspan="5">Loading payoutsâ€¦</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Charts -->
              <section class="dash-charts">
                <div class="chart-card">
                  <div class="chart-card-header">
                    <h3>Monthly payout volume</h3>
                    <p>USDC paid out over the last few months.</p>
                  </div>
                  <canvas id="payoutVolumeChart"></canvas>
                </div>

                <div class="chart-card">
                  <div class="chart-card-header">
                    <h3>Chains used</h3>
                    <p>Share of payouts by chain.</p>
                  </div>
                  <canvas id="chainSplitChart"></canvas>
                </div>
              </section>

              <div class="card card-side">
                <h3 class="card-title">This month snapshot</h3>
                <ul class="summary-list">
                  <li>
                    <span>Total contractors paid</span>
                    <strong id="snapshot-contractors">0</strong>
                  </li>
                  <li>
                    <span>Average payout size</span>
                    <strong id="snapshot-avg">$0</strong>
                  </li>
                  <li>
                    <span>CSV exports</span>
                    <strong>0</strong>
                  </li>
                  <li>
                    <span>Failed payouts</span>
                    <strong>0</strong>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <!-- CONTRACTORS VIEW -->
          <div id="view-contractors" class="app-view hidden">
            <div class="shell dashboard-shell">
              <div class="section-header">
                <div>
                  <h2 class="section-title">Contractors</h2>
                  <p class="section-subtitle">
                    Add and manage wallets for contributors, freelancers, and core team.
                  </p>
                </div>
              </div>

              <div class="two-column-layout">
                <!-- LEFT: add contractor form -->
                <div class="form-card">
                  <h3 class="form-title">Add contractor</h3>
                  <p class="form-subtitle">
                    Store basic details and a payout address. You can edit or remove them later.
                  </p>

                  <form id="add-contractor-form" onsubmit="addContractor(event)" class="form-grid">
                    <div class="field">
                      <label class="field-label">Name<span>*</span></label>
                      <input
                        type="text"
                        name="name"
                        class="input-control"
                        placeholder="Jane Doe"
                        required
                      />
                    </div>

                    <div class="field">
                      <label class="field-label">Role</label>
                      <input
                        type="text"
                        name="role"
                        class="input-control"
                        placeholder="Solidity dev, Designer, Opsâ€¦"
                      />
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Wallet address<span>*</span></label>
                      <input
                        type="text"
                        name="wallet_address"
                        class="input-control mono"
                        placeholder="0x..."
                        required
                      />
                      <p class="field-help">
                        EVM-compatible address where payouts will be sent.
                      </p>
                    </div>

                    <div class="field">
                      <label class="field-label">Country</label>
                      <input
                        type="text"
                        name="country"
                        class="input-control"
                        placeholder="Estonia, US, Nigeriaâ€¦"
                      />
                    </div>

                    <div class="field full-row">
                      <button type="submit" class="btn primary-btn">
                        Save contractor
                      </button>
                    </div>
                  </form>
                </div>

                <!-- RIGHT: contractors table -->
                <div class="table-card">
                  <div class="table-card-header">
                    <div>
                      <h3 class="form-title">Saved contractors</h3>
                      <p class="form-subtitle">
                        These wallets will show up when logging payouts.
                      </p>
                    </div>
                  </div>

                  <div class="dash-table-wrapper">
                    <table class="dash-table">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Wallet</th>
                          <th>Role</th>
                          <th>Country</th>
                          <th>Last paid</th>
                        </tr>
                      </thead>
                      <tbody id="contractors-body">
                        <tr>
                          <td colspan="5">No contractors yet.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- PAYOUTS VIEW -->
          <div id="view-payouts" class="app-view hidden">
            <div class="shell dashboard-shell">
              <div class="section-header">
                <div>
                  <h2 class="section-title">Payouts</h2>
                  <p class="section-subtitle">
                    Log USDC payouts youâ€™ve sent on-chain and keep a clean audit trail.
                  </p>
                </div>
              </div>

              <div class="two-column-layout">
                <!-- LEFT: add payout form -->
                <div class="form-card">
                  <h3 class="form-title">Log a payout</h3>
                  <p class="form-subtitle">
                    Record an on-chain transfer youâ€™ve already sent from your treasury
                    wallet or multisig.
                  </p>

                  <form id="payout-form" class="form-grid">
                    <div class="field">
                      <label class="field-label">Contractor<span>*</span></label>
                      <select
                        id="payout-contractor"
                        name="contractor_id"
                        class="input-control"
                        required
                      >
                        <option value="">Select contractor</option>
                      </select>
                    </div>

                    <div class="field">
                      <label class="field-label">Amount (USDC)<span>*</span></label>
                      <input
                        type="number"
                        name="amount"
                        class="input-control"
                        placeholder="1200"
                        step="0.01"
                        min="0"
                        required
                      />
                    </div>

                    <div class="field">
                      <label class="field-label">Chain<span>*</span></label>
                      <select name="chain" class="input-control" required>
                        <option value="">Select chain</option>
                        <option value="BASE">Base</option>
                        <option value="POLYGON">Polygon</option>
                        <option value="ETHEREUM">Ethereum</option>
                      </select>
                    </div>

                    <div class="field">
                      <label class="field-label">Date</label>
                      <input
                        type="date"
                        name="tx_date"
                        class="input-control"
                      />
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Tx hash<span>*</span></label>
                      <input
                        type="text"
                        name="tx_hash"
                        class="input-control mono"
                        placeholder="0x..."
                        required
                      />
                      <p class="field-help">
                        Paste the transaction hash from your block explorer.
                      </p>
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Notes</label>
                      <textarea
                        name="note"
                        class="input-control textarea-control"
                        rows="2"
                        placeholder="September retainer, milestone 2, bonusâ€¦"
                      ></textarea>
                    </div>

                    <div class="field full-row">
                      <button type="submit" id="save-payout-btn" class="btn primary-btn">
                        Save payout
                      </button>
                    </div>
                  </form>
                </div>

                <!-- RIGHT: payout logs table -->
                <div class="table-card">
                  <div class="table-card-header">
                    <div>
                      <h3 class="form-title">Payout log</h3>
                      <p class="form-subtitle">
                        Recent payouts based on your current filters (range &amp; chain).
                      </p>
                    </div>
                  </div>

                  <div class="dash-table-wrapper">
                    <table class="dash-table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Contractor</th>
                          <th>Amount</th>
                          <th>Chain</th>
                          <th>Tx hash</th>
                        </tr>
                      </thead>
                      <tbody id="payouts-body">
                        <tr>
                          <td colspan="5">No payouts yet.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>

                  <!-- ================= REPORTS VIEW ================= -->
          <div class="app-view hidden" id="view-reports">
            <div class="list-header">
              <div>
                <h3>Reports</h3>
                <p class="section-subtitle">
                  CSV-ready view of payouts matching your dashboard filters
                  (range &amp; chain).
                </p>
              </div>
              <button class="mini-btn" id="reports-export-btn">Export CSV</button>
            </div>
  
            <!-- Empty state -->
            <div class="reports-empty" id="reports-empty">
              <h4>No payouts yet</h4>
              <p>
                Once you log payouts, this view will summarize them for finance
                and operations.
              </p>
              <button type="button" class="mini-btn" id="reports-go-payouts">
                Log a payout
              </button>
            </div>
  
            <!-- Table uses same style as dashboard -->
            <div class="dash-table-wrapper hidden" id="reports-table-wrapper">
              <table class="dash-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Contractor</th>
                    <th>Amount</th>
                    <th>USD value</th>
                    <th>Tx hash</th>
                  </tr>
                </thead>
                <tbody id="reports-body">
                  <tr>
                    <td colspan="5">Loadingâ€¦</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- Payout detail side panel -->
  <div id="payout-detail-root">
    <div id="payout-detail-backdrop" class="payout-detail-backdrop"></div>
  
    <aside id="payout-detail-panel" class="payout-detail-panel">
      <div class="pd-header">
        <div>
          <div class="pd-kicker">Payout details</div>
          <h2 class="pd-title" id="pd-contractor">â€”</h2>
        </div>
        <button id="pd-close" type="button" class="pd-close-btn" aria-label="Close">
          Ã—
        </button>
      </div>
  
      <div class="pd-body">
        <div class="pd-row">
          <span class="pd-label">Date</span>
          <span class="pd-value" id="pd-date">â€”</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Amount</span>
          <span class="pd-value" id="pd-amount">â€”</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Chain</span>
          <span class="pd-value" id="pd-chain">â€”</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Tx hash</span>
          <span class="pd-value">
            <code id="pd-txhash">â€”</code>
          </span>
        </div>
        <div class="pd-row pd-row-notes">
          <span class="pd-label">Notes</span>
          <p class="pd-notes" id="pd-note">No notes for this payout.</p>
        </div>
      </div>
    </aside>
  </div>


  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Dashboard chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // === Supabase config (DEV ONLY) ===
    const SUPABASE_URL = 'https://lvuvkgnkhrzpwlssupyh.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dXZrZ25raHJ6cHdsc3N1cHloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDkyOTIsImV4cCI6MjA3ODkyNTI5Mn0.9C1-3Di7tXJCgb_7ZHj7mz6QL5fDMvnvmBziYqgGeDs';
    
    // âœ… ONE client, memory-only auth (fixes GitHub Pages + tracking prevention)
    window.__soltra_sb__ =
      window.__soltra_sb__ ||
      window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: false,      // ðŸ”¥ THIS is the key fix
          autoRefreshToken: false,
          detectSessionInUrl: false,
        },
      });
    
    const sb = window.__soltra_sb__;



    // === GLOBAL STATE ===
    let contractorsCache = [];
    let authMode = 'signin';       // 'signin' | 'signup'
    let filterRange = '30d';       // '7d' | '30d' | '90d' | 'all'
    let filterChain = 'all';       // 'all' | 'BASE' | 'POLYGON' | 'ETHEREUM'
    let lastDashboardPayoutCount = 0;
    let dashboardPayoutsCache = [];


    // === UTILITIES ===
    function formatUSD(amount) {
      if (!amount || isNaN(amount)) return '$0';
      return `$${amount.toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      })}`;
    }

    function showToast(message = 'Copied!') {
      const toast = document.getElementById('toast');
      if (!toast) return;
    
      toast.textContent = message;
      toast.classList.remove('hidden');
      toast.classList.add('toast-visible');
    
      // clear previous timer if any
      clearTimeout(showToast._timeout);
      showToast._timeout = setTimeout(() => {
        toast.classList.remove('toast-visible');
        toast.classList.add('hidden');
      }, 1800);
    }


    function setAuthMessage(text, type = '') {
      const el = document.getElementById('auth-message');
      if (!el) return;
      el.textContent = text || '';
      el.className = 'auth-message';
      if (type) el.classList.add(type);
    }

    function setAuthMode(mode) {
      authMode = mode;
      const toggle = document.getElementById('auth-toggle-mode');
      const btn = document.querySelector('#auth-form .auth-btn');
      if (!toggle || !btn) return;

      if (mode === 'signin') {
        btn.textContent = 'Sign in';
        toggle.textContent = 'New here? Create an account';
      } else {
        btn.textContent = 'Create account';
        toggle.textContent = 'Already have an account? Sign in';
      }
      setAuthMessage('');
    }

    function highlightDashboard() {
    // KPIs + table card
    const hardTargets = document.querySelectorAll('.dash-card');
    hardTargets.forEach((el) => {
      el.classList.remove('dash-pulse');          // reset if still on
      void el.offsetWidth;                        // force reflow
      el.classList.add('dash-pulse');
    });
  
    // Charts
    const softTargets = document.querySelectorAll('.chart-card');
    softTargets.forEach((el) => {
      el.classList.remove('dash-pulse-soft');
      void el.offsetWidth;
      el.classList.add('dash-pulse-soft');
    });
  }


    // === TAB NAVIGATION ===
    // === TAB NAVIGATION ===
    function initTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const views = {
        dashboard: document.getElementById('view-dashboard'),
        contractors: document.getElementById('view-contractors'),
        payouts: document.getElementById('view-payouts'),
        reports: document.getElementById('view-reports'),
      };
    
      if (!tabButtons.length) return;
    
        function showTab(target) {
        // activate the matching button
        tabButtons.forEach((btn) => {
          const isActive = btn.dataset.target === target;
          btn.classList.toggle('active', isActive);
        });
    
        // show/hide corresponding views
        Object.entries(views).forEach(([key, el]) => {
          if (!el) return;
          if (key === target) el.classList.remove('hidden');
          else el.classList.add('hidden');
        });
    
        // persist selection (best-effort)
        try {
          localStorage.setItem('soltra-active-tab', target);
        } catch (e) {}
    
        if (target === 'dashboard') {
          requestAnimationFrame(() => highlightDashboard());
        }
    
        if (target === 'reports') {
          loadReportsFromCache();
        }
      }


      // click handlers
      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.target;
          if (target) showTab(target);
        });
      });
    
      // Decide initial tab:
      // 1) URL hash (e.g. app.html#payouts)
      // 2) localStorage
      // 3) default "dashboard"
      let initial = 'dashboard';
    
      // 1) hash
      const hash = window.location.hash.replace('#', '');
      if (hash && views[hash]) {
        initial = hash;
      } else {
        // 2) localStorage
        try {
          const saved = localStorage.getItem('soltra-active-tab');
          if (saved && views[saved]) initial = saved;
        } catch (e) {
          // ignore
        }
      }
    
      showTab(initial);
    }

    function shortenWallet(addr) {
      if (!addr || typeof addr !== 'string') return '';
      if (addr.length <= 12) return addr;
      return addr.slice(0, 6) + '...' + addr.slice(-4);
    }

    // === CONTRACTORS ===
    async function loadContractors() {
      const tbody = document.getElementById('contractors-body');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="5">Loading contractors...</td></tr>';
      }

      try {
        const tbody = document.getElementById('contractors-body');
      
        const { data, error } = await sb
          .from('contractors')
          .select('*')
          .order('name', { ascending: true });
      
        console.log('LOAD CONTRACTORS RESULT:', { data, error });
      
        if (error) {
          console.error('Error loading contractors:', error);
          if (tbody) {
            tbody.innerHTML =
              `<tr><td colspan="5">Error loading data</td></tr>`;
          }
          return;
        }
      
        const contractors = data || [];
        contractorsCache = contractors;
      
        // Update sidebar contractors count
        const contractorsCountEl =
          document.getElementById('sidebar-contractors-count');
        if (contractorsCountEl) {
          contractorsCountEl.textContent =
            contractors.length ? contractors.length : '';
        }
      
        // Refresh onboarding banner visibility
        updateOnboardingBanner(contractors.length, lastDashboardPayoutCount);
      
        if (tbody) {
          if (!contractors.length) {
            tbody.innerHTML = `
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    <div class="empty-state-title">No contractors yet</div>
                    <p class="empty-state-text">
                      Use the form on the left to add your first contractor.
                    </p>
                  </div>
                </td>
              </tr>
            `;
          } else {
            tbody.innerHTML = '';
            contractors.forEach(c => {
              const tr = document.createElement('tr');
              const lastPaid = c.last_paid_at
                ? new Date(c.last_paid_at).toLocaleDateString()
                : 'â€”';
      
              tr.innerHTML = `
                <td>${c.name || ''}</td>
                <td>
                  <div class="wallet-cell">
                    <div class="wallet-avatar">
                      ${(c.name || c.wallet_address || '?')[0].toUpperCase()}
                    </div>
                    <span class="wallet-text">
                      ${shortenWallet(c.wallet_address || '')}
                    </span>
                  </div>
                </td>
                <td>${c.role || ''}</td>
                <td>${c.country || ''}</td>
                <td>${lastPaid}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        }
      
        populateContractorSelect();
      
      } catch (err) {
        console.error(err);
        const tbody = document.getElementById('contractors-body');
        if (tbody) {
          tbody.innerHTML =
            '<tr><td colspan="5">Error loading contractors.</td></tr>';
        }
      }
    }
    
    function populateContractorSelect() {
      const select = document.getElementById('payout-contractor');
      if (!select) return;

      select.innerHTML = '<option value="">Select contractor</option>';

      contractorsCache.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name || c.wallet_address;
        select.appendChild(opt);
      });
    }

    function updateOnboardingBanner(contractorCount, payoutCount) {
      const banner = document.getElementById('onboarding-banner');
      if (!banner) return;
    
      let dismissed = false;
      try {
        dismissed = localStorage.getItem('soltra-onboarding-dismissed') === '1';
      } catch (e) {
        // ignore
      }
    
      if (dismissed) {
        banner.classList.add('hidden');
        return;
      }
    
      // Show as long as you are missing either contractors or payouts
      if (!contractorCount || !payoutCount) {
        banner.classList.remove('hidden');
      } else {
        banner.classList.add('hidden');
      }
    }
    
    function exportPayoutsToCsv() {
      const data = dashboardPayoutsCache || [];
    
      if (!data.length) {
        alert('No payouts to export for this range.');
        return;
      }
    
      const headers = [
        'Date',
        'Contractor',
        'Amount (USDC)',
        'USD Value',
        'Chain',
        'Tx Hash',
        'Note',
      ];
    
      const rows = data.map((p) => {
        const date = p.tx_timestamp
          ? new Date(p.tx_timestamp).toISOString()
          : '';
        const name = p.contractors?.name || '';
        const amount = Number(p.amount || 0);
        const amountUsdc = amount.toString();
        const usdValue = amount.toString(); // 1 USDC = $1 assumption
        const chain = (p.chain || '').toUpperCase();
        const txHash = p.tx_hash || '';
        const note = (p.note || '').replace(/"/g, '""');
    
        return [date, name, amountUsdc, usdValue, chain, txHash, note];
      });
    
      const lines = [];
      lines.push(headers.join(','));
    
      rows.forEach((cols) => {
        const line = cols
          .map((value) => {
            const v = value == null ? '' : String(value);
            if (/[",\n]/.test(v)) return `"${v.replace(/"/g, '""')}"`;
            return v;
          })
          .join(',');
        lines.push(line);
      });
    
      const csvContent = lines.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
    
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const d = String(today.getDate()).padStart(2, '0');
      const filename = `soltra-payouts-${y}-${m}-${d}.csv`;
    
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    
      URL.revokeObjectURL(url);
    }


    function loadReportsFromCache() {
      const tbody = document.getElementById('reports-body');
      const empty = document.getElementById('reports-empty');
      const wrapper = document.getElementById('reports-table-wrapper');
    
      if (!tbody || !empty || !wrapper) return;
    
      // No payouts for current filters
      if (!dashboardPayoutsCache || !dashboardPayoutsCache.length) {
        empty.classList.remove('hidden');
        wrapper.classList.add('hidden');
        tbody.innerHTML =
          '<tr><td colspan="5">No payouts for this range.</td></tr>';
        return;
      }
    
      // We have data
      empty.classList.add('hidden');
      wrapper.classList.remove('hidden');
    
      tbody.innerHTML = '';
      dashboardPayoutsCache.forEach((p) => {
        const date = p.tx_timestamp
          ? new Date(p.tx_timestamp).toLocaleDateString()
          : 'â€”';
        const name = p.contractors?.name || 'Unknown';
        const amount = `${p.amount} ${p.asset_symbol || 'USDC'}`;
    
        // For now assume 1 USDC = $1; you can later plug in FX if you want
        const usdValue = `$${Number(p.amount || 0).toLocaleString('en-US', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        })}`;
    
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date}</td>
          <td>${name}</td>
          <td>${amount}</td>
          <td>${usdValue}</td>
          <td>${p.tx_hash}</td>
        `;
        tbody.appendChild(tr);
      });
    }



    async function addContractor(event) {
      console.log("addContractor fired");
      alert("addContractor fired");
      event.preventDefault();
    
      const form = event.target;
      const formData = new FormData(form);
    
      const name = formData.get('name')?.trim();
      const wallet_address = formData.get('wallet_address')?.trim();
      const role = formData.get('role')?.trim();
      const country = formData.get('country')?.trim();
    
      if (!name || !wallet_address) {
        alert('Name and wallet address are required.');
        return;
      }
    
      // Must have a logged-in user, otherwise RLS will block inserts
      const { data: userData, error: userErr } = await sb.auth.getUser();
      const user = userData?.user;
    
      if (userErr || !user) {
        console.error('Not signed in / cannot fetch user:', userErr);
        alert('You must be signed in.');
        return;
      }
    
      const result = await sb
        .from('contractors')
        .insert([{ name, wallet_address, role, country }])
        .select();
      
      console.log("INSERT RESULT:", result);
      
      if (result.error) {
        alert(result.error.message);
        return;
      }
      
      alert("Saved!");

    
      form.reset();
      await loadContractors();
    }




    // === CHAIN ICON RENDERING ===
    function renderChainPill(chain) {
      if (!chain) return '';

      const c = chain.toLowerCase();
      let logo = '';
      let label = '';

      if (c.includes('base')) {
        logo = 'https://assets.coingecko.com/coins/images/31069/small/base-logo.png';
        label = 'Base';
      } else if (c.includes('eth')) {
        logo = 'https://cryptocurrencyicons.s3.amazonaws.com/blockchains/ethereum.png';
        label = 'Ethereum';
      } else if (c.includes('poly') || c.includes('matic')) {
        logo = 'https://cryptocurrencyicons.s3.amazonaws.com/blockchains/polygon.png';
        label = 'Polygon';
      } else {
        logo = 'https://cryptocurrencyicons.s3.amazonaws.com/blockchains/generic.png';
        label = chain;
      }

      return `
        <span class="chain-pill">
          <img src="${logo}" alt="${label} logo">
          <span>${label}</span>
        </span>
      `;
    }

    function getExplorerUrl(chain, txHash) {
      if (!txHash) return '#';
      const c = (chain || '').toUpperCase();
    
      if (c.includes('BASE')) {
        return `https://basescan.org/tx/${txHash}`;
      }
      if (c.includes('POLYGON') || c.includes('MATIC')) {
        return `https://polygonscan.com/tx/${txHash}`;
      }
      if (c.includes('ETH')) {
        return `https://etherscan.io/tx/${txHash}`;
      }
      // Fallback â€“ you can change this later if you support more chains
      return `https://etherscan.io/tx/${txHash}`;
    }
    
    function shortenHash(txHash) {
      if (!txHash || txHash.length <= 12) return txHash || '';
      return txHash.slice(0, 6) + '...' + txHash.slice(-4);
    }


    function openPayoutDetailFromRow(tr) {
      const root = document.getElementById('payout-detail-root');
      if (!root || !tr) return;
    
      const date = tr.dataset.date || 'â€”';
      const contractor = tr.dataset.contractor || 'Unknown';
      const amount = tr.dataset.amount || 'â€”';
      const chain = tr.dataset.chain || 'â€”';
      const txhash = tr.dataset.txhash || 'â€”';
      const note = tr.dataset.note || 'No notes for this payout.';
    
      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };
    
      setText('pd-date', date);
      setText('pd-contractor', contractor);
      setText('pd-amount', amount);
      setText('pd-chain', chain);
      setText('pd-txhash', txhash);
      setText('pd-note', note);
    
      root.classList.add('payout-detail-open');
    }
    
    function closePayoutDetail() {
      const root = document.getElementById('payout-detail-root');
      if (!root) return;
      root.classList.remove('payout-detail-open');
    }
    function fillPayoutModalFromRow(tr) {
      if (!tr) return;
      document.getElementById('payout-modal-date').textContent = tr.dataset.date || '';
      document.getElementById('payout-modal-contractor').textContent = tr.dataset.contractor || '';
      document.getElementById('payout-modal-amount').textContent = tr.dataset.amount || '';
      document.getElementById('payout-modal-chain').textContent = tr.dataset.chain || '';
      document.getElementById('payout-modal-txhash').textContent = tr.dataset.txhash || '';
      document.getElementById('payout-modal-note').textContent = tr.dataset.note || '';
    }
    
    let activePayoutRow = null;

    function openPayoutModalFromRow(tr) {
      const modal = document.getElementById('payout-modal');
      if (!modal) return;
    
      activePayoutRow = row;
    
      // ---- Fill modal from dataset (same as before) ----
      const dateEl       = document.getElementById('payout-modal-date');
      const contractorEl = document.getElementById('payout-modal-contractor');
      const amountEl     = document.getElementById('payout-modal-amount');
      const chainEl      = document.getElementById('payout-modal-chain');
      const hashEl       = document.getElementById('payout-modal-txhash');
      const noteEl       = document.getElementById('payout-modal-note');
    
      if (dateEl)       dateEl.textContent       = row.dataset.date || 'â€”';
      if (contractorEl) contractorEl.textContent = row.dataset.contractor || 'â€”';
      if (amountEl)     amountEl.textContent     = row.dataset.amount || 'â€”';
      if (chainEl)      chainEl.textContent      = row.dataset.chain || 'â€”';
      if (hashEl)       hashEl.textContent       = row.dataset.txhash || 'â€”';
      if (noteEl)       noteEl.textContent       = row.dataset.note || 'â€”';
    
      // ---- Animate open ----
      modal.classList.remove('hidden');
      // wait one frame so transitions fire
      requestAnimationFrame(() => {
        modal.classList.add('payout-modal--open');
      });
    
      const closeBtn = document.getElementById('payout-modal-close');
      closeBtn?.focus();
    }

    async function handleDeletePayout() {
      const modal = document.getElementById('payout-modal');
      if (!modal) return;
    
      const payoutId = modal.dataset.payoutId;
      if (!payoutId) {
        alert('Missing payout id.');
        return;
      }
    
      const confirmDelete = window.confirm(
        'Delete this payout from Soltra? This will not move any on-chain funds.'
      );
      if (!confirmDelete) return;
    
      try {
        const { error } = await sb
          .from('payout')      // ðŸ‘ˆ singular table name
          .delete()
          .eq('id', payoutId);
    
        if (error) {
          console.error('Error deleting payout:', error);
          alert(`Error deleting payout: ${error.message}`);
          return;
        }
    
        // Close modal
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        modal.dataset.payoutId = '';
    
        // Refresh UI
        await loadPayouts();
        await loadDashboard();
        highlightDashboard();
      } catch (err) {
        console.error(err);
        alert('Network error while deleting payout.');
      }
    }

    
    function closePayoutModal() {
      const modal = document.getElementById('payout-modal');
      if (!modal) return;
    
      modal.classList.remove('payout-modal--open');
    
      // After transition, hide it
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 190);
    }

    function handlePayoutModalKeyDown(e) {
      const modal = document.getElementById('payout-modal');
      if (!modal || !modal.classList.contains('open')) return;
    
      // ESC closes
      if (e.key === 'Escape') {
        e.preventDefault();
        closePayoutModal();
        return;
      }
    
      // Up/down (and optional vim-style j/k)
      if (e.key === 'ArrowDown' || e.key === 'j') {
        e.preventDefault();
        const rows = getPayoutRows();
        if (!rows.length) return;
    
        const newIndex = Math.min(currentPayoutRowIndex + 1, rows.length - 1);
        const newRow = setActivePayoutRow(newIndex);
        fillPayoutModalFromRow(newRow);
      }
    
      if (e.key === 'ArrowUp' || e.key === 'k') {
        e.preventDefault();
        const rows = getPayoutRows();
        if (!rows.length) return;
    
        const newIndex = Math.max(currentPayoutRowIndex - 1, 0);
        const newRow = setActivePayoutRow(newIndex);
        fillPayoutModalFromRow(newRow);
      }
    }
    
    function attachPayoutModalKeyListeners() {
      document.addEventListener('keydown', handlePayoutModalKeyDown);
    }
    
    function detachPayoutModalKeyListeners() {
      document.removeEventListener('keydown', handlePayoutModalKeyDown);
    }




    // === PAYOUTS ===
    // === PAYOUTS ===
    async function loadPayouts(highlightId = null) {
      const tbody = document.getElementById('payouts-body');
      if (!tbody) return;
    
      tbody.innerHTML = '<tr><td colspan="5">Loading payouts...</td></tr>';
    
      // date filter
      let sinceISO = null;
      if (filterRange !== 'all') {
        const since = new Date();
        if (filterRange === '7d') since.setDate(since.getDate() - 7);
        else if (filterRange === '30d') since.setDate(since.getDate() - 30);
        else if (filterRange === '90d') since.setDate(since.getDate() - 90);
        sinceISO = since.toISOString();
      }
    
      let query = sb
        .from('payout') // ðŸ‘ˆ singular table name
        .select(`
          id,
          amount,
          asset_symbol,
          chain,
          tx_hash,
          tx_timestamp,
          note,
          contractors ( name )
        `)
        .order('tx_timestamp', { ascending: false })
        .limit(50);
    
      if (sinceISO) {
        query = query.gte('tx_timestamp', sinceISO);
      }
      if (filterChain !== 'all') {
        query = query.eq('chain', filterChain);
      }
    
      const { data, error } = await query;
    
      console.log('LOAD PAYOUTS RESULT:', { data, error });
    
      if (error) {
        tbody.innerHTML = `
          <tr><td colspan="5">
            Error loading payouts (${error.message})
          </td></tr>
        `;
        return;
      }
    
      if (!data || !data.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-state-title">No payouts yet</div>
                <p class="empty-state-text">
                  Log a payout to see it appear here.
                </p>
              </div>
            </td>
          </tr>
        `;
        return;
      }
    
      tbody.innerHTML = '';
    
      data.forEach((p) => {
        const date = p.tx_timestamp
          ? new Date(p.tx_timestamp).toLocaleDateString()
          : 'â€”';
    
        const contractor = p.contractors?.name || 'Unknown';
        const amountText = `${p.amount} ${p.asset_symbol || 'USDC'}`;
        const chainUpper = (p.chain || '').toUpperCase();
        const explorerUrl = getExplorerUrl(p.chain, p.tx_hash);
        const shortHash = shortenHash(p.tx_hash);
    
        tbody.insertAdjacentHTML(
          'beforeend',
          `
          <tr class="payout-row">
            <td>${date}</td>
            <td>${contractor}</td>
            <td>${amountText}</td>
            <td>${renderChainPill(p.chain)}</td>
            <td>
              ${
                p.tx_hash
                  ? `<a href="${explorerUrl}"
                         target="_blank"
                         rel="noopener"
                         class="tx-link"
                         title="${p.tx_hash}">
                       ${shortHash}
                     </a>`
                  : 'â€”'
              }
            </td>
          </tr>
        `
        );
    
        // ðŸ”‘ get the row we just added
        const tr = tbody.lastElementChild;
    
        // Make row focusable + button-like for keyboard users
        tr.tabIndex = 0;
        tr.setAttribute('role', 'button');
    
        // Attach dataset for modal
        tr.dataset.date = date;
        tr.dataset.contractor = contractor;
        tr.dataset.amount = amountText;
        tr.dataset.chain = chainUpper;
        tr.dataset.txhash = p.tx_hash || '';
        tr.dataset.note = p.note || '';
        tr.dataset.id = p.id; // in case we need it later
    
        // â­ Highlight newly-added payout (for animation)
        if (highlightId && p.id === highlightId) {
          tr.classList.add('payout-row--new');
        }
    
        // Mouse click opens modal
        tr.addEventListener('click', () => openPayoutModalFromRow(tr));
    
        // Keyboard: Enter / Space also open modal
        tr.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openPayoutModalFromRow(tr);
          }
        });
      });
    }

        // === PAYOUTS ===
    async function addPayout(event) {
      event.preventDefault();
    
      const form = event.target;
      const formData = new FormData(form);
    
      const contractor_id = formData.get('contractor_id');
      const amountStr    = formData.get('amount');
      const chain        = formData.get('chain');
      const tx_hash      = formData.get('tx_hash')?.trim();
      const tx_date      = formData.get('tx_date');
      const note         = formData.get('note')?.trim();
    
      // Basic validation
      if (!contractor_id || !amountStr || !chain || !tx_hash) {
        alert('Contractor, amount, chain, and tx hash are required.');
        return;
      }
    
      const amount = Number(amountStr);
      if (!amount || amount <= 0) {
        alert('Amount must be a positive number.');
        return;
      }
    
      const tx_timestamp = tx_date
        ? new Date(tx_date).toISOString()
        : new Date().toISOString();
    
      // Make sure user is signed in (RLS)
      const { data: userData, error: userErr } = await sb.auth.getUser();
      const user = userData?.user;
      if (userErr || !user) {
        console.error('Not signed in / cannot fetch user:', userErr);
        alert('You must be signed in.');
        return;
      }
    
      // Insert payout via Supabase client
      const { data: inserted, error } = await sb
        .from('payout')
        .insert([
          {
            contractor_id,
            amount,
            asset_symbol: 'USDC',
            chain,
            tx_hash,
            tx_timestamp,
            note
            // user_id will default to auth.uid() in DB
          }
        ])
        .select('id')
        .single();  // we expect exactly one row back
    
      if (error) {
        console.error('Error inserting payout:', error);
        alert(`Error saving payout: ${error.message}`);
        return;
      }
    
      // Clear form
      form.reset();
    
      // ðŸ”¥ Re-load payouts and highlight the new one
      const newId = inserted?.id;
      await loadPayouts(newId);
    
      // Keep dashboard in sync
      await loadDashboard();
      highlightDashboard();
    }


    
  function openPayoutModal(data) {
    const modal = document.getElementById('payout-detail-modal');
    if (!modal) return;
  
    document.getElementById('payout-modal-date').textContent = data.date || 'â€”';
    document.getElementById('payout-modal-contractor').textContent = data.contractor || 'Unknown';
    document.getElementById('payout-modal-amount').textContent = data.amount || 'â€”';
    document.getElementById('payout-modal-chain').textContent = data.chain || 'â€”';
  
    const txEl = document.getElementById('payout-modal-txhash');
    txEl.textContent = data.txHash || 'â€”';
    txEl.href = data.txHash ? `https://etherscan.io/tx/${data.txHash}` : '#';
  
    document.getElementById('payout-modal-note').textContent = data.note || '';
  
    modal.classList.remove('hidden');
  }
  
  function closePayoutModal() {
    const modal = document.getElementById('payout-detail-modal');
    if (modal) modal.classList.add('hidden');
  }
  
  function initPayoutRowClicks() {
    const tbody = document.getElementById('payouts-body');
    if (!tbody) return;
  
    tbody.addEventListener('click', (e) => {
      const tr = e.target.closest('tr');
      if (!tr || !tr.dataset.contractor) return;
      openPayoutModal(tr.dataset);
    });
  
    const modal = document.getElementById('payout-detail-modal');
    const closeBtn = document.getElementById('payout-modal-close');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-backdrop')) {
          closePayoutModal();
        }
      });
    }
    if (closeBtn) {
      closeBtn.addEventListener('click', closePayoutModal);
    }
  }
    

    let currentPayoutRowIndex = -1;
    
    function getPayoutRows() {
      return Array.from(document.querySelectorAll('#payouts-body .payout-row'));
    }
    
    function setActivePayoutRow(index) {
      const rows = getPayoutRows();
      if (!rows.length) {
        currentPayoutRowIndex = -1;
        return;
      }
    
      // Clamp index
      if (index < 0) index = 0;
      if (index >= rows.length) index = rows.length - 1;
    
      currentPayoutRowIndex = index;
    
      rows.forEach(r => r.classList.remove('payout-row--active'));
      const row = rows[currentPayoutRowIndex];
      if (row) {
        row.classList.add('payout-row--active');
        row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    
      return row;
    }


    async function loadDashboard() {
      const totalEl = document.getElementById('dash-total-30d');
      const payoutCountEl = document.getElementById('dash-payout-count');
      const contractorsEl = document.getElementById('dash-contractors');
      const chainsEl = document.getElementById('dash-chains');
      const chainListEl = document.getElementById('dash-chain-list');
      const tableBody = document.getElementById('dash-payouts-table');

      if (!totalEl || !tableBody) return;

      // date filter
      let sinceISO = null;
      if (filterRange !== 'all') {
        const since = new Date();
        if (filterRange === '7d') since.setDate(since.getDate() - 7);
        else if (filterRange === '30d') since.setDate(since.getDate() - 30);
        else if (filterRange === '90d') since.setDate(since.getDate() - 90);
        sinceISO = since.toISOString();
      }

      const params = [
        'select=*,contractors(name)',
        'order=tx_timestamp.desc',
        'limit=200',
      ];

      if (sinceISO) {
        params.push(`tx_timestamp=gte.${encodeURIComponent(sinceISO)}`);
      }
      if (filterChain !== 'all') {
        params.push(`chain=eq.${encodeURIComponent(filterChain)}`);
      }

      const url = `${SUPABASE_URL}/rest/v1/payout?` + params.join('&');

      try {
        const res = await fetch(url, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          },
        });

        if (!res.ok) {
          console.error('Dashboard fetch error', res.status, await res.text());
          totalEl.textContent = '$0';
          payoutCountEl.textContent = 'Error loading payouts';
          return;
        }

        const data = await res.json();
        dashboardPayoutsCache = data;

        // Update "Last updated" timestamp
        const updatedEl = document.getElementById('dash-updated');
        if (updatedEl) {
          const now = new Date();
          const timeString = now.toLocaleTimeString([], {
            hour: 'numeric',
            minute: '2-digit',
          });
          updatedEl.textContent = `Last updated at ${timeString}`;
        }


        const totalAmount = data.reduce(
          (sum, p) => sum + (Number(p.amount) || 0),
          0
        );
        const payoutCount = data.length;

        lastDashboardPayoutCount = payoutCount;
        updateOnboardingBanner(contractorsCache.length || 0, payoutCount);


        // Update sidebar payouts count (for current filter range)
        const payoutsCountEl = document.getElementById('sidebar-payouts-count');
        if (payoutsCountEl) {
          payoutsCountEl.textContent = payoutCount ? payoutCount : '';
        }


        const contractorIds = new Set(
          data.map(p => p.contractor_id).filter(Boolean)
        );
        const chains = new Set(
          data.map(p => (p.chain || '').toUpperCase()).filter(Boolean)
        );

        // ---- "This month snapshot" stats ----
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        // Filter payouts to the current calendar month
        const monthPayouts = data.filter(p => {
          if (!p.tx_timestamp) return false;
          const d = new Date(p.tx_timestamp);
          return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
        });

        const monthTotal = monthPayouts.reduce(
          (sum, p) => sum + (Number(p.amount) || 0),
          0
        );
        const monthCount = monthPayouts.length;
        
        const monthContractorIds = new Set(
          monthPayouts.map(p => p.contractor_id).filter(Boolean)
        );
        
        // Fill snapshot card
        const snapshotContractorsEl = document.getElementById('snapshot-contractors');
        const snapshotAvgEl = document.getElementById('snapshot-avg');
        
        if (snapshotContractorsEl) {
          snapshotContractorsEl.textContent = monthContractorIds.size || 0;
        }
        
        if (snapshotAvgEl) {
          const avg = monthCount ? monthTotal / monthCount : 0;
          snapshotAvgEl.textContent = formatUSD(avg);
        }


        totalEl.textContent = formatUSD(totalAmount);
        payoutCountEl.textContent =
          payoutCount === 1 ? '1 payout' : `${payoutCount} payouts`;

        if (contractorsEl) contractorsEl.textContent = contractorIds.size;
        if (chainsEl) chainsEl.textContent = chains.size || 0;
        if (chainListEl) {
          chainListEl.textContent = chains.size
            ? Array.from(chains).join(' Â· ')
            : 'No payouts for this range.';
        }

        tableBody.innerHTML = '';

        if (!data.length) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <div class="empty-state-title">No payouts in this range</div>
                  <p class="empty-state-text">
                    Adjust the date range above or log a new payout to see activity on
                    your dashboard.
                  </p>
                </div>
              </td>
            </tr>
  `        ;
          return;
        }


        data.slice(0, 10).forEach(p => {
          const tr = document.createElement('tr');

          const date = p.tx_timestamp
            ? new Date(p.tx_timestamp).toLocaleDateString()
            : 'â€”';

          const name = p.contractors?.name || 'Unknown';

          tr.innerHTML = `
            <td>${date}</td>
            <td>${name}</td>
            <td>${p.amount} ${p.asset_symbol || 'USDC'}</td>
            <td>${(p.chain || '').toUpperCase()}</td>
            <td>${p.tx_hash}</td>
          `;
          tableBody.appendChild(tr);
        });

        // ðŸ”¥ NEW â€” update Reports tab using same data
        loadReportsFromCache();
      
      } catch (err) {
        console.error('Dashboard error', err);
        totalEl.textContent = '$0';
        payoutCountEl.textContent = 'Error loading data';
        tableBody.innerHTML =
          '<tr><td colspan="5">Error loading payouts.</td></tr>';
      }
    }

    // ----- Dashboard charts -----
    let payoutVolumeChart = null;
    let chainSplitChart = null;

    async function loadDashboardCharts() {
      const canvas1 = document.getElementById('payoutVolumeChart');
      const canvas2 = document.getElementById('chainSplitChart');
      if (!canvas1 || !canvas2) return;

      try {
        const res = await fetch(
          `${SUPABASE_URL}/rest/v1/payouts?select=amount,chain,tx_timestamp&order=tx_timestamp.asc`,
          {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
          }
        );

        if (!res.ok) {
          console.error('Error loading payouts for charts', await res.text());
          buildChartsWithMockData();
          return;
        }

        const payouts = await res.json();
        if (!payouts.length) {
          buildChartsWithMockData();
          return;
        }

        const { monthlyLabels, monthlyTotals, chainLabels, chainTotals } =
          aggregatePayoutData(payouts);

        renderPayoutVolumeChart(canvas1, monthlyLabels, monthlyTotals);
        renderChainSplitChart(canvas2, chainLabels, chainTotals);
      } catch (err) {
        console.error(err);
        buildChartsWithMockData();
      }
    }

    function aggregatePayoutData(payouts) {
      const monthlyMap = new Map();
      const chainMap = new Map();

      payouts.forEach((p) => {
        const amount = Number(p.amount) || 0;
        const chain = (p.chain || 'OTHER').toUpperCase();

        const date = p.tx_timestamp ? new Date(p.tx_timestamp) : new Date();
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(
          2,
          '0'
        )}`; // YYYY-MM

        monthlyMap.set(key, (monthlyMap.get(key) || 0) + amount);
        chainMap.set(chain, (chainMap.get(chain) || 0) + amount);
      });

      const monthlyLabels = Array.from(monthlyMap.keys()).sort();
      const trimmedLabels = monthlyLabels.slice(-6);
      const monthlyTotals = trimmedLabels.map((k) => monthlyMap.get(k));

      const chainLabels = Array.from(chainMap.keys());
      const chainTotals = chainLabels.map((k) => chainMap.get(k));

      return {
        monthlyLabels: trimmedLabels,
        monthlyTotals,
        chainLabels,
        chainTotals,
      };
    }

    function buildChartsWithMockData() {
      const canvas1 = document.getElementById('payoutVolumeChart');
      const canvas2 = document.getElementById('chainSplitChart');
      if (!canvas1 || !canvas2) return;

      const monthlyLabels = ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'];
      const monthlyTotals = [800, 1200, 950, 2100, 1750, 2300];

      const chainLabels = ['BASE', 'POLYGON', 'ETH', 'OTHER'];
      const chainTotals = [3400, 2100, 900, 300];

      renderPayoutVolumeChart(canvas1, monthlyLabels, monthlyTotals);
      renderChainSplitChart(canvas2, chainLabels, chainTotals);
    }

    function renderPayoutVolumeChart(canvas, labels, data) {
      if (payoutVolumeChart) payoutVolumeChart.destroy();

      payoutVolumeChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Payout volume (USDC)',
              data,
              tension: 0.35,
              fill: true,
              backgroundColor: 'rgba(246, 196, 83, 0.18)',
              borderColor: 'rgba(246, 196, 83, 0.9)',
              borderWidth: 2,
              pointRadius: 3,
              pointBackgroundColor: '#f6c453',
            },
          ],
        },
        options: {
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label(ctx) {
                  const v = ctx.parsed.y || 0;
                  return ` ${v.toLocaleString()} USDC`;
                },
              },
            },
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.03)' },
              ticks: { color: '#9fb0c4', font: { size: 11 } },
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: {
                color: '#9fb0c4',
                font: { size: 11 },
                callback(value) {
                  return value >= 1000
                    ? `${(value / 1000).toFixed(1)}k`
                    : `${value}`;
                },
              },
            },
          },
          responsive: true,
          maintainAspectRatio: false,
        },
      });
    }

    function renderChainSplitChart(canvas, labels, data) {
      if (chainSplitChart) chainSplitChart.destroy();

      chainSplitChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                'rgba(246, 196, 83, 0.95)', // gold
                'rgba(94, 234, 212, 0.9)',  // teal accent
                'rgba(129, 140, 248, 0.9)', // indigo
                'rgba(148, 163, 184, 0.8)', // slate
              ],
              borderColor: '#050b16',
              borderWidth: 1,
            },
          ],
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#9fb0c4',
                font: { size: 11 },
                padding: 12,
              },
            },
            tooltip: {
              callbacks: {
                label(ctx) {
                  const label = ctx.label || '';
                  const value = ctx.parsed || 0;
                  return ` ${label}: ${value.toLocaleString()} USDC`;
                },
              },
            },
          },
          cutout: '62%',
          responsive: true,
          maintainAspectRatio: false,
        },
      });
    }

    // === AUTH ===
    async function handleAuthSubmit(e) {
      e.preventDefault();
    
      const form = e.target;
      const email = form.email.value.trim();
      const password = form.password.value;
    
      if (!email || !password) {
        setAuthMessage('Email and password are required.', 'error');
        return;
      }
    
      setAuthMessage('Working...');
    
      try {
        if (authMode === 'signup') {
          const { error } = await sb.auth.signUp({ email, password });
          if (error) throw error;
    
          setAuthMessage('Account created. Now sign in.', 'success');
          setAuthMode('signin');
          return;
        }
    
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
    
        console.log('SIGNIN RESULT:', { data, error });
    
        if (error) {
          setAuthMessage(error.message || 'Sign-in failed.', 'error');
          return;
        }
    
        setAuthMessage('');
        // onAuthStateChange will handle UI + loading, but call once to be instant:
        await onAuthChanged();
    
      } catch (err) {
        console.error('AUTH EXCEPTION:', err);
        setAuthMessage(err?.message || 'Auth error.', 'error');
      }
    }
    
    async function handleSignOut() {
      await sb.auth.signOut();
      await onAuthChanged();
    }
    
    async function onAuthChanged() {
      const { data, error } = await sb.auth.getSession();
      console.log('SESSION CHECK:', { session: data?.session, error });
    
      const session = data?.session;
    
      const authWrapper = document.getElementById('auth-wrapper');
      const appShell = document.querySelector('.app-shell');
      const signoutBtn = document.getElementById('signout-btn');
    
      if (session) {
        if (authWrapper) authWrapper.style.display = 'none';
        if (appShell) appShell.style.display = 'block';
        if (signoutBtn) signoutBtn.style.display = 'inline-block';
    
        // load everything AFTER auth is definitely live
        await loadContractors();
        await loadPayouts();
        await loadDashboard();
        await loadDashboardCharts();
    
      } else {
        if (authWrapper) authWrapper.style.display = 'flex';
        if (appShell) appShell.style.display = 'none';
        if (signoutBtn) signoutBtn.style.display = 'none';
      }
    }


        // --- Toast helper ---
    let toastTimeoutId = null;
    
    function showToast(message) {
      const el = document.getElementById('app-toast');
      if (!el) return;
    
      el.textContent = message;
      el.classList.add('show');
    
      if (toastTimeoutId) clearTimeout(toastTimeoutId);
      toastTimeoutId = setTimeout(() => {
        el.classList.remove('show');
      }, 1800);
    }
    
    // --- Copy TX hash from modal ---
    async function handleCopyTxHash() {
      const txEl = document.getElementById('payout-modal-txhash');
      if (!txEl) return;
    
      const hash = (txEl.textContent || '').trim();
      if (!hash) {
        showToast('No TX hash to copy');
        return;
      }
    
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(hash);
        } else {
          // fallback
          const tmp = document.createElement('textarea');
          tmp.value = hash;
          document.body.appendChild(tmp);
          tmp.select();
          document.execCommand('copy');
          document.body.removeChild(tmp);
        }
    
        showToast('TX hash copied');
      } catch (err) {
        console.error('Clipboard error', err);
        showToast('Could not copy TX hash');
      }
    }

    // ===== COPY HASH BUTTON =====
    const copyBtn = document.getElementById('payout-modal-copy');
    const hashEl = document.getElementById('payout-modal-txhash');
    const toast = document.getElementById('copy-toast');
    
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const text = hashEl.textContent.trim();
        if (!text || text === 'â€”') return;
    
        try {
          await navigator.clipboard.writeText(text);
          showCopyToast();
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    }
    
    function showCopyToast() {
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1500);
    }


      
    // === INIT ===
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      initPayoutRowClicks();

      console.log('DOM Loaded: wiring forms...');

      // --- PAYOUT FORM ---
      const payoutForm = document.getElementById('payout-form');
      if (payoutForm) {
        console.log('Found payout-form, wiring submit â†’ addPayout');
        payoutForm.addEventListener('submit', addPayout);
      } else {
        console.warn('âŒ payout-form NOT FOUND');
      }
      
      // Also wire button â†’ requestSubmit (safest + works in GH Pages)
      const savePayoutBtn = document.getElementById('save-payout-btn');
      if (savePayoutBtn && payoutForm) {
        console.log('Found save-payout-btn, wiring click â†’ requestSubmit()');
        savePayoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          payoutForm.requestSubmit();
        });
      } else {
        console.warn('âš ï¸ save-payout-btn or payout-form missing');
      }


      const rangeSelect = document.getElementById('dash-range');
      const chainSelect = document.getElementById('dash-chain');

      if (rangeSelect) {
        rangeSelect.addEventListener('change', () => {
          filterRange = rangeSelect.value;
          loadDashboard();
          loadPayouts();
          highlightDashboard();
        });
      }

      if (chainSelect) {
        chainSelect.addEventListener('change', () => {
          filterChain = chainSelect.value;
          loadDashboard();
          loadPayouts();
          highlightDashboard();
        });
      }

      const authForm = document.getElementById('auth-form');
      const toggle = document.getElementById('auth-toggle-mode');
      const signoutBtn = document.getElementById('signout-btn');

      if (authForm) authForm.addEventListener('submit', handleAuthSubmit);
      if (toggle) {
        toggle.addEventListener('click', () =>
          setAuthMode(authMode === 'signin' ? 'signup' : 'signin')
        );
      }
      if (signoutBtn) signoutBtn.addEventListener('click', handleSignOut);

      setAuthMode('signin');
      sb.auth.onAuthStateChange((_event, _session) => onAuthChanged());
      onAuthChanged();
      // === Onboarding banner logic ===
      const dismissBtn = document.getElementById('onboarding-dismiss');
      if (dismissBtn) {
          dismissBtn.addEventListener('click', () => {
              const banner = document.getElementById('onboarding-banner');
              if (banner) banner.classList.add('hidden');
              try {
                  localStorage.setItem('soltra-onboarding-dismissed', '1');
              } catch (e) {}
          });
      }

        // --- Payout detail panel wiring ---
      const payoutsBody = document.getElementById('payouts-body');
      if (payoutsBody) {
        payoutsBody.addEventListener('click', (e) => {
          const tr = e.target.closest('.payout-row');
          if (!tr) return;
          openPayoutDetailFromRow(tr);
        });
      }
    
      const pdClose = document.getElementById('pd-close');
      const pdBackdrop = document.getElementById('payout-detail-backdrop');
    
      if (pdClose) {
        pdClose.addEventListener('click', () => {
          closePayoutDetail();
        });
      }
    
      if (pdBackdrop) {
        pdBackdrop.addEventListener('click', () => {
          closePayoutDetail();
        });
      }

      
      const goContractorsBtn = document.getElementById('onboarding-go-contractors');
      if (goContractorsBtn) {
          goContractorsBtn.addEventListener('click', () => {
              const btn = document.querySelector('.tab-button[data-target="contractors"]');
              if (btn) btn.click();
          });
      }
      
      const goPayoutsBtn = document.getElementById('onboarding-go-payouts');
      if (goPayoutsBtn) {
          goPayoutsBtn.addEventListener('click', () => {
              const btn = document.querySelector('.tab-button[data-target="payouts"]');
              if (btn) btn.click();
          });
      }

      const reportsGoPayoutsBtn = document.getElementById('reports-go-payouts');
      if (reportsGoPayoutsBtn) {
        reportsGoPayoutsBtn.addEventListener('click', () => {
          const btn = document.querySelector('.tab-button[data-target="payouts"]');
          if (btn) btn.click();
        });
      }

      const exportBtn = document.getElementById('export-btn');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          exportPayoutsToCsv(); // or whatever your export function is called
        });
      }

      const deleteBtn = document.getElementById('payout-modal-delete');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', handleDeletePayout);
        }

      // ==== COPY HASH BUTTON ====
      const copyBtn = document.getElementById('payout-modal-copy');
      const hashEl  = document.getElementById('payout-modal-txhash');
      const toast   = document.getElementById('copy-toast'); // optional if you're using toast
      
      async function handleCopyTxHash() {
        const text = hashEl?.textContent?.trim();
        if (!text || text === 'â€”') return;
      
        try {
          await navigator.clipboard.writeText(text);
          showToast('TX hash copied!'); // if using toast system
        } catch (err) {
          console.error('Failed to copy:', err);
          showToast('Clipboard error');
        }
      }
      
      if (copyBtn) {
        copyBtn.addEventListener('click', handleCopyTxHash);
      }


      const modalCloseBtn = document.getElementById('payout-modal-close');
      const payoutModal = document.getElementById('payout-modal');

      
      if (modalCloseBtn) {
        modalCloseBtn.addEventListener('click', closePayoutModal);
      }
      
      if (payoutModal) {
        payoutModal.addEventListener('click', (e) => {
          if (e.target.classList.contains('payout-modal-backdrop')) {
            closePayoutModal();
          }
        });
      }
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePayoutModal();
      });

      
      }); // <-- this closes document.addEventListener('DOMContentLoaded', ...)
  </script>
      <div id="payout-detail-modal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card">
        <div class="modal-header">
          <h3>Payout details</h3>
          <button id="payout-modal-close" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-row"><span>Date</span><strong id="payout-modal-date"></strong></div>
          <div class="modal-row"><span>Contractor</span><strong id="payout-modal-contractor"></strong></div>
          <div class="modal-row"><span>Amount</span><strong id="payout-modal-amount"></strong></div>
          <div class="modal-row"><span>Chain</span><strong id="payout-modal-chain"></strong></div>
          <div class="modal-row">
            <span>Tx hash</span>
            <a id="payout-modal-txhash" href="#" target="_blank" rel="noopener noreferrer"></a>
          </div>
          <div class="modal-row">
            <span>Notes</span>
            <p id="payout-modal-note" class="modal-note"></p>
          </div>
        </div>
      </div>
    </div>
        <!-- Payout detail modal (single source of truth) -->
    <div id="payout-modal" class="payout-modal hidden">
      <div class="payout-modal-backdrop"></div>
    
      <div class="payout-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="payout-modal-title">
        <div class="payout-modal-header">
          <h3 id="payout-modal-title">Payout details</h3>
          <button id="payout-modal-close" class="payout-modal-close" aria-label="Close">
            &times;
          </button>
        </div>
    
        <div class="payout-modal-body">
          <!-- Main details -->
          <dl class="payout-modal-grid">
            <div>
              <dt>Contractor</dt>
              <dd id="payout-modal-contractor">â€”</dd>
            </div>
            <div>
              <dt>Amount</dt>
              <dd id="payout-modal-amount">â€”</dd>
            </div>
            <div>
              <dt>Date</dt>
              <dd id="payout-modal-date">â€”</dd>
            </div>
            <div>
              <dt>Chain</dt>
              <dd id="payout-modal-chain">â€”</dd>
            </div>
          </dl>
        
          <div class="payout-modal-body">
            <!-- Main details -->
            <dl class="payout-modal-grid">
              <div>
                <dt>Contractor</dt>
                <dd id="payout-modal-contractor">â€”</dd>
              </div>
              <div>
                <dt>Amount</dt>
                <dd id="payout-modal-amount">â€”</dd>
              </div>
              <div>
                <dt>Date</dt>
                <dd id="payout-modal-date">â€”</dd>
              </div>
              <div>
                <dt>Chain</dt>
                <dd id="payout-modal-chain">â€”</dd>
              </div>
            </dl>
          
            <!-- Tx hash with copy button -->
            <div class="payout-modal-field">
              <div class="modal-label-row">
                <span class="modal-label">TX hash</span>
                <button
                  type="button"
                  id="payout-modal-copy"
                  class="modal-copy-btn"
                >
                  Copy
                </button>
              </div>
              <code id="payout-modal-txhash" class="modal-code">â€”</code>
            </div>
          
            <!-- Notes -->
            <div class="payout-modal-field">
              <span class="modal-label">Notes</span>
              <p id="payout-modal-note" class="modal-note">â€”</p>
            </div>
          </div>
          
          <!-- âœ… Add this footer -->
          <div class="payout-modal-footer">
            <button
              type="button"
              id="payout-modal-delete"
              class="payout-modal-delete-btn"
            >
              Delete payout
            </button>
          </div>
      </div>

  <div id="toast" class="toast hidden">Copied!</div>
  <div id="copy-toast" class="copy-toast">Copied!</div>
</body>
</html>

