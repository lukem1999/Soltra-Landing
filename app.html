<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Soltra App ‚Äî Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Auth wrapper -->
  <div id="auth-wrapper">
    <div class="auth-card">
      <h2>Sign in to Soltra</h2>
      <p class="auth-subtitle">Use your email to manage your contractor payouts.</p>

      <form id="auth-form">
        <input type="email" name="email" placeholder="you@company.com" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit" class="btn auth-btn"><span>Sign in</span></button>
      </form>

      <button id="auth-toggle-mode" class="auth-toggle">
        New here? Create an account
      </button>

      <p id="auth-message" class="auth-message"></p>
      <button id="signout-btn" class="mini-btn" style="display:none;">Sign out</button>
    </div>
  </div>

  <!-- Simple app header (logo + back to site) -->
<header class="site-header">
  <a href="index.html" class="nav-logo">
    <img src="soltra-s.png" alt="Soltra logo" class="nav-logo-img" />
    <span class="nav-logo-text">Soltra</span>
  </a>

  <nav class="site-nav">
    <a href="index.html">Back to site</a>
  </nav>

  <div class="site-nav-cta"></div>
</header>


  <!-- APP SHELL -->
  <section class="app-shell">
    <div class="app-layout">
      <!-- Sidebar -->
      <aside class="app-sidebar">
        <div class="sidebar-logo">
          <div class="sidebar-mark">S</div>
          <span>Soltra</span>
        </div>

        <nav class="app-tabs">
          <button class="tab-button" data-target="dashboard">
            <span>Overview</span>
          </button>
        
          <button class="tab-button" data-target="contractors">
            <span>Contractors</span>
            <span class="tab-pill" id="sidebar-contractors-count"></span>
          </button>
        
          <button class="tab-button" data-target="payouts">
            <span>Payouts</span>
            <span class="tab-pill" id="sidebar-payouts-count"></span>
          </button>
        
          <button class="tab-button" data-target="reports">
            <span>Reports</span>
          </button>

          <button class="tab-button upgrade-cta" onclick="window.location.href='pricing.html'">
            ‚ö° Upgrade / Pricing
          </button>
        </nav>


        <div class="sidebar-foot">
          <span class="sidebar-label">Environment</span>
          <span class="sidebar-pill">Sandbox</span>
        </div>
      </aside>

            <!-- Main content -->
      <div class="app-main">
        <header class="app-header">
          <div>
            <h2>Soltra Dashboard</h2>
            <p>Track stablecoin payouts, contractors, and reporting in one place.</p>
          </div>
      
          <div class="app-header-controls">
            <!-- Date range selector (existing) -->
            <select class="app-select">
              <option>This month</option>
              <option>Last month</option>
              <option>Last 90 days</option>
            </select>
      
            <!-- Wallet selector -->
            <div class="wallet-selector" id="walletSelector">
              <button class="wallet-selector-toggle" type="button">
                <span class="wallet-selector-label">Wallet</span>
                <span class="wallet-selector-current" id="walletSelectorCurrent">All wallets</span>
                <span class="wallet-selector-chevron">‚ñæ</span>
              </button>
      
              <div class="wallet-selector-menu">
                <div class="wallet-selector-section">
                  <span class="wallet-selector-section-label">Wallets</span>
      
                  <button class="wallet-selector-item wallet-selector-item--active" data-wallet="all" type="button">
                    <span class="wallet-selector-item-name">All wallets</span>
                    <span class="wallet-selector-item-address">Combined overview</span>
                  </button>
      
                  <button class="wallet-selector-item" data-wallet="safe-treasury" type="button">
                    <span class="wallet-selector-item-name">Safe (Treasury)</span>
                    <span class="wallet-selector-item-address">0xa3f1‚Ä¶c72a3</span>
                  </button>
      
                  <button class="wallet-selector-item" data-wallet="ledger-ops" type="button">
                    <span class="wallet-selector-item-name">Ledger Ops Wallet</span>
                    <span class="wallet-selector-item-address">0x002b‚Ä¶ff19a</span>
                  </button>
      
                  <button class="wallet-selector-item" data-wallet="mm-grants" type="button">
                    <span class="wallet-selector-item-name">MetaMask Grants</span>
                    <span class="wallet-selector-item-address">0x9cb4‚Ä¶528e1</span>
                  </button>
                </div>
      
                <button class="wallet-selector-add" type="button">
                  <span class="wallet-selector-add-plus">+</span>
                  <span>Add new wallet</span>
                </button>
              </div>
            </div>
      
            <!-- User pill (existing) -->
            <div class="user-pill">
              <span class="user-avatar">L</span>
              <span class="user-name">You</span>
            </div>
          </div>
        </header>


        <div class="app-main-inner">
          <!-- DASHBOARD VIEW -->
          <div id="view-dashboard" class="app-view">
            <div class="shell dashboard-shell">
              <!-- Onboarding banner -->
              <div id="onboarding-banner" class="onboarding-banner hidden">
                <div class="onboarding-main">
                  <h3>Get started in two steps</h3>
                  <p class="onboarding-text">
                    Add a contractor, log your first payout, and we‚Äôll populate this dashboard
                    with real USDC activity.
                  </p>
          
                  <div class="onboarding-steps">
                    <div class="onboarding-step">
                      <div class="onboarding-step-number">1</div>
                      <div class="onboarding-step-body">
                        <div class="onboarding-step-title">Add a contractor</div>
                        <div class="onboarding-step-text">
                          Save a contributor with a wallet address so you can select them later.
                        </div>
                        <button
                          type="button"
                          class="mini-btn onboarding-cta"
                          id="onboarding-go-contractors"
                        >
                          Go to Contractors
                        </button>
                      </div>
                    </div>
          
                    <div class="onboarding-step">
                      <div class="onboarding-step-number">2</div>
                      <div class="onboarding-step-body">
                        <div class="onboarding-step-title">Log a payout</div>
                        <div class="onboarding-step-text">
                          Record an on-chain USDC transfer with chain, amount, and TX hash.
                        </div>
                        <button
                          type="button"
                          class="mini-btn onboarding-cta"
                          id="onboarding-go-payouts"
                        >
                          Go to Payouts
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
          
                <button
                  type="button"
                  class="onboarding-dismiss"
                  id="onboarding-dismiss"
                  aria-label="Dismiss"
                >
                  √ó
                </button>
              </div>
              
              <div class="dash-header">
                <div>
                  <h2 class="dash-title">Dashboard</h2>
                  <p class="dash-subtitle">
                    Overview of your USDC payouts and contractors across chains.
                  </p>
                </div>
              
                <div class="dash-filters-wrap">
                  <div class="dash-filters">
                    <div class="dash-filter-group">
                      <label for="dash-range">Range</label>
                      <select id="dash-range">
                        <option value="7d">Last 7 days</option>
                        <option value="30d" selected>Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="all">All time</option>
                      </select>
                    </div>
              
                    <div class="dash-filter-group">
                      <label for="dash-chain">Chain</label>
                      <select id="dash-chain">
                        <option value="all" selected>All chains</option>
                        <option value="BASE">Base</option>
                        <option value="POLYGON">Polygon</option>
                        <option value="ETHEREUM">Ethereum</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <section class="wallet-card">
                <div class="wallet-card-header wallet-card-header--row">
                  <div>
                    <h3 class="wallet-card-title">Treasury wallets</h3>
                    <p class="wallet-card-subtitle">Add treasury addresses to track balances and payouts (read-only).</p>
                  </div>
              
                  <button type="button" class="wallet-add-btn" id="wallet-add-open">
                    + Add wallet
                  </button>
                </div>
              
                <div class="wallet-list" id="wallet-list">
                  <div class="wallet-empty" id="wallet-empty">
                    No wallets yet. Add a treasury wallet to start tracking.
                  </div>
                </div>
              </section>



              <!-- KPI cards -->
              <div class="dash-kpi-row">
                <div class="dash-card">
                  <div class="dash-card-label">Total payouts</div>
                  <div id="dash-total-30d" class="dash-card-value">$0</div>
                  <div id="dash-payout-count" class="dash-card-sub">0 payouts</div>
                </div>

                <div class="dash-card">
                  <div class="dash-card-label">Active contractors</div>
                  <div id="dash-contractors" class="dash-card-value">0</div>
                  <div class="dash-card-sub">With payouts in this range</div>
                </div>

                <div class="dash-card">
                  <div class="dash-card-label">Chains used</div>
                  <div id="dash-chains" class="dash-card-value">0</div>
                  <div id="dash-chain-list" class="dash-card-sub">No activity yet.</div>
                </div>
              </div>

              <!-- Recent payouts table -->
              <div class="dash-card dash-table-card">
                <div class="dash-card-header">
                  <div>
                    <div class="dash-card-label">Recent payouts</div>
                    <div class="dash-card-sub">
                      Latest on-chain payouts matching your filters.
                    </div>
                  </div>
                </div>
              
                <div class="dash-table-wrapper">
                  <table class="dash-table payout-table">
                    <!-- ‚úÖ Forces identical column widths across Overview + Payouts + Reports -->
                    <colgroup>
                      <col class="col-date" />
                      <col class="col-contractor" />
                      <col class="col-amount" />
                      <col class="col-chain" />
                      <col class="col-tx" />
                    </colgroup>
              
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Contractor</th>
                        <th class="th-amount">Amount</th>
                        <th>Chain</th>
                        <th>Tx hash</th>
                      </tr>
                    </thead>
              
                    <tbody id="dash-payouts-table">
                      <tr>
                        <td colspan="5">Loading payouts‚Ä¶</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>


              <!-- Charts -->
              <section class="dash-charts">
                <div class="chart-card">
                  <div class="chart-card-header chart-card-header--split">
                    <div>
                      <h3>Monthly payout volume</h3>
                      <p>USDC paid out over the last few months.</p>
                    </div>
                
                    <!-- premium KPI headline for the chart -->
                    <div class="chart-kpi">
                      <div class="chart-kpi-label">Total paid</div>
                      <div id="payoutVolumeTotal" class="chart-kpi-value">$0</div>
                      <div class="chart-kpi-sub">Last 6 months</div>
                    </div>
                  </div>
                
                  <!-- important: keep chart height consistent -->
                  <div class="chart-canvas-wrap">
                    <canvas id="payoutVolumeChart"></canvas>
                  </div>
                </div>

                <div class="chart-card">
                  <div class="chart-card-header">
                    <h3>Chains used</h3>
                    <p>Share of payouts by chain.</p>
                  </div>
                
                  <div class="chart-canvas-wrap">
                    <canvas id="chainSplitChart"></canvas>
                  </div>
                </div>
              </section>

              <div class="card card-side">
                <h3 class="card-title">This month snapshot</h3>
                <ul class="summary-list">
                  <li>
                    <span>Total contractors paid</span>
                    <strong id="snapshot-contractors">0</strong>
                  </li>
                  <li>
                    <span>Average payout size</span>
                    <strong id="snapshot-avg">$0</strong>
                  </li>
                  <li>
                    <span>CSV exports</span>
                    <strong>0</strong>
                  </li>
                  <li>
                    <span>Failed payouts</span>
                    <strong>0</strong>
                  </li>
                </ul>
              </div>
            </div>
          </div>


          <!-- CONTRACTORS VIEW -->
          <div id="view-contractors" class="app-view hidden">
            <div class="shell dashboard-shell">
              <div class="section-header">
                <div>
                  <h2 class="section-title">Contractors</h2>
                  <p class="section-subtitle">
                    Add and manage wallets for contributors, freelancers, and core team.
                  </p>
                </div>
              </div>

              <div class="two-column-layout">
                <!-- LEFT: add contractor form -->
                <div class="form-card">
                  <h3 class="form-title">Add contractor</h3>
                  <p class="form-subtitle">
                    Store basic details and a payout address. You can edit or remove them later.
                  </p>

                  <form id="add-contractor-form" onsubmit="addContractor(event)" class="form-grid">
                    <div class="field">
                      <label class="field-label">Name<span>*</span></label>
                      <input
                        type="text"
                        name="name"
                        class="input-control"
                        placeholder="Jane Doe"
                        required
                      />
                    </div>

                    <div class="field">
                      <label class="field-label">Role</label>
                      <input
                        type="text"
                        name="role"
                        class="input-control"
                        placeholder="Solidity dev, Designer, Ops‚Ä¶"
                      />
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Wallet address<span>*</span></label>
                      <input
                        type="text"
                        name="wallet_address"
                        class="input-control mono"
                        placeholder="0x..."
                        required
                      />
                      <p class="field-help">
                        EVM-compatible address where payouts will be sent.
                      </p>
                    </div>

                    <div class="field">
                      <label class="field-label">Country</label>
                      <input
                        type="text"
                        name="country"
                        class="input-control"
                        placeholder="Estonia, US, Nigeria‚Ä¶"
                      />
                    </div>

                    <div class="field full-row">
                      <button type="submit" class="btn primary-btn">
                        Save contractor
                      </button>
                    </div>
                  </form>
                </div>

                <!-- RIGHT: contractors table -->
                <div class="table-card">
                  <div class="table-card-header">
                    <div>
                      <h3 class="form-title">Saved contractors</h3>
                      <p class="form-subtitle">
                        These wallets will show up when logging payouts.
                      </p>
                    </div>
                  </div>

                  <div class="dash-table-wrapper">
                    <table class="dash-table">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Wallet</th>
                          <th>Role</th>
                          <th>Country</th>
                          <th>Last paid</th>
                        </tr>
                      </thead>
                      <tbody id="contractors-body">
                        <tr>
                          <td colspan="5">No contractors yet.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- PAYOUTS VIEW -->
          <div id="view-payouts" class="app-view hidden">
            <div class="shell dashboard-shell">
              <div class="section-header">
                <div>
                  <h2 class="section-title">Payouts</h2>
                  <p class="section-subtitle">
                    Log USDC payouts you‚Äôve sent on-chain and keep a clean audit trail.
                  </p>
                </div>
              </div>

              <div class="two-column-layout">
                <!-- LEFT: add payout form -->
                <div class="form-card">
                  <h3 class="form-title">Log a payout</h3>
                  <p class="form-subtitle">
                    Record an on-chain transfer you‚Äôve already sent from your treasury
                    wallet or multisig.
                  </p>

                  <form id="payout-form" class="form-grid">
                    <div class="field">
                      <label class="field-label">Contractor<span>*</span></label>
                      <select
                        id="payout-contractor"
                        name="contractor_id"
                        class="input-control"
                        required
                      >
                        <option value="">Select contractor</option>
                      </select>
                    </div>

                    <div class="field">
                      <label class="field-label">Amount (USDC)<span>*</span></label>
                      <input
                        type="number"
                        name="amount"
                        class="input-control"
                        placeholder="1200"
                        step="0.01"
                        min="0"
                        required
                      />
                    </div>

                    <div class="field">
                      <label class="field-label">Chain<span>*</span></label>
                      <select name="chain" class="input-control" required>
                        <option value="">Select chain</option>
                        <option value="BASE">Base</option>
                        <option value="POLYGON">Polygon</option>
                        <option value="ETHEREUM">Ethereum</option>
                      </select>
                    </div>

                    <div class="field">
                      <label class="field-label">Date</label>
                      <input
                        type="date"
                        name="tx_date"
                        class="input-control"
                      />
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Tx hash<span>*</span></label>
                      <input
                        type="text"
                        name="tx_hash"
                        class="input-control mono"
                        placeholder="0x..."
                        required
                      />
                      <p class="field-help">
                        Paste the transaction hash from your block explorer.
                      </p>
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Notes</label>
                      <textarea
                        name="note"
                        class="input-control textarea-control"
                        rows="2"
                        placeholder="September retainer, milestone 2, bonus‚Ä¶"
                      ></textarea>
                    </div>

                    <div class="field full-row">
                      <button type="submit" id="save-payout-btn" class="btn primary-btn">
                        Save payout
                      </button>
                    </div>
                  </form>
                </div>

                <!-- RIGHT: payout logs table -->
                <div class="table-card">
                  <div class="table-card-header">
                    <div>
                      <h3 class="form-title">Payout log</h3>
                      <p class="form-subtitle">
                        Recent payouts based on your current filters (range &amp; chain).
                      </p>
                    </div>
                  </div>

                  <div class="dash-table-wrapper">
                    <table class="dash-table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Contractor</th>
                          <th>Amount</th>
                          <th>Chain</th>
                          <th>Tx hash</th>
                        </tr>
                      </thead>
                      <tbody id="payouts-body">
                        <tr>
                          <td colspan="5">No payouts yet.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>

                  <!-- ================= REPORTS VIEW ================= -->
          <div class="app-view hidden" id="view-reports">
            <div class="list-header">
              <div>
                <h3>Reports</h3>
                <p class="section-subtitle">
                  CSV-ready view of payouts matching your dashboard filters
                  (range &amp; chain).
                </p>
              </div>
              <button class="mini-btn" id="reports-export-btn">Export CSV</button>
            </div>
  
            <!-- Empty state -->
            <div class="reports-empty" id="reports-empty">
              <h4>No payouts yet</h4>
              <p>
                Once you log payouts, this view will summarize them for finance
                and operations.
              </p>
              <button type="button" class="mini-btn" id="reports-go-payouts">
                Log a payout
              </button>
            </div>
  
            <!-- Table uses same style as dashboard -->
            <div class="dash-table-wrapper hidden" id="reports-table-wrapper">
              <table class="dash-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Contractor</th>
                    <th>Amount</th>
                    <th>USD value</th>
                    <th>Tx hash</th>
                  </tr>
                </thead>
                <tbody id="reports-body">
                  <tr>
                    <td colspan="5">Loading‚Ä¶</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- Payout detail side panel -->
  <div id="payout-detail-root">
    <div id="payout-detail-backdrop" class="payout-detail-backdrop"></div>
  
    <aside id="payout-detail-panel" class="payout-detail-panel">
      <div class="pd-header">
        <div>
          <div class="pd-kicker">Payout details</div>
          <h2 class="pd-title" id="pd-contractor">‚Äî</h2>
        </div>
        <button id="pd-close" type="button" class="pd-close-btn" aria-label="Close">
          √ó
        </button>
      </div>
  
      <div class="pd-body">
        <div class="pd-row">
          <span class="pd-label">Date</span>
          <span class="pd-value" id="pd-date">‚Äî</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Amount</span>
          <span class="pd-value" id="pd-amount">‚Äî</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Chain</span>
          <span class="pd-value" id="pd-chain">‚Äî</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Tx hash</span>
          <span class="pd-value">
            <code id="pd-txhash">‚Äî</code>
          </span>
        </div>
        <div class="pd-row pd-row-notes">
          <span class="pd-label">Notes</span>
          <p class="pd-notes" id="pd-note">No notes for this payout.</p>
        </div>
      </div>
    </aside>
  </div>


  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Dashboard chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // === Supabase config (DEV ONLY) ===
    const SUPABASE_URL = 'https://lvuvkgnkhrzpwlssupyh.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dXZrZ25raHJ6cHdsc3N1cHloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDkyOTIsImV4cCI6MjA3ODkyNTI5Mn0.9C1-3Di7tXJCgb_7ZHj7mz6QL5fDMvnvmBziYqgGeDs';
    
    // ‚úÖ ONE client, memory-only auth (fixes GitHub Pages + tracking prevention)
    window.__soltra_sb__ =
      window.__soltra_sb__ ||
      window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: false,      // üî• THIS is the key fix
          autoRefreshToken: false,
          detectSessionInUrl: false,
        },
      });
    
    const sb = window.__soltra_sb__;



    // === GLOBAL STATE ===
    let contractorsCache = [];
    let authMode = 'signin';       // 'signin' | 'signup'
    let filterRange = '30d';       // '7d' | '30d' | '90d' | 'all'
    let filterChain = 'all';       // 'all' | 'BASE' | 'POLYGON' | 'ETHEREUM'
    let lastDashboardPayoutCount = 0;
    let dashboardPayoutsCache = [];
    let dashboardLoading = false;

    const CHAIN_COLORS = {
      ETHEREUM: '#627EEA', // Ethereum blue
      POLYGON:  '#8247E5', // Polygon purple
      BASE:     '#0052FF', // Base blue
      UNKNOWN:  '#6B7280'  // neutral gray
    };

    // === UTILITIES ===
    function formatUSD(amount) {
      if (!amount || isNaN(amount)) return '$0';
      return `$${amount.toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      })}`;
    }

    function showToast(message = 'Copied!') {
      const toast = document.getElementById('toast');
      if (!toast) return;
    
      toast.textContent = message;
      toast.classList.remove('hidden');
      toast.classList.add('toast-visible');
    
      // clear previous timer if any
      clearTimeout(showToast._timeout);
      showToast._timeout = setTimeout(() => {
        toast.classList.remove('toast-visible');
        toast.classList.add('hidden');
      }, 1800);
    }


    function setAuthMessage(text, type = '') {
      const el = document.getElementById('auth-message');
      if (!el) return;
      el.textContent = text || '';
      el.className = 'auth-message';
      if (type) el.classList.add(type);
    }

    function setAuthMode(mode) {
      authMode = mode;
      const toggle = document.getElementById('auth-toggle-mode');
      const btn = document.querySelector('#auth-form .auth-btn');
      if (!toggle || !btn) return;

      if (mode === 'signin') {
        btn.textContent = 'Sign in';
        toggle.textContent = 'New here? Create an account';
      } else {
        btn.textContent = 'Create account';
        toggle.textContent = 'Already have an account? Sign in';
      }
      setAuthMessage('');
    }

    function highlightDashboard() {
    // KPIs + table card
    const hardTargets = document.querySelectorAll('.dash-card');
    hardTargets.forEach((el) => {
      el.classList.remove('dash-pulse');          // reset if still on
      void el.offsetWidth;                        // force reflow
      el.classList.add('dash-pulse');
    });
  
    // Charts
    const softTargets = document.querySelectorAll('.chart-card');
    softTargets.forEach((el) => {
      el.classList.remove('dash-pulse-soft');
      void el.offsetWidth;
      el.classList.add('dash-pulse-soft');
    });
  }

  function bindExportButton() {
    const btn = document.getElementById('reports-export-btn'); // ‚úÖ matches your HTML
  
    if (!btn) {
      console.warn('‚ùå Export button not found (#reports-export-btn).');
      return;
    }
  
    // Avoid double-binding
    if (btn.dataset.bound === '1') return;
    btn.dataset.bound = '1';
  
    console.log('‚úÖ Export button bound.');
  
    btn.addEventListener('click', (e) => {
      e.preventDefault();
  
      console.log(
        'üì¶ Export clicked. payouts in cache:',
        (dashboardPayoutsCache || []).length
      );
  
      try {
        exportPayoutsToCsv(); // ‚úÖ your real export function name
        console.log('‚úÖ exportPayoutsToCsv() ran');
      } catch (err) {
        console.error('‚ùå exportPayoutsToCsv crashed:', err);
        alert('Export failed ‚Äî check console for error.');
      }
    });
  }


    // ===============================
  // Wallets (Option A: Saved addresses)
  // ===============================
  function normalizeEvmAddress(addr) {
    return (addr || '').trim();
  }
  
  function walletTypeLabel(t) {
    const map = {
      safe: 'Safe (Gnosis)',
      ledger: 'Ledger',
      metamask: 'MetaMask',
      coinbase: 'Coinbase Wallet',
      other: 'Wallet',
    };
    return map[t] || 'Wallet';
  }
  
  function shortenAddress(addr) {
    const a = (addr || '').trim();
    if (a.length <= 12) return a;
    return a.slice(0, 6) + '‚Ä¶' + a.slice(-4);
  }
  
  function walletIcon(type) {
    // Use emoji for now (super reliable). You can swap to SVGs later.
    const map = { safe: 'üü©', ledger: 'üîí', metamask: 'ü¶ä', coinbase: 'üü¶', other: 'üëõ' };
    return map[type] || 'üëõ';
  }
  
  async function loadWallets() {
    const list = document.getElementById('wallet-list');
    const empty = document.getElementById('wallet-empty');
    if (!list) return;
  
    // auth check
    const { data: sess } = await sb.auth.getSession();
    const user = sess?.session?.user;
    if (!user) return;
  
    const { data, error } = await sb
      .from('treasury_wallets')
      .select('id, label, wallet_type, address, is_verified, is_active, created_at')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
  
    if (error) {
      console.error('loadWallets error', error);
      return;
    }
  
    // Clear existing rendered rows (keep empty node)
    list.querySelectorAll('.wallet-row').forEach(el => el.remove());
  
    const wallets = data || [];
    if (empty) empty.style.display = wallets.length ? 'none' : 'block';
  
    wallets.forEach(w => {
      const row = document.createElement('div');
      row.className = 'wallet-row';
      row.dataset.id = w.id;
  
      const badge = walletIcon(w.wallet_type);
      const name = w.label || walletTypeLabel(w.wallet_type);
      const sub = `${walletTypeLabel(w.wallet_type)} ‚Ä¢ ${shortenAddress(w.address)}`;
      const status = w.is_verified ? 'Verified' : 'Read-only';
  
      row.innerHTML = `
        <div class="wallet-left">
          <div class="wallet-badge">${badge}</div>
          <div class="wallet-meta">
            <div class="wallet-name">${name}</div>
            <div class="wallet-sub">${sub}</div>
          </div>
        </div>
  
        <div class="wallet-actions">
          <span class="wallet-pill">${status}</span>
          <button class="wallet-delete" type="button" title="Remove">Remove</button>
        </div>
      `;
  
      // Remove handler
      row.querySelector('.wallet-delete')?.addEventListener('click', async () => {
        const ok = confirm('Remove this wallet address from Soltra?');
        if (!ok) return;
  
        const { error: delErr } = await sb
          .from('treasury_wallets')
          .delete()
          .eq('id', w.id);
  
        if (delErr) {
          console.error('delete wallet error', delErr);
          alert('Could not remove wallet: ' + delErr.message);
          return;
        }
        await loadWallets();
      });
  
      list.appendChild(row);
    });
  }
  
  function openWalletModal() {
    document.getElementById('wallet-modal')?.classList.remove('hidden');
  }
  
  function closeWalletModal() {
    document.getElementById('wallet-modal')?.classList.add('hidden');
    document.getElementById('wallet-form')?.reset();
  }
  
  async function handleAddWallet(e) {
    e.preventDefault();
  
    const { data: sess } = await sb.auth.getSession();
    const user = sess?.session?.user;
    if (!user) {
      alert('Please sign in first.');
      return;
    }
  
    const form = e.target;
    const fd = new FormData(form);
  
    const label = (fd.get('label') || '').toString().trim();
    const wallet_type = (fd.get('wallet_type') || 'other').toString().trim();
    const address = normalizeEvmAddress(fd.get('address'));
    const notes = (fd.get('notes') || '').toString().trim();
  
    if (!label || !address) {
      alert('Label and address are required.');
      return;
    }
  
    // Minimal EVM address validation
    if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
      alert('That does not look like a valid EVM address (0x + 40 hex chars).');
      return;
    }
  
    const payload = {
      user_id: user.id,
      label,
      wallet_type,
      chain_family: 'evm',
      address,
      notes: notes || null,
      is_active: true,
      is_verified: false,
    };
  
    const { error } = await sb.from('treasury_wallets').insert([payload]);
    if (error) {
      console.error('insert wallet error', error);
      alert('Could not save wallet: ' + error.message);
      return;
    }
  
    closeWalletModal();
    await loadWallets();
  }



   // === TAB NAVIGATION ===
  function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
  
    const views = {
      dashboard: document.getElementById('view-dashboard'),
      contractors: document.getElementById('view-contractors'),
      payouts: document.getElementById('view-payouts'),
      reports: document.getElementById('view-reports'),
    };
  
    if (!tabButtons.length) return;
  
    function showTab(target) {
      // 1) Sidebar active state
      tabButtons.forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.target === target);
      });
  
      // 2) View visibility
      Object.entries(views).forEach(([key, el]) => {
        if (!el) return;
        el.classList.toggle('hidden', key !== target);
      });
  
      // 3) Tab-specific side effects
      if (target === 'dashboard') {
        requestAnimationFrame(() => highlightDashboard());
      }
  
      if (target === 'payouts') {
        // load contractors into payout dropdown when opening payouts tab
        loadPayoutContractorOptions();
      }
  
      if (target === 'reports') {
        loadDashboard().then(() => {
          loadReportsFromCache();
          bindExportButton(); // üëà RIGHT HERE
        });
      }
  
      // 4) Persist tab (optional)
      try {
        localStorage.setItem('soltra-active-tab', target);
      } catch (e) {}
    }
  
    // Wire tab clicks
    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        if (!target) return;
        showTab(target);
      });
    });
  
    // Initial tab (restore or default)
    let initial = 'dashboard';
    try {
      initial = localStorage.getItem('soltra-active-tab') || 'dashboard';
    } catch (e) {}
    if (!views[initial]) initial = 'dashboard';
  
    showTab(initial);
  }

    function shortenWallet(addr) {
      if (!addr || typeof addr !== 'string') return '';
      if (addr.length <= 12) return addr;
      return addr.slice(0, 6) + '...' + addr.slice(-4);
    }

      // === LOAD CONTRACTORS ===
    async function loadContractors() {
      const tbody = document.getElementById('contractors-body');
      if (!tbody) return;
    
      tbody.innerHTML = '<tr><td colspan="4">Loading contractors...</td></tr>';
    
      try {
        const { data, error } = await sb
          .from('contractors')
          .select('id, name, role, wallet_address, country'); // üëà NO .order() HERE
    
        console.log('LOAD CONTRACTORS RESULT:', { data, error });
    
        if (error) {
          console.error('LOAD CONTRACTORS ERROR', error);
          tbody.innerHTML = `
            <tr>
              <td colspan="4">
                Error loading contractors (${error.message})
              </td>
            </tr>
          `;
          return;
        }
    
        if (!data || !data.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <div class="empty-state-title">No contractors yet</div>
                  <p class="empty-state-text">
                    Add your first contractor to start logging payouts.
                  </p>
                </div>
              </td>
            </tr>
          `;
          return;
        }
    
        tbody.innerHTML = '';
    
        data.forEach((c) => {
          const name = c.name || 'Unnamed';
          const role = c.role || '‚Äî';
          const wallet = c.wallet_address || '‚Äî';
          const country = c.country || '‚Äî';
    
          // Build the row
          tbody.insertAdjacentHTML(
            'beforeend',
            `
              <tr class="contractor-row"
                  tabindex="0"
                  role="button"
                  data-id="${c.id}"
                  data-name="${name}"
                  data-role="${role}"
                  data-wallet="${wallet}"
                  data-country="${country}">
                <td>${name}</td>
                <td>${wallet}</td>
                <td>${role}</td>
                <td>${country}</td>
              </tr>
            `
          );
    
          // Wire up modal open on click / keyboard
          const tr = tbody.lastElementChild;
    
          tr.addEventListener('click', () => openContractorModalFromRow(tr));
    
          tr.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openContractorModalFromRow(tr);
            }
          });
        });
      } catch (err) {
        console.error('UNEXPECTED LOAD CONTRACTORS ERROR', err);
        tbody.innerHTML = `
          <tr>
            <td colspan="4">Something went wrong loading contractors.</td>
          </tr>
        `;
      }
    }
    
    function populateContractorSelect() {
      const select = document.getElementById('payout-contractor');
      if (!select) return;

      select.innerHTML = '<option value="">Select contractor</option>';

      contractorsCache.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name || c.wallet_address;
        select.appendChild(opt);
      });
    }

    function updateOnboardingBanner(contractorCount, payoutCount) {
      const banner = document.getElementById('onboarding-banner');
      if (!banner) return;
    
      let dismissed = false;
      try {
        dismissed = localStorage.getItem('soltra-onboarding-dismissed') === '1';
      } catch (e) {
        // ignore
      }
    
      if (dismissed) {
        banner.classList.add('hidden');
        return;
      }
    
      // Show as long as you are missing either contractors or payouts
      if (!contractorCount || !payoutCount) {
        banner.classList.remove('hidden');
      } else {
        banner.classList.add('hidden');
      }
    }

        // === CONTRACTOR MODAL ===
    const contractorModal       = document.getElementById('contractor-modal');
    const contractorModalForm   = document.getElementById('contractor-modal-form');
    const contractorModalClose  = document.getElementById('contractor-modal-close');
    const contractorModalDelete = document.getElementById('contractor-modal-delete');
    
    const contractorModalId      = document.getElementById('contractor-modal-id');
    const contractorModalName    = document.getElementById('contractor-modal-name');
    const contractorModalRole    = document.getElementById('contractor-modal-role');
    const contractorModalWallet  = document.getElementById('contractor-modal-wallet');
    const contractorModalCountry = document.getElementById('contractor-modal-country');
    
    function openContractorModalFromRow(row) {
      if (!contractorModal) return;
    
      contractorModalId.value      = row.dataset.id || '';
      contractorModalName.value    = row.dataset.name || '';
      contractorModalRole.value    = row.dataset.role || '';
      contractorModalWallet.value  = row.dataset.wallet || '';
      contractorModalCountry.value = row.dataset.country || '';
    
      contractorModal.classList.remove('hidden');
    }
    
    function closeContractorModal() {
      if (!contractorModal) return;
    
      contractorModal.classList.add('hidden');
      if (contractorModalForm) {
        contractorModalForm.reset();
        contractorModalId.value = '';
      }
    }

    
    function exportPayoutsToCsv() {
      const payouts = dashboardPayoutsCache || [];
    
      if (!payouts.length) {
        alert('No payouts to export for this range.');
        return;
      }
    
      // Helper
      const safe = (v) => (v == null ? '' : String(v));
    
      // Add a couple derived fields that make CSV ‚Äúfinance usable‚Äù
      const rows = payouts.map((p) => {
        const ts = p.tx_timestamp ? new Date(p.tx_timestamp) : null;
        const iso = ts && !isNaN(ts.getTime()) ? ts.toISOString() : '';
        const dateLocal = ts && !isNaN(ts.getTime()) ? ts.toLocaleDateString() : '';
        const month = ts && !isNaN(ts.getTime())
          ? `${ts.getFullYear()}-${String(ts.getMonth() + 1).padStart(2, '0')}`
          : '';
    
        const contractorName = p.contractors?.name || '';
        const chain = (p.chain || '').toUpperCase();
        const asset = p.asset_symbol || 'USDC';
        const amount = Number(p.amount || 0);
    
        const txHash = p.tx_hash || '';
        const explorerUrl = txHash ? getExplorerUrl(chain, txHash) : '';
    
        return {
          month,                         // YYYY-MM
          date: dateLocal,               // local date
          timestamp_iso: iso,            // ISO timestamp
          contractor: contractorName,    // contractor name
          amount: amount,                // numeric
          asset: asset,                  // USDC
          usd_value: amount,             // assumption 1 USDC = $1
          chain: chain,                  // ETHEREUM / BASE / POLYGON
          tx_hash: txHash,
          explorer_url: explorerUrl,
          note: p.note || '',
        };
      });
    
      const headers = Object.keys(rows[0]);
    
      // Convert to CSV with proper escaping
      const lines = [];
      lines.push(headers.join(','));
    
      for (const r of rows) {
        const line = headers.map((h) => {
          const v = safe(r[h]);
    
          // escape commas/quotes/newlines
          if (/[",\n]/.test(v)) return `"${v.replace(/"/g, '""')}"`;
          return v;
        }).join(',');
    
        lines.push(line);
      }
    
      const csvContent = lines.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
    
      // Filename includes active filters
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const d = String(today.getDate()).padStart(2, '0');
    
      const rangeTag = filterRange || 'range';
      const chainTag = filterChain || 'all';
    
      const filename = `soltra-reports-${y}-${m}-${d}-${rangeTag}-${chainTag}.csv`;
    
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    
      URL.revokeObjectURL(url);
    }



    function loadReportsFromCache() {
      const tbody = document.getElementById('reports-body');
      const empty = document.getElementById('reports-empty');
      const wrapper = document.getElementById('reports-table-wrapper');
    
      if (!tbody || !empty || !wrapper) return;
    
      // No payouts for current filters
      if (!dashboardPayoutsCache || !dashboardPayoutsCache.length) {
        empty.classList.remove('hidden');
        wrapper.classList.add('hidden');
        tbody.innerHTML =
          '<tr><td colspan="5">No payouts for this range.</td></tr>';
        return;
      }
    
      // We have data
      empty.classList.add('hidden');
      wrapper.classList.remove('hidden');
    
      tbody.innerHTML = '';
      dashboardPayoutsCache.forEach((p) => {
        const date = p.tx_timestamp
          ? new Date(p.tx_timestamp).toLocaleDateString()
          : '‚Äî';
        const name = p.contractors?.name || 'Unknown';
        const amount = `${p.amount} ${p.asset_symbol || 'USDC'}`;
    
        // For now assume 1 USDC = $1; you can later plug in FX if you want
        const usdValue = `$${Number(p.amount || 0).toLocaleString('en-US', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        })}`;
    
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date}</td>
          <td>${name}</td>
          <td>${amount}</td>
          <td>${usdValue}</td>
          <td>${p.tx_hash}</td>
        `;
        tbody.appendChild(tr);
      });
    }

        // === ADD CONTRACTOR (FIXED to match your HTML input names) ===
    async function addContractor(event) {
      event.preventDefault();
    
      const form = event.target;
      const formData = new FormData(form);
    
      // ‚úÖ MATCH HTML NAMES
      const name    = (formData.get('name') || '').toString().trim();
      const role    = (formData.get('role') || '').toString().trim();
      const wallet  = (formData.get('wallet_address') || '').toString().trim();
      const country = (formData.get('country') || '').toString().trim();
    
      // Basic validation
      if (!name || !wallet) {
        alert('Name and wallet address are required.');
        return;
      }
    
      try {
        // Must be signed in (RLS)
        const { data: userData, error: userErr } = await sb.auth.getUser();
        if (userErr || !userData?.user) {
          console.error('AUTH ERROR', userErr);
          alert('You must be signed in to add contractors.');
          return;
        }
    
        const userId = userData.user.id;
    
        const { error } = await sb
          .from('contractors')
          .insert([{
            name,
            role: role || null,
            wallet_address: wallet,
            country: country || null,
            user_id: userId,
          }]);
    
        if (error) {
          console.error('ADD CONTRACTOR ERROR', error);
          alert(`Error saving contractor: ${error.message}`);
          return;
        }
    
        form.reset();
    
        // Refresh lists
        await loadContractors();
        if (typeof loadContractorOptions === 'function') {
          await loadContractorOptions();
        }
    
      } catch (err) {
        console.error('UNEXPECTED ADD CONTRACTOR ERROR', err);
        alert('Something went wrong adding the contractor.');
      }
    }

    function renderChainPill(chain) {
      if (!chain) return '';
    
      const c = chain.toLowerCase();
      let img = '';
      let label = '';
    
      if (c.includes('base')) {
        img = 'images/base-square.svg';
        label = 'Base';
      } else if (c.includes('eth')) {
        img = 'images/ethereum.svg';
        label = 'Ethereum';
      } else if (c.includes('poly') || c.includes('matic')) {
        img = 'images/polygon.svg';
        label = 'Polygon';
      } else {
        img = 'images/generic-chain.svg'; // optional fallback
        label = chain;
      }
    
      return `
        <span class="chain-cell">
          <img src="${img}" alt="${label} logo" />
          <span class="chain-name">${label}</span>
        </span>
      `;
    }


    function getExplorerUrl(chain, txHash) {
      if (!txHash) return '#';
      const c = (chain || '').toUpperCase();
    
      if (c.includes('BASE')) {
        return `https://basescan.org/tx/${txHash}`;
      }
      if (c.includes('POLYGON') || c.includes('MATIC')) {
        return `https://polygonscan.com/tx/${txHash}`;
      }
      if (c.includes('ETH')) {
        return `https://etherscan.io/tx/${txHash}`;
      }
      // Fallback ‚Äì you can change this later if you support more chains
      return `https://etherscan.io/tx/${txHash}`;
    }
    
    function shortenHash(txHash) {
      if (!txHash || txHash.length <= 12) return txHash || '';
      return txHash.slice(0, 6) + '...' + txHash.slice(-4);
    }


    function openPayoutDetailFromRow(tr) {
      const root = document.getElementById('payout-detail-root');
      if (!root || !tr) return;
    
      const date = tr.dataset.date || '‚Äî';
      const contractor = tr.dataset.contractor || 'Unknown';
      const amount = tr.dataset.amount || '‚Äî';
      const chain = tr.dataset.chain || '‚Äî';
      const txhash = tr.dataset.txhash || '‚Äî';
      const note = tr.dataset.note || 'No notes for this payout.';
    
      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };
    
      // NOTE: Your HTML has id="pd-contractor" (not "pd-contractor" in your screenshot?)
      setText('pd-date', date);
      setText('pd-contractor', contractor);
      setText('pd-amount', amount);
      setText('pd-chain', chain);
      setText('pd-txhash', txhash);
      setText('pd-note', note);
    
      root.classList.add('payout-detail-open');
    }

    
    function closePayoutDetail() {
      const root = document.getElementById('payout-detail-root');
      if (!root) return;
      root.classList.remove('payout-detail-open');
    }

    
    function wirePayoutDetailPanel() {
      const closeBtn = document.getElementById('pd-close');
      const backdrop = document.getElementById('payout-detail-backdrop');
    
      if (closeBtn) closeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closePayoutDetail();
      });
    
      if (backdrop) backdrop.addEventListener('click', (e) => {
        e.preventDefault();
        closePayoutDetail();
      });
    
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePayoutDetail();
      });
    }

    function fillPayoutModalFromRow(tr) {
      if (!tr) return;
      document.getElementById('payout-modal-date').textContent = tr.dataset.date || '';
      document.getElementById('payout-modal-contractor').textContent = tr.dataset.contractor || '';
      document.getElementById('payout-modal-amount').textContent = tr.dataset.amount || '';
      document.getElementById('payout-modal-chain').textContent = tr.dataset.chain || '';
      document.getElementById('payout-modal-txhash').textContent = tr.dataset.txhash || '';
      document.getElementById('payout-modal-note').textContent = tr.dataset.note || '';
    }
    
    let activePayoutRow = null;

    function wirePayoutRowClicks() {
      const bindTable = (tbodyId) => {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
    
        // ‚úÖ Prevent double binding on same tbody
        if (tbody.dataset.bound_payout_rows === '1') return;
        tbody.dataset.bound_payout_rows = '1';
    
        const openFromEvent = (e) => {
          // Don‚Äôt hijack clicks on real interactive elements
          const interactive = e.target.closest('a, button, input, textarea, select, label');
          if (interactive) return;
    
          const tr = e.target.closest('tr');
          if (!tr) return;
          if (!tbody.contains(tr)) return;
    
          // Don‚Äôt open for empty/loading rows (they won‚Äôt have an id)
          if (!tr.dataset || !tr.dataset.id) return;
    
          // ‚úÖ Use your side panel opener (not the old modal)
          openPayoutDetailFromRow(tr);
        };
    
        tbody.addEventListener('click', (e) => {
          openFromEvent(e);
        });
    
        tbody.addEventListener('keydown', (e) => {
          // Only when the focused element is a row (or inside it)
          const tr = e.target.closest('tr');
          if (!tr || !tbody.contains(tr)) return;
          if (!tr.dataset || !tr.dataset.id) return;
    
          // Enter or Space opens (Space is ' ' OR 'Spacebar' in some older browsers)
          const isEnter = e.key === 'Enter';
          const isSpace = e.key === ' ' || e.key === 'Spacebar';
    
          if (!isEnter && !isSpace) return;
    
          // If focus is on a link/button/input inside the row, let it behave normally
          const interactive = e.target.closest('a, button, input, textarea, select, label');
          if (interactive) return;
    
          e.preventDefault();
          openPayoutDetailFromRow(tr);
        });
      };
    
      bindTable('payouts-body');
      bindTable('dash-payouts-table');
    }


    async function handleDeletePayout() {
      const modal = document.getElementById('payout-modal');
      if (!modal) return;
    
      const payoutId = modal.dataset.payoutId;
      if (!payoutId) {
        alert('Missing payout id.');
        return;
      }
    
      const confirmDelete = window.confirm(
        'Delete this payout from Soltra? This will not move any on-chain funds.'
      );
      if (!confirmDelete) return;
    
      try {
        const { error } = await sb
          .from('payout')      // üëà singular table name
          .delete()
          .eq('id', payoutId);
    
        if (error) {
          console.error('Error deleting payout:', error);
          alert(`Error deleting payout: ${error.message}`);
          return;
        }
    
        // Close modal
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        modal.dataset.payoutId = '';
    
        // Refresh UI
        await loadPayouts();
        await loadDashboard();
        highlightDashboard();
      } catch (err) {
        console.error(err);
        alert('Network error while deleting payout.');
      }
    }

    
    function closePayoutModal() {
      const modal = document.getElementById('payout-modal');
      if (!modal) return;
    
      modal.classList.remove('payout-modal--open');
    
      // After transition, hide it
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 190);
    }

    function handlePayoutModalKeyDown(e) {
      const modal = document.getElementById('payout-modal');
      if (!modal || !modal.classList.contains('open')) return;
    
      // ESC closes
      if (e.key === 'Escape') {
        e.preventDefault();
        closePayoutModal();
        return;
      }
    
      // Up/down (and optional vim-style j/k)
      if (e.key === 'ArrowDown' || e.key === 'j') {
        e.preventDefault();
        const rows = getPayoutRows();
        if (!rows.length) return;
    
        const newIndex = Math.min(currentPayoutRowIndex + 1, rows.length - 1);
        const newRow = setActivePayoutRow(newIndex);
        fillPayoutModalFromRow(newRow);
      }
    
      if (e.key === 'ArrowUp' || e.key === 'k') {
        e.preventDefault();
        const rows = getPayoutRows();
        if (!rows.length) return;
    
        const newIndex = Math.max(currentPayoutRowIndex - 1, 0);
        const newRow = setActivePayoutRow(newIndex);
        fillPayoutModalFromRow(newRow);
      }
    }
    
    function attachPayoutModalKeyListeners() {
      document.addEventListener('keydown', handlePayoutModalKeyDown);
    }
    
    function detachPayoutModalKeyListeners() {
      document.removeEventListener('keydown', handlePayoutModalKeyDown);
    }


        // === PAYOUTS ===
    async function loadPayouts(highlightId = null) {
      const tbody = document.getElementById('payouts-body');
      if (!tbody) return;
    
      tbody.innerHTML = '<tr><td colspan="5">Loading payouts...</td></tr>';
    
      // date filter
      let sinceISO = null;
      if (filterRange !== 'all') {
        const since = new Date();
        if (filterRange === '7d') since.setDate(since.getDate() - 7);
        else if (filterRange === '30d') since.setDate(since.getDate() - 30);
        else if (filterRange === '90d') since.setDate(since.getDate() - 90);
        sinceISO = since.toISOString();
      }
    
      let query = sb
        .from('payout') // singular table name
        .select(`
          id,
          amount,
          asset_symbol,
          chain,
          tx_hash,
          tx_timestamp,
          note,
          contractors ( name )
        `)
        .order('tx_timestamp', { ascending: false })
        .limit(50);
    
      if (sinceISO) query = query.gte('tx_timestamp', sinceISO);
      if (filterChain !== 'all') query = query.eq('chain', filterChain);
    
      const { data, error } = await query;
    
      console.log('LOAD PAYOUTS RESULT:', { data, error });
    
      if (error) {
        tbody.innerHTML = `
          <tr><td colspan="5">
            Error loading payouts (${error.message})
          </td></tr>
        `;
        return;
      }
    
      if (!data || !data.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-state-title">No payouts yet</div>
                <p class="empty-state-text">
                  Log a payout to see it appear here.
                </p>
              </div>
            </td>
          </tr>
        `;
        return;
      }
    
      tbody.innerHTML = '';
    
      data.forEach((p) => {
        const date = p.tx_timestamp
          ? new Date(p.tx_timestamp).toLocaleDateString()
          : '‚Äî';
    
        const contractor = p.contractors?.name || 'Unknown';
        const amountText = `${p.amount} ${p.asset_symbol || 'USDC'}`;
        const chainUpper = (p.chain || '').toUpperCase();
        const explorerUrl = getExplorerUrl(p.chain, p.tx_hash);
        const shortHash = shortenHash(p.tx_hash);
    
        tbody.insertAdjacentHTML(
          'beforeend',
          `
          <tr class="payout-row"
              data-payout-id="${p.id}">
            <td>${date}</td>
            <td>${contractor}</td>
            <td>${amountText}</td>
            <td>${renderChainPill(p.chain)}</td>
            <td>
              ${
                p.tx_hash
                  ? `<a href="${explorerUrl}"
                         target="_blank"
                         rel="noopener"
                         class="tx-link"
                         title="${p.tx_hash}">
                       ${shortHash}
                     </a>`
                  : '‚Äî'
              }
            </td>
          </tr>
          `
        );
    
        const tr = tbody.lastElementChild;
    
        // Accessibility (kept)
        tr.tabIndex = 0;
        tr.setAttribute('role', 'button');
    
        // Keep your datasets if you want (used by side panel / modal)
        tr.dataset.date = date;
        tr.dataset.contractor = contractor;
        tr.dataset.amount = amountText;
        tr.dataset.chain = chainUpper;
        tr.dataset.txhash = p.tx_hash || '';
        tr.dataset.note = p.note || '';
        tr.dataset.id = p.id;
    
        // Highlight newly-added payout (kept)
        if (highlightId && p.id === highlightId) {
          tr.classList.add('payout-row--new');
        }
      });
    }

    function wirePayoutRowClicks() {
      const tbody = document.getElementById('payouts-body');
      if (!tbody) return;
    
      // CLICK opens detail (ignore clicks on the tx link so it still opens explorer)
      tbody.addEventListener('click', (e) => {
        if (e.target.closest('a')) return; // let tx hash links work
    
        const tr = e.target.closest('tr.payout-row');
        if (!tr) return;
    
        // Choose ONE:
        // openPayoutModalFromRow(tr);
        openPayoutDetailFromRow(tr);
      });
    
      // KEYBOARD opens detail
      tbody.addEventListener('keydown', (e) => {
        const tr = e.target.closest('tr.payout-row');
        if (!tr) return;
    
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          // Choose ONE:
          // openPayoutModalFromRow(tr);
          openPayoutDetailFromRow(tr);
        }
      });
    }


        // === PAYOUTS ===
       // === PAYOUTS: add a new payout ===
    async function addPayout(event) {
      event.preventDefault();
    
      const form = event.target;
      const formData = new FormData(form);
    
      const contractor_id = formData.get('contractor_id');
      const amountStr     = formData.get('amount');
      const chain         = formData.get('chain');
      const tx_hash       = formData.get('tx_hash')?.trim();
      const tx_date       = formData.get('tx_date');
      const note          = formData.get('note')?.trim();
    
      // Basic validation
      if (!contractor_id || !amountStr || !chain || !tx_hash) {
        alert('Contractor, amount, chain, and TX hash are required.');
        return;
      }
    
      const amount = Number(amountStr);
      if (!amount || amount <= 0) {
        alert('Amount must be a positive number.');
        return;
      }
    
      // Use chosen date or "now" as tx_timestamp
      const tx_timestamp = tx_date
        ? new Date(tx_date).toISOString()
        : new Date().toISOString();
    
      try {
        // Make sure we have a logged-in user (RLS will depend on this)
        const { data: userData, error: userErr } = await sb.auth.getUser();
        const user = userData?.user;
    
        if (userErr || !user) {
          console.error('Not signed in / cannot fetch user:', userErr);
          alert('You must be signed in to log payouts.');
          return;
        }
    
        // Insert payout and return the new id
        const { data: inserted, error } = await sb
          .from('payout')   // üëà singular table name
          .insert([
            {
              contractor_id,
              amount,
              asset_symbol: 'USDC',
              chain,
              tx_hash,
              tx_timestamp,
              note,
            }
          ])
          .select('id')
          .single();
    
        if (error) {
          console.error('Error inserting payout:', error);
          alert(`Error saving payout: ${error.message}`);
          return;
        }
    
        const newId = inserted?.id;
    
        // Reset form + refresh UI with highlight
        form.reset();
    
        await loadPayouts(newId);     // highlights row in Payouts tab
        await loadDashboard(newId);   // highlights row in Dashboard table
        highlightDashboard();         // pulse KPIs / charts
    
      } catch (err) {
        console.error('Network / unexpected error saving payout:', err);
        alert('Network error saving payout.');
      }
    }

    async function loadPayoutContractorOptions() {
      const selectEl = document.getElementById('payout-contractor');
      if (!selectEl) return;
    
      selectEl.innerHTML = `<option value="">Loading contractors‚Ä¶</option>`;
      selectEl.disabled = true;
    
      try {
        // ‚úÖ Memory-only friendly: getSession() won't throw "Auth session missing"
        const { data: sessionData, error: sessErr } = await sb.auth.getSession();
        if (sessErr) throw sessErr;
    
        const session = sessionData?.session;
        const user = session?.user;
    
        if (!user) {
          selectEl.innerHTML = `<option value="">Sign in to select contractor</option>`;
          selectEl.disabled = true;
          return;
        }
    
        // If you *do* have user_id column, keep the .eq('user_id', user.id)
        // If you don't, remove that line.
        const { data, error } = await sb
          .from('contractors')
          .select('id, name, wallet_address')
          .eq('user_id', user.id)
          .order('name', { ascending: true });
    
        if (error) throw error;
    
        if (!data || data.length === 0) {
          selectEl.innerHTML = `<option value="">No contractors yet</option>`;
          selectEl.disabled = true;
          return;
        }
    
        selectEl.innerHTML = `<option value="">Select contractor</option>`;
        data.forEach((c) => {
          const w = c.wallet_address || '';
          const short = w ? `${w.slice(0, 6)}‚Ä¶${w.slice(-4)}` : '';
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = short ? `${c.name} ‚Ä¢ ${short}` : (c.name || 'Unnamed');
          selectEl.appendChild(opt);
        });
    
        selectEl.disabled = false;
      } catch (err) {
        console.error('loadPayoutContractorOptions() failed:', err);
        selectEl.innerHTML = `<option value="">Error loading contractors</option>`;
        selectEl.disabled = true;
      }
    }
    
  function openPayoutModal(data) {
    const modal = document.getElementById('payout-detail-modal');
    if (!modal) return;
  
    document.getElementById('payout-modal-date').textContent = data.date || '‚Äî';
    document.getElementById('payout-modal-contractor').textContent = data.contractor || 'Unknown';
    document.getElementById('payout-modal-amount').textContent = data.amount || '‚Äî';
    document.getElementById('payout-modal-chain').textContent = data.chain || '‚Äî';
  
    const txEl = document.getElementById('payout-modal-txhash');
    txEl.textContent = data.txHash || '‚Äî';
    txEl.href = data.txHash ? `https://etherscan.io/tx/${data.txHash}` : '#';
  
    document.getElementById('payout-modal-note').textContent = data.note || '';
  
    modal.classList.remove('hidden');
  }
  
  function closePayoutModal() {
    const modal = document.getElementById('payout-detail-modal');
    if (modal) modal.classList.add('hidden');
  }
  
  function initPayoutRowClicks() {
    const tbody = document.getElementById('payouts-body');
    if (!tbody) return;
  
    tbody.addEventListener('click', (e) => {
      const tr = e.target.closest('tr');
      if (!tr || !tr.dataset.contractor) return;
      openPayoutModal(tr.dataset);
    });
  
    const modal = document.getElementById('payout-detail-modal');
    const closeBtn = document.getElementById('payout-modal-close');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-backdrop')) {
          closePayoutModal();
        }
      });
    }
    if (closeBtn) {
      closeBtn.addEventListener('click', closePayoutModal);
    }
  }
    

    let currentPayoutRowIndex = -1;
    
    function getPayoutRows() {
      return Array.from(document.querySelectorAll('#payouts-body .payout-row'));
    }
    
    function setActivePayoutRow(index) {
      const rows = getPayoutRows();
      if (!rows.length) {
        currentPayoutRowIndex = -1;
        return;
      }
    
      // Clamp index
      if (index < 0) index = 0;
      if (index >= rows.length) index = rows.length - 1;
    
      currentPayoutRowIndex = index;
    
      rows.forEach(r => r.classList.remove('payout-row--active'));
      const row = rows[currentPayoutRowIndex];
      if (row) {
        row.classList.add('payout-row--active');
        row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    
      return row;
    }

        // === DASHBOARD ===
    async function loadDashboard(highlightId = null) {
      const totalEl       = document.getElementById('dash-total-30d');
      const payoutCountEl = document.getElementById('dash-payout-count');
      const contractorsEl = document.getElementById('dash-contractors');
      const chainsEl      = document.getElementById('dash-chains');
      const chainListEl   = document.getElementById('dash-chain-list');
      const tableBody     = document.getElementById('dash-payouts-table');

      if (dashboardLoading) return;
      dashboardLoading = true;

    
      if (!totalEl || !tableBody) return;
    
      // -----------------------------
      // Build date filter
      // -----------------------------
      let sinceISO = null;
      if (filterRange !== 'all') {
        const since = new Date();
        if (filterRange === '7d')  since.setDate(since.getDate() - 7);
        if (filterRange === '30d') since.setDate(since.getDate() - 30);
        if (filterRange === '90d') since.setDate(since.getDate() - 90);
        sinceISO = since.toISOString();
      }
    
      // -----------------------------
      // Query payouts
      // -----------------------------
      let query = sb
        .from('payout')
        .select(`
          id,
          amount,
          asset_symbol,
          chain,
          tx_hash,
          tx_timestamp,
          note,
          contractor_id,
          contractors ( name )
        `)
        .order('tx_timestamp', { ascending: false })
        .limit(500);
    
      if (sinceISO) query = query.gte('tx_timestamp', sinceISO);
      if (filterChain !== 'all') query = query.eq('chain', filterChain);
    
      try {
        const { data, error } = await query;
        if (error) throw error;
    
        const payouts = data || [];
    
        // -----------------------------
        // Cache (used by reports + charts)
        // -----------------------------
        dashboardPayoutsCache = payouts;
    
        // -----------------------------
        // KPIs
        // -----------------------------
        const totalAmount = payouts.reduce(
          (sum, p) => sum + (Number(p.amount) || 0),
          0
        );
    
        const payoutCount = payouts.length;
        const contractorIds = new Set(
          payouts.map(p => p.contractor_id).filter(Boolean)
        );
        const chains = new Set(
          payouts.map(p => (p.chain || '').toUpperCase()).filter(Boolean)
        );
    
        totalEl.textContent = formatUSD(totalAmount);
        payoutCountEl.textContent =
          payoutCount === 1 ? '1 payout' : `${payoutCount} payouts`;
    
        if (contractorsEl) contractorsEl.textContent = contractorIds.size;
        if (chainsEl) chainsEl.textContent = chains.size;
        if (chainListEl) {
          chainListEl.textContent = chains.size
            ? Array.from(chains).join(' ¬∑ ')
            : '‚Äî';
        dashboardLoading = false;
        }
    
        // Sidebar badge
        const sidebarCount = document.getElementById('sidebar-payouts-count');
        if (sidebarCount) {
          sidebarCount.textContent = payoutCount ? String(payoutCount) : '';
        }
    
        // -----------------------------
        // Snapshot (this month)
        // -----------------------------
        const now = new Date();
        const month = now.getMonth();
        const year  = now.getFullYear();
    
        const monthPayouts = payouts.filter(p => {
          if (!p.tx_timestamp) return false;
          const d = new Date(p.tx_timestamp);
          return d.getMonth() === month && d.getFullYear() === year;
        });
    
        const monthTotal = monthPayouts.reduce(
          (sum, p) => sum + (Number(p.amount) || 0),
          0
        );
    
        const snapshotContractors = new Set(
          monthPayouts.map(p => p.contractor_id).filter(Boolean)
        );
    
        const snapshotContractorsEl = document.getElementById('snapshot-contractors');
        const snapshotAvgEl         = document.getElementById('snapshot-avg');
    
        if (snapshotContractorsEl) {
          snapshotContractorsEl.textContent = snapshotContractors.size || 0;
        }
    
        if (snapshotAvgEl) {
          const avg = monthPayouts.length
            ? monthTotal / monthPayouts.length
            : 0;
          snapshotAvgEl.textContent = formatUSD(avg);
        }
    
        // -----------------------------
        // Recent payouts table
        // -----------------------------
        tableBody.innerHTML = '';
    
        if (!payouts.length) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <div class="empty-state-title">No payouts in this range</div>
                  <p class="empty-state-text">
                    Adjust filters or log a new payout.
                  </p>
                </div>
              </td>
            </tr>
          `;
        } else {
          payouts.slice(0, 10).forEach(p => {
            const date = p.tx_timestamp
              ? new Date(p.tx_timestamp).toLocaleDateString()
              : '‚Äî';
          
            const contractor = p.contractors?.name || 'Unknown';
            const amountText = `${p.amount} ${p.asset_symbol || 'USDC'}`;
            const chain = (p.chain || '').toUpperCase();
            const explorerUrl = getExplorerUrl(p.chain, p.tx_hash);
            const shortHash = shortenHash(p.tx_hash);
          
            const tr = document.createElement('tr');
            tr.className = 'payout-row';
          
            if (highlightId && p.id === highlightId) {
              tr.classList.add('payout-row--new');
            }
          
            tr.innerHTML = `
              <td>${date}</td>
              <td>${contractor}</td>
              <td>${amountText}</td>
              <td>${renderChainPill(p.chain)}</td>
              <td>
                ${
                  p.tx_hash
                    ? `<a href="${explorerUrl}" target="_blank" rel="noopener" class="tx-link">${shortHash}</a>`
                    : '‚Äî'
                }
              </td>
            `;
          
            tr.tabIndex = 0;
            tr.setAttribute('role', 'button');
          
            tr.dataset.date = date;
            tr.dataset.contractor = contractor;
            tr.dataset.amount = amountText;
            tr.dataset.chain = chain;
            tr.dataset.txhash = p.tx_hash || '';
            tr.dataset.note = p.note || '';
            tr.dataset.id = p.id;
          
            // ‚úÖ NO addEventListener here ‚Äî delegation handles it
            tableBody.appendChild(tr);
          });

        }
    
        // -----------------------------
        // ‚úÖ STEP 4 ‚Äî CHARTS (LAST)
        // -----------------------------
        buildMonthlyPayoutChart(payouts);
        renderDashboardChartsFromCache(); // chain split, etc.
        loadReportsFromCache();
    
      } catch (err) {
        console.error('Dashboard load failed:', err);
        totalEl.textContent = '$0';
        payoutCountEl.textContent = 'Error';
        tableBody.innerHTML =
          '<tr><td colspan="5">Error loading dashboard.</td></tr>';
        dashboardLoading = false;
      }
    }


    function formatUSDCompact(value) {
      if (value >= 1_000_000) return `$${(value / 1_000_000).toFixed(1)}M`;
      if (value >= 1_000) return `$${(value / 1_000).toFixed(0)}k`;
      return `$${value.toLocaleString()}`;
    }

    function buildMonthlyPayoutSeries(payouts) {
      const byMonth = {};
    
      (payouts || []).forEach((p) => {
        const ts = p.tx_timestamp ? new Date(p.tx_timestamp) : null;
        if (!ts || isNaN(ts.getTime())) return;
    
        const key = `${ts.getFullYear()}-${String(ts.getMonth() + 1).padStart(2, '0')}`;
        byMonth[key] = (byMonth[key] || 0) + (Number(p.amount) || 0);
      });
    
      // Always show last 6 months (even if zero)
      const end = new Date();
      end.setDate(1);
    
      const months = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date(end);
        d.setMonth(d.getMonth() - i);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        months.push(key);
      }
    
      return {
        labels: months.map((m) => new Date(m + '-01').toLocaleString('en-US', { month: 'short' })),
        values: months.map((m) => byMonth[m] || 0),
      };
    }


    function buildMonthlyPayoutChart() {
      const canvas = document.getElementById('payoutVolumeChart');
      if (!canvas) return;
    
      const ctx = canvas.getContext('2d');
    
      const { labels, values } = buildMonthlyPayoutSeries(dashboardPayoutsCache);
    
      const total = values.reduce((a, b) => a + b, 0);
      const totalEl = document.getElementById('payoutVolumeTotal');
      if (totalEl) totalEl.textContent = formatUSD(total);
    
      if (window.payoutVolumeChart && typeof window.payoutVolumeChart.destroy === 'function') {
        window.payoutVolumeChart.destroy();
      }
    
      window.payoutVolumeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: '#f6c453',
            borderRadius: 6,
            barThickness: 22,
            maxBarThickness: 26
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${formatUSDCompact(ctx.raw)} USDC`
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(255,255,255,0.65)' }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: (v) => formatUSDCompact(v),
                color: 'rgba(255,255,255,0.65)'
              },
              grid: { color: 'rgba(255,255,255,0.06)' }
            }
          }
        }
      });
    }


    function buildChainSplitChart(payouts) {
      const canvas = document.getElementById('chainSplitChart');
      if (!canvas) return;
    
      const counts = {};
      (payouts || []).forEach((p) => {
        const chain = (p.chain || 'UNKNOWN').toUpperCase();
        counts[chain] = (counts[chain] || 0) + 1;
      });
    
      const labels = Object.keys(counts);
    
      // Optional: order it nicely (so legend is consistent)
      const ORDER = ['ETHEREUM', 'POLYGON', 'BASE', 'UNKNOWN'];
      labels.sort((a, b) => (ORDER.indexOf(a) === -1 ? 999 : ORDER.indexOf(a)) - (ORDER.indexOf(b) === -1 ? 999 : ORDER.indexOf(b)));
    
      const values = labels.map((k) => counts[k]);
      const colors = labels.map((k) => CHAIN_COLORS[k] || CHAIN_COLORS.UNKNOWN);
    
      if (window.chainSplitChart?.destroy) window.chainSplitChart.destroy();
    
      window.chainSplitChart = new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'top',
              labels: { boxWidth: 14 }
            }
          }
        }
      });
    }



    // === AUTH ===
    async function handleAuthSubmit(e) {
      e.preventDefault();
    
      const form = e.target;
      const email = form.email.value.trim();
      const password = form.password.value;
    
      if (!email || !password) {
        setAuthMessage('Email and password are required.', 'error');
        return;
      }
    
      setAuthMessage('Working...');
    
      try {
        if (authMode === 'signup') {
          const { error } = await sb.auth.signUp({ email, password });
          if (error) throw error;
    
          setAuthMessage('Account created. Now sign in.', 'success');
          setAuthMode('signin');
          return;
        }
    
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
    
        console.log('SIGNIN RESULT:', { data, error });
    
        if (error) {
          setAuthMessage(error.message || 'Sign-in failed.', 'error');
          return;
        }
    
        setAuthMessage('');
        // onAuthStateChange will handle UI + loading, but call once to be instant:
        await onAuthChanged();
    
      } catch (err) {
        console.error('AUTH EXCEPTION:', err);
        setAuthMessage(err?.message || 'Auth error.', 'error');
      }
    }
    
    async function handleSignOut() {
      await sb.auth.signOut();
      await onAuthChanged();
    }

    function renderDashboardChartsFromCache() {
      // build the monthly chart from whatever is in the cache
      if (typeof buildMonthlyPayoutChart === 'function') {
        buildMonthlyPayoutChart(dashboardPayoutsCache || []);
      }
    
      // build chain split chart if you have it wired
      if (typeof buildChainSplitChart === 'function') {
        buildChainSplitChart(dashboardPayoutsCache || []);
      }
    }

    
    async function onAuthChanged() {
      const { data, error } = await sb.auth.getSession();
      console.log('SESSION CHECK:', { session: data?.session, error });
    
      const session = data?.session;
    
      const authWrapper = document.getElementById('auth-wrapper');
      const appShell = document.querySelector('.app-shell');
      const signoutBtn = document.getElementById('signout-btn');
    
      if (session) {
        if (authWrapper) authWrapper.style.display = 'none';
        if (appShell) appShell.style.display = 'block';
        if (signoutBtn) signoutBtn.style.display = 'inline-block';
    
        // load everything AFTER auth is definitely live
        await loadContractors();
        await loadPayoutContractorOptions();
        await loadPayouts();
        await loadDashboard();
        await loadWallets();
    
      } else {
        if (authWrapper) authWrapper.style.display = 'flex';
        if (appShell) appShell.style.display = 'none';
        if (signoutBtn) signoutBtn.style.display = 'none';
      }
    }


        // --- Toast helper ---
    let toastTimeoutId = null;
    
    function showToast(message) {
      const el = document.getElementById('app-toast');
      if (!el) return;
    
      el.textContent = message;
      el.classList.add('show');
    
      if (toastTimeoutId) clearTimeout(toastTimeoutId);
      toastTimeoutId = setTimeout(() => {
        el.classList.remove('show');
      }, 1800);
    }
    
    // --- Copy TX hash from modal ---
    async function handleCopyTxHash() {
      const txEl = document.getElementById('payout-modal-txhash');
      if (!txEl) return;
    
      const hash = (txEl.textContent || '').trim();
      if (!hash) {
        showToast('No TX hash to copy');
        return;
      }
    
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(hash);
        } else {
          // fallback
          const tmp = document.createElement('textarea');
          tmp.value = hash;
          document.body.appendChild(tmp);
          tmp.select();
          document.execCommand('copy');
          document.body.removeChild(tmp);
        }
    
        showToast('TX hash copied');
      } catch (err) {
        console.error('Clipboard error', err);
        showToast('Could not copy TX hash');
      }
    }

    // ===== COPY HASH BUTTON =====
    const copyBtn = document.getElementById('payout-modal-copy');
    const hashEl = document.getElementById('payout-modal-txhash');
    const toast = document.getElementById('copy-toast');
    
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const text = hashEl.textContent.trim();
        if (!text || text === '‚Äî') return;
    
        try {
          await navigator.clipboard.writeText(text);
          showCopyToast();
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    }
    
    function showCopyToast() {
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1500);
    }

    function initWalletSelector() {
      const selector = document.querySelector('.wallet-selector');
      if (!selector) return;
    
      const current = selector.querySelector('.wallet-selector-current');
    
      // Toggle open/close + click outside closes
      document.addEventListener('click', (event) => {
        const clickedInside = selector.contains(event.target);
        const clickedToggle = event.target.closest('.wallet-selector-toggle');
    
        if (clickedInside && clickedToggle) {
          selector.classList.toggle('is-open');
          return;
        }
    
        if (!clickedInside) {
          selector.classList.remove('is-open');
        }
      });
    
      // Pick an item
      selector.addEventListener('click', (e) => {
        const item = e.target.closest('.wallet-selector-item');
        if (!item) return;
    
        // Active UI
        selector.querySelectorAll('.wallet-selector-item').forEach(btn =>
          btn.classList.remove('wallet-selector-item--active')
        );
        item.classList.add('wallet-selector-item--active');
    
        // Update label
        const name = item.querySelector('.wallet-selector-item-name')?.textContent?.trim();
        if (current && name) current.textContent = name;
    
        // Close menu
        selector.classList.remove('is-open');
    
        // TODO: set your wallet filter state here
        // selectedWallet = item.dataset.wallet;  // e.g. global var
        // loadDashboard(); loadPayouts(); highlightDashboard();
      });
    }

        // ‚úÖ ONE AND ONLY DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ DOMContentLoaded: Soltra init starting...');
    
      // ======================================================
      // 0) Small helper to prevent double-binding
      // ======================================================
      const bindOnce = (el, key, fn) => {
        if (!el) return;
      
        // If it's not an element with dataset (e.g., document), store flags on body
        const host = el.dataset ? el : document.body;
        if (!host || !host.dataset) return;
      
        const k = `bound_${key}`;
        if (host.dataset[k] === '1') return;
        host.dataset[k] = '1';
      
        fn();
      };

      // Wallet modal wiring
      const openBtn = document.getElementById('wallet-add-open');
      const modal = document.getElementById('wallet-modal');
      const closeBtn = document.getElementById('wallet-modal-close');
      const cancelBtn = document.getElementById('wallet-cancel');
      const backdrop = document.getElementById('wallet-modal-backdrop');
      const form = document.getElementById('wallet-form');
      
      openBtn?.addEventListener('click', openWalletModal);
      closeBtn?.addEventListener('click', closeWalletModal);
      cancelBtn?.addEventListener('click', closeWalletModal);
      backdrop?.addEventListener('click', closeWalletModal);
      form?.addEventListener('submit', handleAddWallet);


    
      // ======================================================
      // 1) Core UI init
      // ======================================================
      if (typeof initTabs === 'function') initTabs();
      if (typeof initWalletSelector === 'function') initWalletSelector();
      if (typeof bindExportButton === 'function') bindExportButton();

      // ‚úÖ Add these (bind once)
      if (typeof wirePayoutRowClicks === 'function') wirePayoutRowClicks();
      if (typeof wirePayoutDetailPanel === 'function') wirePayoutDetailPanel();

      bindOnce(document.body, 'wire_payout_rows', () => wirePayoutRowClicks());
      bindOnce(document.body, 'wire_payout_detail_panel', () => wirePayoutDetailPanel());

      bindOnce(document.body, 'wire_payout_detail', () => {
      const closeBtn = document.getElementById('pd-close');
      const backdrop = document.getElementById('payout-detail-backdrop');
    
      closeBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        closePayoutDetail();
      });
    
      backdrop?.addEventListener('click', (e) => {
        e.preventDefault();
        closePayoutDetail();
      });
    
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePayoutDetail();
      });
    });

      // If you still have a "wallet selector open/close" click handler elsewhere,
      // REMOVE it. initWalletSelector() should own that.
      // (Leaving this out avoids duplicate click listeners.)
    
      // ======================================================
      // 2) Forms: payouts + contractors
      // ======================================================
      // --- PAYOUT FORM ---
      const payoutForm = document.getElementById('payout-form');
      bindOnce(payoutForm, 'payout_form_submit', () => {
        payoutForm.addEventListener('submit', addPayout);
      });
    
      const savePayoutBtn = document.getElementById('save-payout-btn');
      bindOnce(savePayoutBtn, 'save_payout_btn', () => {
        if (!payoutForm) return;
        savePayoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          payoutForm.requestSubmit();
        });
      });
    
      // --- CONTRACTOR ADD FORM ---
      // Your HTML currently uses onsubmit="addContractor(event)" which works,
      // but we also wire it here (safe) so you can remove inline HTML later.
      const contractorAddForm = document.getElementById('add-contractor-form');
      bindOnce(contractorAddForm, 'add_contractor_form', () => {
        contractorAddForm.addEventListener('submit', addContractor);
      });
    
      // ======================================================
      // 3) Dashboard filters (range + chain)
      // ======================================================
      const rangeSelect = document.getElementById('dash-range');
      bindOnce(rangeSelect, 'dash_range', () => {
        rangeSelect.addEventListener('change', () => {
          filterRange = rangeSelect.value;
          loadDashboard();
          loadPayouts();
          if (typeof highlightDashboard === 'function') highlightDashboard();
        });
      });
    
      const chainSelect = document.getElementById('dash-chain');
      bindOnce(chainSelect, 'dash_chain', () => {
        chainSelect.addEventListener('change', () => {
          filterChain = chainSelect.value;
          loadDashboard();
          loadPayouts();
          if (typeof highlightDashboard === 'function') highlightDashboard();
        });
      });
    
      // ======================================================
      // 4) Auth wiring
      // ======================================================
      const authForm = document.getElementById('auth-form');
      bindOnce(authForm, 'auth_form', () => {
        authForm.addEventListener('submit', handleAuthSubmit);
      });
    
      const toggle = document.getElementById('auth-toggle-mode');
      bindOnce(toggle, 'auth_toggle', () => {
        toggle.addEventListener('click', () => {
          setAuthMode(authMode === 'signin' ? 'signup' : 'signin');
        });
      });
    
      const signoutBtn = document.getElementById('signout-btn');
      bindOnce(signoutBtn, 'signout', () => {
        signoutBtn.addEventListener('click', handleSignOut);
      });
    
      // Keep a single auth state subscription
      bindOnce(document.body, 'auth_state_change', () => {
        setAuthMode('signin');
        sb.auth.onAuthStateChange((_event, _session) => onAuthChanged());
        onAuthChanged();
      });
    
      // ======================================================
      // 5) Onboarding buttons
      // ======================================================
      const dismissBtn = document.getElementById('onboarding-dismiss');
      bindOnce(dismissBtn, 'onboarding_dismiss', () => {
        dismissBtn.addEventListener('click', () => {
          const banner = document.getElementById('onboarding-banner');
          if (banner) banner.classList.add('hidden');
          try {
            localStorage.setItem('soltra-onboarding-dismissed', '1');
          } catch (e) {}
        });
      });
    
      const goContractorsBtn = document.getElementById('onboarding-go-contractors');
      bindOnce(goContractorsBtn, 'go_contractors', () => {
        goContractorsBtn.addEventListener('click', () => {
          const btn = document.querySelector('.tab-button[data-target="contractors"]');
          btn?.click();
        });
      });
    
      const goPayoutsBtn = document.getElementById('onboarding-go-payouts');
      bindOnce(goPayoutsBtn, 'go_payouts', () => {
        goPayoutsBtn.addEventListener('click', () => {
          const btn = document.querySelector('.tab-button[data-target="payouts"]');
          btn?.click();
        });
      });
    
      const reportsGoPayoutsBtn = document.getElementById('reports-go-payouts');
      bindOnce(reportsGoPayoutsBtn, 'reports_go_payouts', () => {
        reportsGoPayoutsBtn.addEventListener('click', () => {
          const btn = document.querySelector('.tab-button[data-target="payouts"]');
          btn?.click();
        });
      });
    
      // ======================================================
      // 6) Export CSV button
      // ======================================================
      // You have TWO possible ids floating around:
      // - reports-export-btn (your bindExportButton uses this)
      // - export-btn (older wiring)
      //
      // We support either, but avoid double-binding.
      const exportBtnA = document.getElementById('reports-export-btn');
      bindOnce(exportBtnA, 'export_reports', () => {
        exportBtnA.addEventListener('click', (e) => {
          e.preventDefault();
          exportPayoutsToCsv();
        });
      });
    
      const exportBtnB = document.getElementById('export-btn');
      bindOnce(exportBtnB, 'export_legacy', () => {
        exportBtnB.addEventListener('click', (e) => {
          e.preventDefault();
          exportPayoutsToCsv();
        });
      });
    
      // ======================================================
      // 7) Payout modal: close, copy, save note, delete
      // ======================================================
      const payoutModal = document.getElementById('payout-modal');
      const payoutModalCloseBtn = document.getElementById('payout-modal-close');
      const payoutModalForm = document.getElementById('payout-modal-form');
      const payoutDeleteBtn = document.getElementById('payout-modal-delete');
      const payoutNoteInput = document.getElementById('payout-modal-note');
      const payoutIdInput = document.getElementById('payout-modal-id');
    
      const closePayoutModalSafe = () => {
        if (!payoutModal) return;
    
        // support both styles you used:
        payoutModal.classList.remove('is-open');
        payoutModal.classList.remove('payout-modal--open');
        payoutModal.classList.add('hidden');
      };
    
      bindOnce(payoutModalCloseBtn, 'payout_modal_close', () => {
        payoutModalCloseBtn.addEventListener('click', (e) => {
          e.preventDefault();
          closePayoutModalSafe();
        });
      });
    
      bindOnce(payoutModal, 'payout_modal_backdrop', () => {
        payoutModal.addEventListener('click', (e) => {
          // Your HTML structure includes: <div class="payout-modal-backdrop"></div>
          // Clicking that backdrop should close.
          if (e.target.classList.contains('payout-modal-backdrop')) {
            closePayoutModalSafe();
          }
        });
      });
    
      bindOnce(document, 'payout_modal_esc', () => {
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && payoutModal && !payoutModal.classList.contains('hidden')) {
            closePayoutModalSafe();
          }
        });
      });
    
      // Save note changes
      bindOnce(payoutModalForm, 'payout_modal_save', () => {
        payoutModalForm.addEventListener('submit', async (e) => {
          e.preventDefault();
    
          const id = payoutIdInput?.value;
          if (!id) {
            alert('Missing payout id ‚Äì cannot update.');
            return;
          }
    
          const note = payoutNoteInput?.value?.trim() || null;
    
          try {
            const { error } = await sb.from('payout').update({ note }).eq('id', id);
            if (error) {
              console.error('UPDATE PAYOUT ERROR', error);
              alert('Error saving payout: ' + error.message);
              return;
            }
    
            closePayoutModalSafe();
            if (typeof loadPayouts === 'function') await loadPayouts();
            if (typeof loadDashboard === 'function') await loadDashboard();
          } catch (err) {
            console.error('UNEXPECTED UPDATE PAYOUT ERROR', err);
            alert('Something went wrong saving this payout.');
          }
        });
      });
    
      // Delete payout
      bindOnce(payoutDeleteBtn, 'payout_modal_delete', () => {
        payoutDeleteBtn.addEventListener('click', handleDeletePayout);
      });
    
      // Copy TX hash
      const copyBtn = document.getElementById('payout-modal-copy');
      const hashEl = document.getElementById('payout-modal-txhash');
      bindOnce(copyBtn, 'payout_modal_copy', () => {
        copyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          const text = hashEl?.textContent?.trim();
          if (!text || text === '‚Äî') return;
    
          try {
            await navigator.clipboard.writeText(text);
            if (typeof showToast === 'function') showToast('TX hash copied!');
          } catch (err) {
            console.error('Failed to copy:', err);
            if (typeof showToast === 'function') showToast('Clipboard error');
          }
        });
      });
    
      // ======================================================
      // 8) Contractor modal wiring (close, esc, save, delete)
      // ======================================================
      const contractorModal = document.getElementById('contractor-modal');
      const contractorModalClose = document.getElementById('contractor-modal-close');
      const contractorModalForm = document.getElementById('contractor-modal-form');
      const contractorModalDelete = document.getElementById('contractor-modal-delete');
    
      const contractorModalId = document.getElementById('contractor-modal-id');
      const contractorModalName = document.getElementById('contractor-modal-name');
      const contractorModalRole = document.getElementById('contractor-modal-role');
      const contractorModalWallet = document.getElementById('contractor-modal-wallet');
      const contractorModalCountry = document.getElementById('contractor-modal-country');
    
      const closeContractorModalSafe = () => {
        if (!contractorModal) return;
        contractorModal.classList.add('hidden');
        contractorModalForm?.reset();
        if (contractorModalId) contractorModalId.value = '';
      };
    
      bindOnce(contractorModalClose, 'contractor_modal_close', () => {
        contractorModalClose.addEventListener('click', (e) => {
          e.preventDefault();
          closeContractorModalSafe();
        });
      });
    
      bindOnce(contractorModal, 'contractor_modal_backdrop', () => {
        contractorModal.addEventListener('click', (e) => {
          // Close on clicking the backdrop layer inside the modal
          if (e.target.classList.contains('payout-modal-backdrop')) {
            closeContractorModalSafe();
          }
        });
      });
    
      bindOnce(document, 'contractor_modal_esc', () => {
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && contractorModal && !contractorModal.classList.contains('hidden')) {
            closeContractorModalSafe();
          }
        });
      });
    
      // Save contractor changes
      bindOnce(contractorModalForm, 'contractor_modal_save', () => {
        contractorModalForm.addEventListener('submit', async (e) => {
          e.preventDefault();
    
          const id = contractorModalId?.value;
          if (!id) {
            alert('Missing contractor id ‚Äì cannot update.');
            return;
          }
    
          const payload = {
            name: contractorModalName?.value?.trim() || '',
            role: contractorModalRole?.value?.trim() || null,
            wallet_address: contractorModalWallet?.value?.trim() || null,
            country: contractorModalCountry?.value?.trim() || null,
          };
    
          try {
            const { error } = await sb.from('contractors').update(payload).eq('id', id);
            if (error) {
              console.error('UPDATE CONTRACTOR ERROR', error);
              alert('Error saving contractor changes: ' + error.message);
              return;
            }
    
            closeContractorModalSafe();
            if (typeof loadContractors === 'function') await loadContractors();
            if (typeof loadPayoutContractorOptions === 'function') await loadPayoutContractorOptions();
          } catch (err) {
            console.error('UNEXPECTED UPDATE CONTRACTOR ERROR', err);
            alert('Something went wrong saving this contractor.');
          }
        });
      });
    
      // Delete contractor
      bindOnce(contractorModalDelete, 'contractor_modal_delete', () => {
        contractorModalDelete.addEventListener('click', async (e) => {
          e.preventDefault();
    
          const id = contractorModalId?.value;
          if (!id) {
            alert('Missing contractor id ‚Äì cannot delete.');
            return;
          }
    
          const ok = confirm('Delete this contractor? This cannot be undone.');
          if (!ok) return;
    
          try {
            const { error } = await sb.from('contractors').delete().eq('id', id);
            if (error) {
              console.error('DELETE CONTRACTOR ERROR', error);
              alert('Error deleting contractor: ' + error.message);
              return;
            }
    
            closeContractorModalSafe();
            if (typeof loadContractors === 'function') await loadContractors();
            if (typeof loadPayoutContractorOptions === 'function') await loadPayoutContractorOptions();
          } catch (err) {
            console.error('UNEXPECTED DELETE CONTRACTOR ERROR', err);
            alert('Something went wrong deleting this contractor.');
          }
        });
      });
    
      console.log('‚úÖ DOMContentLoaded: Soltra init complete.');
    });


      
    

  </script>
      <div id="payout-detail-modal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card">
        <div class="modal-header">
          <h3>Payout details</h3>
          <button id="payout-modal-close" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-row"><span>Date</span><strong id="payout-modal-date"></strong></div>
          <div class="modal-row"><span>Contractor</span><strong id="payout-modal-contractor"></strong></div>
          <div class="modal-row"><span>Amount</span><strong id="payout-modal-amount"></strong></div>
          <div class="modal-row"><span>Chain</span><strong id="payout-modal-chain"></strong></div>
          <div class="modal-row">
            <span>Tx hash</span>
            <a id="payout-modal-txhash" href="#" target="_blank" rel="noopener noreferrer"></a>
          </div>
          <div class="modal-row">
            <span>Notes</span>
            <p id="payout-modal-note" class="modal-note"></p>
          </div>
        </div>
      </div>
    </div>
        <!-- Payout detail modal -->
    <div id="payout-modal" class="payout-modal hidden">
      <div class="payout-modal-backdrop"></div>
    
      <div class="payout-modal-dialog">
        <div class="payout-modal-header">
          <h3>Payout details</h3>
          <button
            id="payout-modal-close"
            class="payout-modal-close"
            aria-label="Close"
          >
            &times;
          </button>
        </div>
    
        <!-- turn body into a form so we can save the note -->
        <form id="payout-modal-form" class="payout-modal-body">
          <!-- hidden id so we know which payout to update/delete -->
          <input type="hidden" id="payout-modal-id" />
    
          <!-- Main details -->
          <dl class="payout-modal-grid">
            <div>
              <dt>Contractor</dt>
              <dd id="payout-modal-contractor">‚Äî</dd>
            </div>
            <div>
              <dt>Amount</dt>
              <dd id="payout-modal-amount">‚Äî</dd>
            </div>
            <div>
              <dt>Date</dt>
              <dd id="payout-modal-date">‚Äî</dd>
            </div>
            <div>
              <dt>Chain</dt>
              <dd id="payout-modal-chain">‚Äî</dd>
            </div>
          </dl>
    
          <!-- Tx hash with copy button (unchanged functionally) -->
          <div class="payout-modal-field">
            <div class="modal-label-row">
              <span class="modal-label">TX hash</span>
              <button
                type="button"
                id="payout-modal-copy"
                class="modal-copy-btn"
              >
                Copy
              </button>
            </div>
            <code id="payout-modal-txhash" class="modal-code">‚Äî</code>
          </div>
    
          <!-- Editable Notes -->
          <div class="payout-modal-field">
            <span class="modal-label">Notes</span>
            <textarea
              id="payout-modal-note"
              class="modal-note-input"
              rows="3"
              placeholder="Add an internal note about this payout‚Ä¶"
            ></textarea>
          </div>
    
          <!-- Footer buttons -->
          <div class="payout-modal-footer">
            <button
              type="button"
              id="payout-modal-delete"
              class="modal-btn secondary danger"
            >
              Delete payout
            </button>
    
            <button type="submit" class="modal-btn primary">
              Save changes
            </button>
          </div>
        </form>
      </div>
    </div>


      <!-- Contractor detail modal -->
      <div id="contractor-modal" class="payout-modal hidden">
        <div class="payout-modal-backdrop"></div>
      
        <div class="payout-modal-dialog">
          <div class="payout-modal-header">
            <h3 id="contractor-modal-title">Edit contractor</h3>
            <button
              id="contractor-modal-close"
              class="payout-modal-close"
              aria-label="Close"
            >
              &times;
            </button>
          </div>
      
          <form id="contractor-modal-form" class="payout-modal-body">
            <input type="hidden" id="contractor-modal-id" />
      
            <dl class="payout-modal-grid">
              <div>
                <dt>Name</dt>
                <dd>
                  <input
                    id="contractor-modal-name"
                    type="text"
                    class="modal-input"
                    required
                  />
                </dd>
              </div>
      
              <div>
                <dt>Role</dt>
                <dd>
                  <input
                    id="contractor-modal-role"
                    type="text"
                    class="modal-input"
                  />
                </dd>
              </div>
      
              <div>
                <dt>Wallet address</dt>
                <dd>
                  <input
                    id="contractor-modal-wallet"
                    type="text"
                    class="modal-input"
                  />
                </dd>
              </div>
      
              <div>
                <dt>Country</dt>
                <dd>
                  <input
                    id="contractor-modal-country"
                    type="text"
                    class="modal-input"
                  />
                </dd>
              </div>
            </dl>
      
            <div class="payout-modal-footer">
              <button
                type="button"
                id="contractor-modal-delete"
                class="modal-btn secondary danger"
              >
                Delete contractor
              </button>
      
              <button type="submit" class="modal-btn primary">
                Save changes
              </button>
            </div>
          </form>
        </div>
      </div>
      <div class="modal hidden" id="wallet-modal">
        <div class="modal-backdrop" data-close="wallet-modal"></div>
      
        <div class="modal-card">
          <div class="modal-header">
            <h3>Add treasury wallet</h3>
            <button class="modal-close" type="button" data-close="wallet-modal">&times;</button>
          </div>
      
          <form class="modal-body" id="wallet-form">
            <div class="field">
              <label class="field-label">Label</label>
              <input class="input-control" type="text" id="wallet-label" placeholder="e.g., Safe Treasury" required />
            </div>
      
            <div class="field">
              <label class="field-label">Address</label>
              <input class="input-control mono" type="text" id="wallet-address" placeholder="0x..." required />
              <p class="field-help">EVM address (Ethereum / Base / Polygon). Read-only tracking.</p>
            </div>
      
            <div class="modal-footer">
              <button class="btn" type="button" data-close="wallet-modal">Cancel</button>
              <button class="btn primary-btn" type="submit">Save wallet</button>
            </div>
          </form>
        </div>
      </div>

  


  <div id="toast" class="toast hidden">Copied!</div>
  <div id="copy-toast" class="copy-toast">Copied!</div>
</body>
</html>

