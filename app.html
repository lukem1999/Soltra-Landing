<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Soltra App ‚Äî Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Auth wrapper -->
  <div id="auth-wrapper">
    <div class="auth-card">
      <h2>Sign in to Soltra</h2>
      <p class="auth-subtitle">Use your email to manage your contractor payouts.</p>

      <form id="auth-form">
        <input type="email" name="email" placeholder="you@company.com" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit" class="btn auth-btn"><span>Sign in</span></button>
      </form>

      <button id="auth-toggle-mode" class="auth-toggle">
        New here? Create an account
      </button>

      <p id="auth-message" class="auth-message"></p>
      <button id="signout-btn" class="mini-btn" style="display:none;">Sign out</button>
    </div>
  </div>

  <!-- Simple app header (logo + back to site) -->
<header class="site-header">
  <a href="index.html" class="nav-logo">
    <img src="soltra-s.png" alt="Soltra logo" class="nav-logo-img" />
    <span class="nav-logo-text">Soltra</span>
  </a>

  <nav class="site-nav">
    <a href="index.html">Back to site</a>
  </nav>

  <div class="site-nav-cta"></div>
</header>


  <!-- APP SHELL -->
  <section class="app-shell">
    <div class="app-layout">
      <!-- Sidebar -->
      <aside class="app-sidebar">
        <div class="sidebar-logo">
          <div class="sidebar-mark">S</div>
          <span>Soltra</span>
        </div>

        <nav class="app-tabs">
          <button class="tab-button" data-target="dashboard">
            <span>Overview</span>
          </button>
        
          <button class="tab-button" data-target="contractors">
            <span>Payees</span>
            <span class="tab-pill" id="sidebar-contractors-count"></span>
          </button>
        
          <button class="tab-button" data-target="payouts">
            <span>Payments</span>
            <span class="tab-pill" id="sidebar-payouts-count"></span>
          </button>
        
          <button class="tab-button" data-target="reports">
            <span>Exports</span>
          </button>

          <button class="tab-button upgrade-cta" onclick="window.location.href='pricing.html'">
            ‚ö° Upgrade / Pricing
          </button>
        </nav>


        <div class="sidebar-foot">
          <span class="sidebar-label">Environment</span>
          <span class="sidebar-pill">Sandbox</span>
        </div>
      </aside>

            <!-- Main content -->
      <div class="app-main">
        <header class="app-header">
          <div>
            <h2>Soltra Dashboard</h2>
            <p>Track stablecoin payouts, recipients, and reporting in one place.</p>
          </div>
      
          <div class="app-header-controls">
            <!-- Date range selector (existing) -->
            <select class="app-select">
              <option>This month</option>
              <option>Last month</option>
              <option>Last 90 days</option>
            </select>          
      
            <!-- User pill (existing) -->
            <div class="user-pill">
              <span class="user-avatar">L</span>
              <span class="user-name">You</span>
            </div>
          </div>
        </header>


        <div class="app-main-inner">
          <!-- DASHBOARD VIEW -->
          <div id="view-dashboard" class="app-view">
            <div class="shell dashboard-shell">
              <!-- Onboarding banner -->
              <div id="onboarding-banner" class="onboarding-banner hidden">
                <div class="onboarding-main">
                  <h3>Get started in two steps</h3>
                  <p class="onboarding-text">
                    Add a contractor, log your first payout, and we‚Äôll populate this dashboard
                    with real USDC activity.
                  </p>
          
                  <div class="onboarding-steps">
                    <div class="onboarding-step">
                      <div class="onboarding-step-number">1</div>
                      <div class="onboarding-step-body">
                        <div class="onboarding-step-title">Add a contractor</div>
                        <div class="onboarding-step-text">
                          Save a contributor with a wallet address so you can select them later.
                        </div>
                        <button
                          type="button"
                          class="mini-btn onboarding-cta"
                          id="onboarding-go-contractors"
                        >
                          Go to Contractors
                        </button>
                      </div>
                    </div>
          
                    <div class="onboarding-step">
                      <div class="onboarding-step-number">2</div>
                      <div class="onboarding-step-body">
                        <div class="onboarding-step-title">Log a payout</div>
                        <div class="onboarding-step-text">
                          Record an on-chain USDC transfer with chain, amount, and TX hash.
                        </div>
                        <button
                          type="button"
                          class="mini-btn onboarding-cta"
                          id="onboarding-go-payouts"
                        >
                          Go to Payouts
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
          
                <button
                  type="button"
                  class="onboarding-dismiss"
                  id="onboarding-dismiss"
                  aria-label="Dismiss"
                >
                  √ó
                </button>
              </div>
              
              <div class="dash-header">
                <div>
                  <h2 class="dash-title">Dashboard</h2>
                  <p class="dash-subtitle">
                    Overview of your USDC payouts and recipients across chains.
                  </p>
                </div>
              
                <div class="dash-filters-wrap">
                  <div class="dash-filters">
                    <div class="dash-filter-group">
                      <label for="dash-range">Range</label>
                      <select id="dash-range">
                        <option value="7d">Last 7 days</option>
                        <option value="30d" selected>Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="all">All time</option>
                      </select>
                    </div>
              
                    <div class="dash-filter-group">
                      <label for="dash-chain">Chain</label>
                      <select id="dash-chain">
                        <option value="all" selected>All chains</option>
                        <option value="BASE">Base</option>
                        <option value="POLYGON">Polygon</option>
                        <option value="ETHEREUM">Ethereum</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- WALLET STRIP (ABOVE PAYOUTS) -->
              <div class="wallet-strip">
                <div class="wallet-strip-head">
                  <button id="open-wallet-modal" type="button" class="btn upgrade-btn">
                    + Add wallet
                  </button>
                </div>
              </div>


              <!-- KPI cards -->
              <div class="dash-kpi-row">
                <div class="dash-card">
                  <div class="dash-card-label">Total payouts</div>
                  <div id="dash-total-30d" class="dash-card-value">$0</div>
                  <div id="dash-payout-count" class="dash-card-sub">0 payouts</div>
                </div>

                <div class="dash-card">
                  <div class="dash-card-label">Active payees</div>
                  <div id="dash-contractors" class="dash-card-value">0</div>
                  <div class="dash-card-sub">With payouts in this range</div>
                </div>

                <div class="dash-card">
                  <div class="dash-card-label">Chains used</div>
                  <div id="dash-chains" class="dash-card-value">0</div>
                  <div id="dash-chain-list" class="dash-card-sub">No activity yet.</div>
                </div>
              </div>

              <!-- Recent payouts table -->
              <div class="dash-card dash-table-card">
                <div class="dash-card-header">
                  <div>
                    <div class="dash-card-label">Recent payouts</div>
                    <div class="dash-card-sub">
                      Latest on-chain payouts matching your filters.
                    </div>
                  </div>
                </div>
              
                <div class="dash-table-wrapper">
                  <table class="dash-table payout-table">
                    <!-- ‚úÖ Forces identical column widths across Overview + Payouts + Reports -->
                    <colgroup>
                      <col class="col-date" />
                      <col class="col-contractor" />
                      <col class="col-amount" />
                      <col class="col-chain" />
                      <col class="col-tx" />
                    </colgroup>
              
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Contractor</th>
                        <th class="th-amount">Amount</th>
                        <th>Chain</th>
                        <th>Tx hash</th>
                      </tr>
                    </thead>
              
                    <tbody id="dash-payouts-table">
                      <tr>
                        <td colspan="5">Loading payouts‚Ä¶</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>


              <!-- Charts -->
              <section class="dash-charts">
                <div class="chart-card">
                  <div class="chart-card-header chart-card-header--split">
                    <div class="chart-titleblock">
                      <h3>Monthly payout volume</h3>
                      <p>USDC paid out over the last few months.</p>
                    </div>
                  
                    <div class="chart-kpi-pill" aria-label="Total paid in selected range">
                      <div class="chart-kpi-top">Total paid</div>
                      <div id="payoutVolumeTotal" class="chart-kpi-amount">$0</div>
                      <div class="chart-kpi-bottom">Last 6 months</div>
                    </div>
                  </div>

                
                  <!-- important: keep chart height consistent -->
                  <div class="chart-canvas-wrap">
                    <canvas id="payoutVolumeChart"></canvas>
                  </div>
                </div>

                <div class="chart-card">
                  <div class="chart-card-header">
                    <h3>Chains used</h3>
                    <p>Share of payouts by chain.</p>
                  </div>
                
                  <div class="chart-canvas-wrap">
                    <canvas id="chainSplitChart"></canvas>
                  </div>
                </div>
              </section>

              <div class="card card-side">
                <h3 class="card-title">This month snapshot</h3>
                <ul class="summary-list">
                  <li>
                    <span>Total recipients paid</span>
                    <strong id="snapshot-contractors">0</strong>
                  </li>
                  <li>
                    <span>Average payout size</span>
                    <strong id="snapshot-avg">$0</strong>
                  </li>
                  <li>
                    <span>CSV exports</span>
                    <strong>0</strong>
                  </li>
                  <li>
                    <span>Failed payouts</span>
                    <strong>0</strong>
                  </li>
                </ul>
              </div>
            </div>
          </div>


          <!-- CONTRACTORS VIEW -->
          <div id="view-contractors" class="app-view hidden">
            <div class="shell dashboard-shell">
              <div class="section-header">
                <div>
                  <h2 class="section-title">Payees</h2>
                  <p class="section-subtitle">
                    Entities that receive stablecoin payments from your wallets.
                  </p>
                </div>
              </div>

              <div class="two-column-layout">
                <!-- LEFT: add contractor form -->
                <div class="form-card">
                  <h3 class="form-title">Add payee</h3>
                  <p class="form-subtitle">
                    Store basic details and a payout address. You can edit or remove them later.
                  </p>

                  <form id="add-contractor-form" onsubmit="addContractor(event)" class="form-grid">
                    <div class="field">
                      <label class="field-label">Name<span>*</span></label>
                      <input
                        type="text"
                        name="name"
                        class="input-control"
                        placeholder="Jane Doe"
                        required
                      />
                    </div>

                    <div class="field">
                      <label class="field-label">Label</label>
                      <input
                        type="text"
                        name="role"
                        class="input-control"
                        placeholder="Solidity dev, Designer, Ops‚Ä¶"
                      />
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Wallet address<span>*</span></label>
                      <input
                        type="text"
                        name="wallet_address"
                        class="input-control mono"
                        placeholder="0x..."
                        required
                      />
                      <p class="field-help">
                        EVM-compatible address where payouts will be sent.
                      </p>
                    </div>

                    <div class="field">
                      <label class="field-label">Country</label>
                      <input
                        type="text"
                        name="country"
                        class="input-control"
                        placeholder="Estonia, US, Nigeria‚Ä¶"
                      />
                    </div>

                    <div class="field full-row">
                      <button type="submit" class="btn primary-btn">
                        Save contractor
                      </button>
                    </div>
                  </form>
                </div>

                <!-- RIGHT: contractors table -->
                <div class="table-card">
                  <div class="table-card-header">
                    <div>
                      <h3 class="form-title">Saved payees</h3>
                      <p class="form-subtitle">
                        These wallets will show up when logging payouts.
                      </p>
                    </div>
                  </div>

                  <div class="dash-table-wrapper">
                    <table class="dash-table">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Wallet</th>
                          <th>Role</th>
                          <th>Country</th>
                          <th>Last paid</th>
                        </tr>
                      </thead>
                      <tbody id="contractors-body">
                        <tr>
                          <td colspan="5">No contractors yet.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- PAYOUTS VIEW -->
          <div id="view-payouts" class="app-view hidden">
            <div class="shell dashboard-shell">
              <div class="section-header">
                <div>
                  <h2 class="section-title">Payouts</h2>
                  <p class="section-subtitle">
                    Log USDC payouts you‚Äôve sent on-chain and keep a clean audit trail.
                  </p>
                </div>
              </div>

              <div class="two-column-layout">
                <!-- LEFT: add payout form -->
                <div class="form-card">
                  <h3 class="form-title">Log a payout</h3>
                  <p class="form-subtitle">
                    Record an on-chain transfer you‚Äôve already sent from your treasury
                    wallet or multisig.
                  </p>

                  <form id="payout-form" class="form-grid">
                    <div class="field">
                      <label class="field-label">Contractor<span>*</span></label>
                      <select
                        id="payout-contractor"
                        name="contractor_id"
                        class="input-control"
                        required
                      >
                        <option value="">Select contractor</option>
                      </select>
                    </div>

                    <div class="field">
                      <label class="field-label">Amount (USDC)<span>*</span></label>
                      <input
                        type="number"
                        name="amount"
                        class="input-control"
                        placeholder="1200"
                        step="0.01"
                        min="0"
                        required
                      />
                    </div>

                    <div class="field">
                      <label class="field-label">Chain<span>*</span></label>
                      <select name="chain" class="input-control" required>
                        <option value="">Select chain</option>
                        <option value="BASE">Base</option>
                        <option value="POLYGON">Polygon</option>
                        <option value="ETHEREUM">Ethereum</option>
                      </select>
                    </div>

                    <div class="field">
                      <label class="field-label">Date</label>
                      <input
                        type="date"
                        name="tx_date"
                        class="input-control"
                      />
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Tx hash<span>*</span></label>
                      <input
                        type="text"
                        name="tx_hash"
                        class="input-control mono"
                        placeholder="0x..."
                        required
                      />
                      <p class="field-help">
                        Paste the transaction hash from your block explorer.
                      </p>
                    </div>

                    <div class="field full-row">
                      <label class="field-label">Notes</label>
                      <textarea
                        name="note"
                        class="input-control textarea-control"
                        rows="2"
                        placeholder="September retainer, milestone 2, bonus‚Ä¶"
                      ></textarea>
                    </div>

                    <div class="field full-row">
                      <button type="submit" id="save-payout-btn" class="btn primary-btn">
                        Save payout
                      </button>
                    </div>
                  </form>
                </div>

                <!-- RIGHT: payout logs table -->
                <div class="table-card">
                  <div class="table-card-header">
                    <div>
                      <h3 class="form-title">Payout log</h3>
                      <p class="form-subtitle">
                        Recent payouts based on your current filters (range &amp; chain).
                      </p>
                    </div>
                  </div>

                  <div class="dash-table-wrapper">
                    <table class="dash-table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Contractor</th>
                          <th>Amount</th>
                          <th>Chain</th>
                          <th>Tx hash</th>
                        </tr>
                      </thead>
                      <tbody id="payouts-body">
                        <tr>
                          <td colspan="5">No payouts yet.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>

                  <!-- ================= REPORTS VIEW ================= -->
          <div class="app-view hidden" id="view-reports">
            <div class="list-header">
              <div>
                <h3>Reports</h3>
                <p class="section-subtitle">
                  CSV-ready view of payouts matching your dashboard filters
                  (range &amp; chain).
                </p>
              </div>
              <button class="mini-btn" id="reports-export-btn">Export CSV</button>
            </div>
  
            <!-- Empty state -->
            <div class="reports-empty" id="reports-empty">
              <h4>No payouts yet</h4>
              <p>
                Once you log payouts, this view will summarize them for finance
                and operations.
              </p>
              <button type="button" class="mini-btn" id="reports-go-payouts">
                Log a payout
              </button>
            </div>
  
            <!-- Table uses same style as dashboard -->
            <div class="dash-table-wrapper hidden" id="reports-table-wrapper">
              <table class="dash-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Contractor</th>
                    <th>Amount</th>
                    <th>USD value</th>
                    <th>Tx hash</th>
                  </tr>
                </thead>
                <tbody id="reports-body">
                  <tr>
                    <td colspan="5">Loading‚Ä¶</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- Payout detail side panel -->
  <div id="payout-detail-root">
    <div id="payout-detail-backdrop" class="payout-detail-backdrop"></div>
  
    <aside id="payout-detail-panel" class="payout-detail-panel">
      <div class="pd-header">
        <div>
          <div class="pd-kicker">Payout details</div>
          <h2 class="pd-title" id="pd-contractor">‚Äî</h2>
        </div>
        <button id="pd-close" type="button" class="pd-close-btn" aria-label="Close">
          √ó
        </button>
      </div>
  
      <div class="pd-body">
        <div class="pd-row">
          <span class="pd-label">Date</span>
          <span class="pd-value" id="pd-date">‚Äî</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Amount</span>
          <span class="pd-value" id="pd-amount">‚Äî</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Chain</span>
          <span class="pd-value" id="pd-chain">‚Äî</span>
        </div>
        <div class="pd-row">
          <span class="pd-label">Tx hash</span>
          <span class="pd-value">
            <code id="pd-txhash">‚Äî</code>
          </span>
        </div>
        <div class="pd-row pd-row-notes">
          <span class="pd-label">Notes</span>
          <p class="pd-notes" id="pd-note">No notes for this payout.</p>
        </div>
      </div>
    </aside>
  </div>


  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Dashboard chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // === Supabase config (DEV ONLY) ===
    const SUPABASE_URL = 'https://lvuvkgnkhrzpwlssupyh.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dXZrZ25raHJ6cHdsc3N1cHloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDkyOTIsImV4cCI6MjA3ODkyNTI5Mn0.9C1-3Di7tXJCgb_7ZHj7mz6QL5fDMvnvmBziYqgGeDs';
    
    // ‚úÖ ONE client, memory-only auth (fixes GitHub Pages + tracking prevention)
    window.__soltra_sb__ =
      window.__soltra_sb__ ||
      window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: false,      // üî• THIS is the key fix
          autoRefreshToken: false,
          detectSessionInUrl: false,
        },
      });
    
    const sb = window.__soltra_sb__;

    // Auth bootstrap (GitHub Pages friendly)
    // Single source of truth: CURRENT_USER
    // =============================
    let CURRENT_USER = null;
    
    // helper: avoid getSession() wedges
    async function getCurrentUser() {
      const { data, error } = await sb.auth.getUser();
      if (error) {
        console.warn("getUser error:", error);
        return null;
      }
      return data?.user || null;
    }
    
    // ‚Äúauth is ready‚Äù gate (optional, but helpful)
    let authReadyResolve;
    const authReady = new Promise((res) => (authReadyResolve = res));
    
    // fire on auth events
    sb.auth.onAuthStateChange(async (event) => {
      console.log("AUTH EVENT:", event);
    
      CURRENT_USER = await getCurrentUser();
    
      // update UI/data
      await onAuthChanged(event);
    
      // resolve authReady once we‚Äôve seen initial state
      if (event === "INITIAL_SESSION" || event === "SIGNED_IN" || event === "SIGNED_OUT") {
        authReadyResolve(true);
      }
    });
    
    // kick once in case events are delayed
    (async () => {
      CURRENT_USER = await getCurrentUser();
      await onAuthChanged("BOOT");
      authReadyResolve(true);
    })();

    // === GLOBAL STATE ===
    let contractorsCache = [];
    let authMode = 'signin';       // 'signin' | 'signup'
    let filterRange = '30d';       // '7d' | '30d' | '90d' | 'all'
    let filterChain = 'all';       // 'all' | 'BASE' | 'POLYGON' | 'ETHEREUM'
    let lastDashboardPayoutCount = 0;
    let dashboardPayoutsCache = [];
    let dashboardLoading = false;

    const CHAIN_COLORS = {
      ETHEREUM: '#627EEA', // Ethereum blue
      POLYGON:  '#8247E5', // Polygon purple
      BASE:     '#0052FF', // Base blue
      UNKNOWN:  '#6B7280'  // neutral gray
    };

    // === UTILITIES ===
    function formatUSD(amount, opts = {}) {
      const {
        minimumFractionDigits = 0,
        maximumFractionDigits = 0,
      } = opts;
    
      const num = Number(amount);
    
      if (!Number.isFinite(num)) return '$0';
    
      return num.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits,
        maximumFractionDigits,
      });
    }

    function showToast(message = 'Copied!') {
      const toast = document.getElementById('toast');
      if (!toast) return;
    
      toast.textContent = message;
      toast.classList.remove('hidden');
      toast.classList.add('toast-visible');
    
      // clear previous timer if any
      clearTimeout(showToast._timeout);
      showToast._timeout = setTimeout(() => {
        toast.classList.remove('toast-visible');
        toast.classList.add('hidden');
      }, 1800);
    }


    function setAuthMessage(text, type = '') {
      const el = document.getElementById('auth-message');
      if (!el) return;
      el.textContent = text || '';
      el.className = 'auth-message';
      if (type) el.classList.add(type);
    }

    function setAuthMode(mode) {
      authMode = mode;
      const toggle = document.getElementById('auth-toggle-mode');
      const btn = document.querySelector('#auth-form .auth-btn');
      if (!toggle || !btn) return;

      if (mode === 'signin') {
        btn.textContent = 'Sign in';
        toggle.textContent = 'New here? Create an account';
      } else {
        btn.textContent = 'Create account';
        toggle.textContent = 'Already have an account? Sign in';
      }
      setAuthMessage('');
    }

    function highlightDashboard() {
    // KPIs + table card
    const hardTargets = document.querySelectorAll('.dash-card');
    hardTargets.forEach((el) => {
      el.classList.remove('dash-pulse');          // reset if still on
      void el.offsetWidth;                        // force reflow
      el.classList.add('dash-pulse');
    });
  
    // Charts
    const softTargets = document.querySelectorAll('.chart-card');
    softTargets.forEach((el) => {
      el.classList.remove('dash-pulse-soft');
      void el.offsetWidth;
      el.classList.add('dash-pulse-soft');
    });
  }

  function bindExportButton() {
    const btn = document.getElementById('reports-export-btn'); // ‚úÖ matches your HTML
  
    if (!btn) {
      console.warn('‚ùå Export button not found (#reports-export-btn).');
      return;
    }
  
    // Avoid double-binding
    if (btn.dataset.bound === '1') return;
    btn.dataset.bound = '1';
  
    console.log('‚úÖ Export button bound.');
  
    btn.addEventListener('click', (e) => {
      e.preventDefault();
  
      console.log(
        'üì¶ Export clicked. payouts in cache:',
        (dashboardPayoutsCache || []).length
      );
  
      try {
        exportPayoutsToCsv(); // ‚úÖ your real export function name
        console.log('‚úÖ exportPayoutsToCsv() ran');
      } catch (err) {
        console.error('‚ùå exportPayoutsToCsv crashed:', err);
        alert('Export failed ‚Äî check console for error.');
      }
    });
  }


     // ===============================
  // Wallets (Option A: Saved addresses) ‚Äî CLEAN VERSION
  // Table: public.wallets (id, user_id, label, address, created_at)
  // ===============================

  // ===============================
// WALLET MODAL + WALLET FUNCTIONS
// ===============================

  // ---- Helpers
  function $(id) {
    return document.getElementById(id);
  }
  
  function showWalletMessage(msg, type = "info") {
    const el = $("wallet-message");
    if (!el) return;
    el.textContent = msg;
    el.classList.remove("ok", "err", "info");
    el.classList.add(type);
  }
  
  function shortenAddress(addr) {
    if (!addr) return "";
    const a = String(addr).trim();
    if (a.length <= 12) return a;
    return `${a.slice(0, 6)}‚Ä¶${a.slice(-4)}`;
  }
  
  function normalizeEvmAddress(addr) {
    return String(addr || "").trim();
  }
  
  function isValidEvmAddress(addr) {
    // basic EVM check (0x + 40 hex chars)
    return /^0x[a-fA-F0-9]{40}$/.test(addr);
  }
  
  async function requireUser() {
    // Prefer cached user from your auth bootstrap
    const user = CURRENT_USER || (typeof getCurrentUser === "function" ? await getCurrentUser() : null);
    return user || null;
  }
  
  // ---- Modal open/close
  function openWalletModal() {
    const modal = $("wallet-modal");
    if (!modal) return;
  
    modal.classList.remove("hidden");
    document.body.classList.add("modal-open");
  
    // optional: focus address field
    const addr = $("wallet-address");
    if (addr) setTimeout(() => addr.focus(), 0);
  }
  
  function closeWalletModal() {
    const modal = $("wallet-modal");
    if (!modal) return;
  
    modal.classList.add("hidden");
    document.body.classList.remove("modal-open");
  
    // clear message
    showWalletMessage("", "info");
  }
  
  // ---- Render wallets list
  function renderWallets(wallets) {
    const list = $("wallets-list");
    if (!list) return;
  
    if (!wallets || wallets.length === 0) {
      list.innerHTML = `
        <div class="empty-state" id="wallet-empty">
          <div class="empty-state-title">No wallets yet</div>
          <p class="empty-state-text">Add a treasury wallet address to start your feed.</p>
        </div>
      `;
      return;
    }
  
    list.innerHTML = wallets
      .map(w => {
        const label = w.label || "Wallet";
        const chain = (w.chain || "").toUpperCase();
        const addr = shortenAddress(w.address);
  
        return `
          <div class="wallet-row" data-wallet-id="${w.id}">
            <div class="wallet-row-left">
              <div class="wallet-row-title">${label}</div>
              <div class="wallet-row-sub">${chain} ‚Ä¢ <span class="mono">${addr}</span></div>
            </div>
  
            <div class="wallet-row-actions">
              <button class="wallet-action-btn" type="button" data-action="copy" data-address="${w.address}">
                Copy
              </button>
              <button class="wallet-action-btn danger" type="button" data-action="delete" data-id="${w.id}">
                Delete
              </button>
            </div>
          </div>
        `;
      })
      .join("");
  }
  
  // ---- Load wallets from Supabase
  async function loadWallets() {
    const list = $("wallets-list");
    if (!list) return;
  
    const user = await requireUser();
    if (!user) {
      renderWallets([]);
      return;
    }
  
    const { data, error } = await sb
      .from("wallets")
      .select("id, label, address, chain, wallet_type, created_at")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false });
  
    if (error) {
      console.error("loadWallets error:", error);
      showWalletMessage("Error loading wallets.", "err");
      renderWallets([]);
      return;
    }
  
    renderWallets(data || []);
  }
  
  async function addWalletFromForm(e) {
    e.preventDefault();
  
    const user = await requireUser();
    if (!user) {
      showWalletMessage("Please sign in first.", "err");
      return;
    }
  
    // Supports BOTH modal form (label/address) and dashboard wallet-card form (wallet_type/chain/address)
    const labelInput =
      $("wallet-label") || document.querySelector("#wallet-form input[name='label']");
  
    const addressInput =
      $("wallet-address") || document.querySelector("#wallet-form input[name='address']");
  
    const chainSelect =
      $("wallet-chain") || document.querySelector("#wallet-form select[name='chain']");
  
    const walletTypeHidden =
      $("wallet_type") || document.querySelector("#wallet-form input[name='wallet_type']");
  
    const label = (labelInput ? labelInput.value : "Treasury wallet").trim() || "Treasury wallet";
    const address = normalizeEvmAddress(addressInput ? addressInput.value : "");
    const chain = (chainSelect ? chainSelect.value : "base").trim() || "base";
    const wallet_type = (walletTypeHidden ? walletTypeHidden.value : "safe").trim() || "safe";
  
    if (!address) {
      showWalletMessage("Enter a wallet address.", "err");
      return;
    }
  
    if (!isValidEvmAddress(address)) {
      showWalletMessage("That doesn‚Äôt look like a valid EVM address (0x + 40 hex).", "err");
      return;
    }
  
    showWalletMessage("Saving wallet‚Ä¶", "info");
  
    const payload = {
      user_id: user.id,
      label,
      address,
      chain,
      wallet_type,
    };
  
    const { data, error } = await sb
      .from("wallets")
      .insert([payload])
      .select("id, label, address, chain, wallet_type, created_at")
      .single();
  
    if (error) {
      console.error("addWallet error:", error);
  
      if (String(error.message || "").toLowerCase().includes("duplicate")) {
        showWalletMessage("That wallet already exists.", "err");
      } else {
        showWalletMessage("Error saving wallet.", "err");
      }
      return;
    }
  
    showWalletMessage("Wallet saved.", "ok");
  
    // Clear fields
    if (addressInput) addressInput.value = "";
    if (labelInput) labelInput.value = "";
  
    // Refresh list
    await loadWallets();
  
    // ‚úÖ SUCCESS ACTIONS (toast + animate newly-added wallet row)
    try {
      // If you added toastSuccess(), this will work. If not, swap to showToast('Wallet added')
      if (typeof toastSuccess === "function") toastSuccess("Wallet added");
      else if (typeof showToast === "function") showToast("Wallet added");
  
      const list = document.getElementById("wallets-list");
      // If your renderWallets() renders newest first, this is the new row:
      const newRow =
        list?.querySelector(".wallet-row") || list?.querySelector(".wallet-saved-row");
  
      if (typeof animateOnce === "function") {
        animateOnce(newRow, "anim-slide-row", 700);
      } else if (newRow) {
        // fallback if you didn't add animateOnce yet
        newRow.classList.add("anim-slide-row");
        setTimeout(() => newRow.classList.remove("anim-slide-row"), 700);
      }
    } catch (err) {
      console.warn("wallet success animation failed:", err);
    }
  
    // Close modal (if using modal)
    closeWalletModal();
  }

  
  // ---- Click handling inside wallets list (copy/delete)
  async function onWalletListClick(e) {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;
  
    const action = btn.dataset.action;
  
    if (action === "copy") {
      const addr = btn.dataset.address || "";
      try {
        await navigator.clipboard.writeText(addr);
        // optional toast you already have
        const toast = $("toast") || $("copy-toast");
        if (toast) {
          toast.classList.remove("hidden");
          setTimeout(() => toast.classList.add("hidden"), 1200);
        }
      } catch (err) {
        console.warn("Clipboard copy failed:", err);
        alert("Copy failed. Your browser may block clipboard access.");
      }
    }
  
    if (action === "delete") {
      const id = btn.dataset.id;
      if (id) await deleteWallet(id);
    }
  }


  function defaultLabelForType(t) {
    const map = {
      safe: 'Safe Treasury',
      ledger: 'Ledger Treasury',
      metamask: 'MetaMask Treasury',
      coinbase: 'Coinbase Wallet',
      other: 'Wallet',
    };
    return map[t] || 'Wallet';
  }
  
  function initWalletLabelToggle() {
    const typeEl = document.getElementById('walletType');
    const customEl = document.getElementById('walletCustomLabel');
  
    if (!typeEl || !customEl) return;
  
    const sync = () => {
      const isOther = typeEl.value === 'other';
      customEl.classList.toggle('hidden', !isOther);
      if (!isOther) customEl.value = '';
    };
  
    typeEl.addEventListener('change', sync);
    sync(); // run once on load
  }

  
  function isValidEvmAddress(addr) {
    return /^0x[a-fA-F0-9]{40}$/.test((addr || '').trim());
  }
  
  function normalizeAddress(addr) {
    return (addr || '').trim().toLowerCase();
  }
  
  function shortenAddress(addr) {
    const a = (addr || '').trim();
    if (a.length <= 12) return a;
    return a.slice(0, 6) + '‚Ä¶' + a.slice(-4);
  }
  
  function setWalletMessage(text, type = '') {
    const el = document.getElementById('wallet-message');
    if (!el) return;
    el.textContent = text || '';
    el.className = 'form-message';
    if (type) el.classList.add(type);
  }

  function initWalletTypeDropdown() {
    const root = document.querySelector('[data-dropdown="walletType"]');
    if (!root) return;
  
    const btn = root.querySelector('#wallet-type-btn');
    const menu = root.querySelector('.select-menu');
    const hidden = root.querySelector('#wallet_type');
    const text = root.querySelector('#wallet-type-text');
    const iconEl = root.querySelector('.select-icon'); // can be img OR span
  
    if (!btn || !menu || !hidden || !text || !iconEl) return;
  
    function setIcon(value) {
      // If iconEl is <img>, set src. If it‚Äôs <span>, set textContent.
      if (iconEl.tagName === 'IMG') {
        iconEl.src = value || '';
        iconEl.alt = text.textContent || 'Wallet';
      } else {
        iconEl.textContent = value || '';
      }
    }
  
    function open() {
      menu.classList.remove('hidden');
      btn.setAttribute('aria-expanded', 'true');
    }
  
    function close() {
      menu.classList.add('hidden');
      btn.setAttribute('aria-expanded', 'false');
    }
  
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      isOpen ? close() : open();
    });
  
    // option click
    menu.querySelectorAll('.select-option').forEach(opt => {
      opt.addEventListener('click', () => {
        const value = opt.dataset.value || 'other';
        const label = opt.dataset.label || opt.textContent.trim() || 'Wallet';
        const ico = opt.dataset.icon || '';
  
        hidden.value = value;
        text.textContent = label;
        setIcon(ico);
  
        menu.querySelectorAll('.select-option').forEach(o => o.classList.remove('is-selected'));
        opt.classList.add('is-selected');
  
        close();
      });
    });
  
    // click outside closes
    document.addEventListener('click', (e) => {
      if (!root.contains(e.target)) close();
    });
  
    // esc closes
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });
  
    // ‚úÖ initialize default selected state + UI
    const current =
      menu.querySelector(`.select-option[data-value="${hidden.value}"]`) ||
      menu.querySelector('.select-option');
  
    if (current) {
      menu.querySelectorAll('.select-option').forEach(o => o.classList.remove('is-selected'));
      current.classList.add('is-selected');
  
      text.textContent = current.dataset.label || current.textContent.trim();
      setIcon(current.dataset.icon || '');
      hidden.value = current.dataset.value || hidden.value || 'other';
    }
  
    // Start closed
    close();
  }


   function chainIdFor(chain) {
    const c = (chain || '').toLowerCase();
    if (c === 'base') return 8453;
    if (c === 'ethereum') return 1;
    if (c === 'polygon') return 137;
    return null;
  }
  


   // === TAB NAVIGATION ===
  function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
  
    const views = {
      dashboard: document.getElementById('view-dashboard'),
      contractors: document.getElementById('view-contractors'),
      payouts: document.getElementById('view-payouts'),
      reports: document.getElementById('view-reports'),
    };
  
    if (!tabButtons.length) return;
  
    function showTab(target) {
      // 1) Sidebar active state
      tabButtons.forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.target === target);
      });
  
      // 2) View visibility
      Object.entries(views).forEach(([key, el]) => {
        if (!el) return;
        el.classList.toggle('hidden', key !== target);
      });
  
      // 3) Tab-specific side effects
      if (target === 'dashboard') {
        requestAnimationFrame(() => highlightDashboard());
      }
  
      if (target === 'payouts') {
        // load contractors into payout dropdown when opening payouts tab
        loadPayoutContractorOptions();
      }
  
      if (target === 'reports') {
        loadDashboard().then(() => {
          loadReportsFromCache();
          bindExportButton(); // üëà RIGHT HERE
        });
      }
  
      // 4) Persist tab (optional)
      try {
        localStorage.setItem('soltra-active-tab', target);
      } catch (e) {}
    }
  
    // Wire tab clicks
    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        if (!target) return;
        showTab(target);
      });
    });
  
    // Initial tab (restore or default)
    let initial = 'dashboard';
    try {
      initial = localStorage.getItem('soltra-active-tab') || 'dashboard';
    } catch (e) {}
    if (!views[initial]) initial = 'dashboard';
  
    showTab(initial);
  }

    function shortenWallet(addr) {
      if (!addr || typeof addr !== 'string') return '';
      if (addr.length <= 12) return addr;
      return addr.slice(0, 6) + '...' + addr.slice(-4);
    }

      // === LOAD CONTRACTORS ===
    async function loadContractors() {
      const tbody = document.getElementById('contractors-body');
      if (!tbody) return;
    
      tbody.innerHTML = '<tr><td colspan="4">Loading contractors...</td></tr>';
    
      try {
        const { data, error } = await sb
          .from('contractors')
          .select('id, name, role, wallet_address, country'); // üëà NO .order() HERE
    
        console.log('LOAD CONTRACTORS RESULT:', { data, error });
    
        if (error) {
          console.error('LOAD CONTRACTORS ERROR', error);
          tbody.innerHTML = `
            <tr>
              <td colspan="4">
                Error loading contractors (${error.message})
              </td>
            </tr>
          `;
          return;
        }
    
        if (!data || !data.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <div class="empty-state-title">No contractors yet</div>
                  <p class="empty-state-text">
                    Add your first contractor to start logging payouts.
                  </p>
                </div>
              </td>
            </tr>
          `;
          return;
        }
    
        tbody.innerHTML = '';
    
        data.forEach((c) => {
          const name = c.name || 'Unnamed';
          const role = c.role || '‚Äî';
          const wallet = c.wallet_address || '‚Äî';
          const country = c.country || '‚Äî';
    
          // Build the row
          tbody.insertAdjacentHTML(
            'beforeend',
            `
              <tr class="contractor-row"
                  tabindex="0"
                  role="button"
                  data-id="${c.id}"
                  data-name="${name}"
                  data-role="${role}"
                  data-wallet="${wallet}"
                  data-country="${country}">
                <td>${name}</td>
                <td>${wallet}</td>
                <td>${role}</td>
                <td>${country}</td>
              </tr>
            `
          );
    
          // Wire up modal open on click / keyboard
          const tr = tbody.lastElementChild;
    
          tr.addEventListener('click', () => openContractorModalFromRow(tr));
    
          tr.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openContractorModalFromRow(tr);
            }
          });
        });
      } catch (err) {
        console.error('UNEXPECTED LOAD CONTRACTORS ERROR', err);
        tbody.innerHTML = `
          <tr>
            <td colspan="4">Something went wrong loading contractors.</td>
          </tr>
        `;
      }
    }
    
    function populateContractorSelect() {
      const select = document.getElementById('payout-contractor');
      if (!select) return;

      select.innerHTML = '<option value="">Select contractor</option>';

      contractorsCache.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name || c.wallet_address;
        select.appendChild(opt);
      });
    }

    function updateOnboardingBanner(contractorCount, payoutCount) {
      const banner = document.getElementById('onboarding-banner');
      if (!banner) return;
    
      let dismissed = false;
      try {
        dismissed = localStorage.getItem('soltra-onboarding-dismissed') === '1';
      } catch (e) {
        // ignore
      }
    
      if (dismissed) {
        banner.classList.add('hidden');
        return;
      }
    
      // Show as long as you are missing either contractors or payouts
      if (!contractorCount || !payoutCount) {
        banner.classList.remove('hidden');
      } else {
        banner.classList.add('hidden');
      }
    }

        // === CONTRACTOR MODAL ===
    const contractorModal       = document.getElementById('contractor-modal');
    const contractorModalForm   = document.getElementById('contractor-modal-form');
    const contractorModalClose  = document.getElementById('contractor-modal-close');
    const contractorModalDelete = document.getElementById('contractor-modal-delete');
    
    const contractorModalId      = document.getElementById('contractor-modal-id');
    const contractorModalName    = document.getElementById('contractor-modal-name');
    const contractorModalRole    = document.getElementById('contractor-modal-role');
    const contractorModalWallet  = document.getElementById('contractor-modal-wallet');
    const contractorModalCountry = document.getElementById('contractor-modal-country');
    
    function openContractorModalFromRow(row) {
      if (!contractorModal) return;
    
      contractorModalId.value      = row.dataset.id || '';
      contractorModalName.value    = row.dataset.name || '';
      contractorModalRole.value    = row.dataset.role || '';
      contractorModalWallet.value  = row.dataset.wallet || '';
      contractorModalCountry.value = row.dataset.country || '';
    
      contractorModal.classList.remove('hidden');
    }
    
    function closeContractorModal() {
      if (!contractorModal) return;
    
      contractorModal.classList.add('hidden');
      if (contractorModalForm) {
        contractorModalForm.reset();
        contractorModalId.value = '';
      }
    }

    function exportPayoutsToCsv() {
      const payouts = dashboardPayoutsCache || [];
    
      if (!payouts.length) {
        alert('No payouts to export for this range.');
        return;
      }
    
      // Helper
      const safe = (v) => (v == null ? '' : String(v));
    
      // Build rows (finance-friendly)
      const rows = payouts.map((p) => {
        const ts = p.tx_timestamp ? new Date(p.tx_timestamp) : null;
        const iso = ts && !isNaN(ts.getTime()) ? ts.toISOString() : '';
        const dateLocal = ts && !isNaN(ts.getTime()) ? ts.toLocaleDateString() : '';
        const month =
          ts && !isNaN(ts.getTime())
            ? `${ts.getFullYear()}-${String(ts.getMonth() + 1).padStart(2, '0')}`
            : '';
    
        const contractorName = p.contractors?.name || '';
        const chain = (p.chain || '').toUpperCase();
        const asset = p.asset_symbol || 'USDC';
        const amount = Number(p.amount || 0);
    
        const txHash = p.tx_hash || '';
        let explorerUrl = '';
        try {
          explorerUrl = txHash
            ? (typeof getExplorerUrl === 'function' ? getExplorerUrl(chain, txHash) : '')
            : '';
        } catch (e) {
          explorerUrl = '';
        }
    
        return {
          month,                         // YYYY-MM
          date: dateLocal,               // local date
          timestamp_iso: iso,            // ISO timestamp
          contractor: contractorName,    // contractor name
          amount: amount,                // numeric
          asset: asset,                  // USDC
          usd_value: amount,             // assumption 1 USDC = $1
          chain: chain,                  // ETHEREUM / BASE / POLYGON
          tx_hash: txHash,
          explorer_url: explorerUrl,
          note: p.note || '',
        };
      });
    
      const headers = Object.keys(rows[0]);
    
      // Convert to CSV with proper escaping
      const lines = [];
      lines.push(headers.join(','));
    
      for (const r of rows) {
        const line = headers
          .map((h) => {
            const v = safe(r[h]);
    
            // escape commas/quotes/newlines
            if (/[",\n]/.test(v)) return `"${v.replace(/"/g, '""')}"`;
            return v;
          })
          .join(',');
    
        lines.push(line);
      }
    
      const csvContent = lines.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
    
      // Filename includes active filters
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const d = String(today.getDate()).padStart(2, '0');
    
      const rangeTag = filterRange || 'range';
      const chainTag = filterChain || 'all';
    
      const filename = `soltra-reports-${y}-${m}-${d}-${rangeTag}-${chainTag}.csv`;
    
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    
      URL.revokeObjectURL(url);
    }

    



    function loadReportsFromCache() {
      const tbody = document.getElementById('reports-body');
      const empty = document.getElementById('reports-empty');
      const wrapper = document.getElementById('reports-table-wrapper');
    
      if (!tbody || !empty || !wrapper) return;
    
      // No payouts for current filters
      if (!dashboardPayoutsCache || !dashboardPayoutsCache.length) {
        empty.classList.remove('hidden');
        wrapper.classList.add('hidden');
        tbody.innerHTML =
          '<tr><td colspan="5">No payouts for this range.</td></tr>';
        return;
      }
    
      // We have data
      empty.classList.add('hidden');
      wrapper.classList.remove('hidden');
    
      tbody.innerHTML = '';
      dashboardPayoutsCache.forEach((p) => {
        const date = p.tx_timestamp
          ? new Date(p.tx_timestamp).toLocaleDateString()
          : '‚Äî';
        const name = p.contractors?.name || 'Unknown';
        const amount = `${p.amount} ${p.asset_symbol || 'USDC'}`;
    
        // For now assume 1 USDC = $1; you can later plug in FX if you want
        const usdValue = `$${Number(p.amount || 0).toLocaleString('en-US', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        })}`;
    
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date}</td>
          <td>${name}</td>
          <td>${amount}</td>
          <td>${usdValue}</td>
          <td>${p.tx_hash}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // === ADD CONTRACTOR (with success animation + toast) ===
    async function addContractor(event) {
      event.preventDefault();
    
      const form = event.target;
      const formData = new FormData(form);
    
      // ‚úÖ MATCH HTML NAMES
      const name = (formData.get('name') || '').toString().trim();
      const role = (formData.get('role') || '').toString().trim();
      const wallet = (formData.get('wallet_address') || '').toString().trim();
      const country = (formData.get('country') || '').toString().trim();
    
      // Basic validation
      if (!name || !wallet) {
        alert('Name and wallet address are required.');
        return;
      }
    
      try {
        // Must be signed in (RLS)
        const { data: userData, error: userErr } = await sb.auth.getUser();
        if (userErr || !userData?.user) {
          console.error('AUTH ERROR', userErr);
          alert('You must be signed in to add contractors.');
          return;
        }
    
        const userId = userData.user.id;
    
        // ‚úÖ Insert + return new row (so we can highlight it reliably)
        const { data: inserted, error } = await sb
          .from('contractors')
          .insert([{
            name,
            role: role || null,
            wallet_address: wallet,
            country: country || null,
            user_id: userId,
          }])
          .select('id, name, role, wallet_address, country')
          .single();
    
        if (error) {
          console.error('ADD CONTRACTOR ERROR', error);
          alert(`Error saving contractor: ${error.message}`);
          return;
        }
    
        // Reset form first (feels snappier)
        form.reset();
    
        // Refresh lists
        await loadContractors();
        if (typeof loadContractorOptions === 'function') {
          await loadContractorOptions();
        } else if (typeof loadPayoutContractorOptions === 'function') {
          // your newer function name
          await loadPayoutContractorOptions();
        }
    
        // ‚úÖ SUCCESS ACTIONS (toast + animate the new contractor row)
        try {
          if (typeof toastSuccess === 'function') toastSuccess('Contractor added');
          else if (typeof showToast === 'function') showToast('Contractor added');
    
          // Find the newly inserted row by data-id (your loadContractors sets data-id)
          const tbody = document.getElementById('contractors-body');
          const row = tbody?.querySelector(`tr[data-id="${inserted?.id}"]`);
    
          if (typeof animateOnce === 'function') {
            animateOnce(row, 'anim-slide-row', 700);
          } else if (row) {
            row.classList.add('anim-slide-row');
            setTimeout(() => row.classList.remove('anim-slide-row'), 700);
          }
        } catch (err) {
          console.warn('contractor success animation failed:', err);
        }
    
      } catch (err) {
        console.error('UNEXPECTED ADD CONTRACTOR ERROR', err);
        alert('Something went wrong adding the contractor.');
      }
    }



    function getExplorerUrl(chain, txHash) {
      if (!txHash) return '#';
      const c = (chain || '').toUpperCase();
    
      if (c.includes('BASE')) {
        return `https://basescan.org/tx/${txHash}`;
      }
      if (c.includes('POLYGON') || c.includes('MATIC')) {
        return `https://polygonscan.com/tx/${txHash}`;
      }
      if (c.includes('ETH')) {
        return `https://etherscan.io/tx/${txHash}`;
      }
      // Fallback ‚Äì you can change this later if you support more chains
      return `https://etherscan.io/tx/${txHash}`;
    }
    
    function shortenHash(txHash) {
      if (!txHash || txHash.length <= 12) return txHash || '';
      return txHash.slice(0, 6) + '...' + txHash.slice(-4);
    }


    function openPayoutDetailFromRow(tr) {
      const root = document.getElementById('payout-detail-root');
      if (!root || !tr) return;
    
      const date = tr.dataset.date || '‚Äî';
      const contractor = tr.dataset.contractor || 'Unknown';
      const amount = tr.dataset.amount || '‚Äî';
      const chain = tr.dataset.chain || '‚Äî';
      const txhash = tr.dataset.txhash || '‚Äî';
      const note = tr.dataset.note || 'No notes for this payout.';
    
      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };
    
      // NOTE: Your HTML has id="pd-contractor" (not "pd-contractor" in your screenshot?)
      setText('pd-date', date);
      setText('pd-contractor', contractor);
      setText('pd-amount', amount);
      setText('pd-chain', chain);
      setText('pd-txhash', txhash);
      setText('pd-note', note);
    
      root.classList.add('payout-detail-open');
    }

    
    function closePayoutDetail() {
      const root = document.getElementById('payout-detail-root');
      if (!root) return;
      root.classList.remove('payout-detail-open');
    }

    
    function wirePayoutDetailPanel() {
      const closeBtn = document.getElementById('pd-close');
      const backdrop = document.getElementById('payout-detail-backdrop');
    
      if (closeBtn) closeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closePayoutDetail();
      });
    
      if (backdrop) backdrop.addEventListener('click', (e) => {
        e.preventDefault();
        closePayoutDetail();
      });
    
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePayoutDetail();
      });
    }

    function fillPayoutModalFromRow(tr) {
      if (!tr) return;
      document.getElementById('payout-modal-date').textContent = tr.dataset.date || '';
      document.getElementById('payout-modal-contractor').textContent = tr.dataset.contractor || '';
      document.getElementById('payout-modal-amount').textContent = tr.dataset.amount || '';
      document.getElementById('payout-modal-chain').textContent = tr.dataset.chain || '';
      document.getElementById('payout-modal-txhash').textContent = tr.dataset.txhash || '';
      document.getElementById('payout-modal-note').textContent = tr.dataset.note || '';
    }
    
    let activePayoutRow = null;

    function wirePayoutRowClicks() {
      const bindTable = (tbodyId) => {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
    
        // ‚úÖ Prevent double binding on same tbody
        if (tbody.dataset.bound_payout_rows === '1') return;
        tbody.dataset.bound_payout_rows = '1';
    
        const openFromEvent = (e) => {
          // Don‚Äôt hijack clicks on real interactive elements
          const interactive = e.target.closest('a, button, input, textarea, select, label');
          if (interactive) return;
    
          const tr = e.target.closest('tr');
          if (!tr) return;
          if (!tbody.contains(tr)) return;
    
          // Don‚Äôt open for empty/loading rows (they won‚Äôt have an id)
          if (!tr.dataset || !tr.dataset.id) return;
    
          // ‚úÖ Use your side panel opener (not the old modal)
          openPayoutDetailFromRow(tr);
        };
    
        tbody.addEventListener('click', (e) => {
          openFromEvent(e);
        });
    
        tbody.addEventListener('keydown', (e) => {
          // Only when the focused element is a row (or inside it)
          const tr = e.target.closest('tr');
          if (!tr || !tbody.contains(tr)) return;
          if (!tr.dataset || !tr.dataset.id) return;
    
          // Enter or Space opens (Space is ' ' OR 'Spacebar' in some older browsers)
          const isEnter = e.key === 'Enter';
          const isSpace = e.key === ' ' || e.key === 'Spacebar';
    
          if (!isEnter && !isSpace) return;
    
          // If focus is on a link/button/input inside the row, let it behave normally
          const interactive = e.target.closest('a, button, input, textarea, select, label');
          if (interactive) return;
    
          e.preventDefault();
          openPayoutDetailFromRow(tr);
        });
      };
    
      bindTable('payouts-body');
      bindTable('dash-payouts-table');
    }


    async function handleDeletePayout() {
      const modal = document.getElementById('payout-modal');
      if (!modal) return;
    
      const payoutId = modal.dataset.payoutId;
      if (!payoutId) {
        alert('Missing payout id.');
        return;
      }
    
      const confirmDelete = window.confirm(
        'Delete this payout from Soltra? This will not move any on-chain funds.'
      );
      if (!confirmDelete) return;
    
      try {
        const { error } = await sb
          .from('payout')      // üëà singular table name
          .delete()
          .eq('id', payoutId);
    
        if (error) {
          console.error('Error deleting payout:', error);
          alert(`Error deleting payout: ${error.message}`);
          return;
        }
    
        // Close modal
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        modal.dataset.payoutId = '';
    
        // Refresh UI
        await loadPayouts();
        await loadDashboard();
        highlightDashboard();
      } catch (err) {
        console.error(err);
        alert('Network error while deleting payout.');
      }
    }

    
    function closePayoutModal() {
      const modal = document.getElementById('payout-modal');
      if (!modal) return;
    
      modal.classList.remove('payout-modal--open');
    
      // After transition, hide it
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 190);
    }

    function handlePayoutModalKeyDown(e) {
      const modal = document.getElementById('payout-modal');
      if (!modal || !modal.classList.contains('open')) return;
    
      // ESC closes
      if (e.key === 'Escape') {
        e.preventDefault();
        closePayoutModal();
        return;
      }
    
      // Up/down (and optional vim-style j/k)
      if (e.key === 'ArrowDown' || e.key === 'j') {
        e.preventDefault();
        const rows = getPayoutRows();
        if (!rows.length) return;
    
        const newIndex = Math.min(currentPayoutRowIndex + 1, rows.length - 1);
        const newRow = setActivePayoutRow(newIndex);
        fillPayoutModalFromRow(newRow);
      }
    
      if (e.key === 'ArrowUp' || e.key === 'k') {
        e.preventDefault();
        const rows = getPayoutRows();
        if (!rows.length) return;
    
        const newIndex = Math.max(currentPayoutRowIndex - 1, 0);
        const newRow = setActivePayoutRow(newIndex);
        fillPayoutModalFromRow(newRow);
      }
    }
    
    function attachPayoutModalKeyListeners() {
      document.addEventListener('keydown', handlePayoutModalKeyDown);
    }
    
    function detachPayoutModalKeyListeners() {
      document.removeEventListener('keydown', handlePayoutModalKeyDown);
    }

    // === Chain pill renderer (MUST be in global scope) ===
    function renderChainPill(chain) {
      if (!chain) return "";
    
      const c = String(chain).toLowerCase();
      let img = "images/generic-chain.svg";
      let label = chain;
    
      if (c.includes("base")) {
        img = "images/base-square.svg";
        label = "Base";
      } else if (c.includes("eth")) {
        img = "images/ethereum.svg";
        label = "Ethereum";
      } else if (c.includes("poly") || c.includes("matic")) {
        img = "images/polygon.svg";
        label = "Polygon";
      }
    
      return `
        <span class="chain-cell">
          <img src="${img}" alt="${label} logo" />
          <span class="chain-name">${label}</span>
        </span>
      `;
    }



        // === PAYOUTS ===
    async function loadPayouts(highlightId = null) {
      const tbody = document.getElementById('payouts-body');
      if (!tbody) return;
    
      tbody.innerHTML = '<tr><td colspan="5">Loading payouts...</td></tr>';
    
      // date filter
      let sinceISO = null;
      if (filterRange !== 'all') {
        const since = new Date();
        if (filterRange === '7d') since.setDate(since.getDate() - 7);
        else if (filterRange === '30d') since.setDate(since.getDate() - 30);
        else if (filterRange === '90d') since.setDate(since.getDate() - 90);
        sinceISO = since.toISOString();
      }
    
      let query = sb
        .from('payout') // singular table name
        .select(`
          id,
          amount,
          asset_symbol,
          chain,
          tx_hash,
          tx_timestamp,
          note,
          contractors ( name )
        `)
        .order('tx_timestamp', { ascending: false })
        .limit(50);
    
      if (sinceISO) query = query.gte('tx_timestamp', sinceISO);
      if (filterChain !== 'all') query = query.eq('chain', filterChain);
    
      const { data, error } = await query;
    
      console.log('LOAD PAYOUTS RESULT:', { data, error });
    
      if (error) {
        tbody.innerHTML = `
          <tr><td colspan="5">
            Error loading payouts (${error.message})
          </td></tr>
        `;
        return;
      }
    
      if (!data || !data.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-state-title">No payouts yet</div>
                <p class="empty-state-text">
                  Log a payout to see it appear here.
                </p>
              </div>
            </td>
          </tr>
        `;
        return;
      }
    
      tbody.innerHTML = '';
    
      data.forEach((p) => {
        const date = p.tx_timestamp
          ? new Date(p.tx_timestamp).toLocaleDateString()
          : '‚Äî';
    
        const contractor = p.contractors?.name || 'Unknown';
        const amountText = `${p.amount} ${p.asset_symbol || 'USDC'}`;
        const chainUpper = (p.chain || '').toUpperCase();
        const explorerUrl = getExplorerUrl(p.chain, p.tx_hash);
        const shortHash = shortenHash(p.tx_hash);
    
        tbody.insertAdjacentHTML(
          'beforeend',
          `
          <tr class="payout-row"
              data-payout-id="${p.id}">
            <td>${date}</td>
            <td>${contractor}</td>
            <td>${amountText}</td>
            <td>${renderChainPill(p.chain)}</td>
            <td>
              ${
                p.tx_hash
                  ? `<a href="${explorerUrl}"
                         target="_blank"
                         rel="noopener"
                         class="tx-link"
                         title="${p.tx_hash}">
                       ${shortHash}
                     </a>`
                  : '‚Äî'
              }
            </td>
          </tr>
          `
        );
    
        const tr = tbody.lastElementChild;
    
        // Accessibility (kept)
        tr.tabIndex = 0;
        tr.setAttribute('role', 'button');
    
        // Keep your datasets if you want (used by side panel / modal)
        tr.dataset.date = date;
        tr.dataset.contractor = contractor;
        tr.dataset.amount = amountText;
        tr.dataset.chain = chainUpper;
        tr.dataset.txhash = p.tx_hash || '';
        tr.dataset.note = p.note || '';
        tr.dataset.id = p.id;
    
        // Highlight newly-added payout (kept)
        if (highlightId && p.id === highlightId) {
          tr.classList.add('payout-row--new');
        }
      });
    }

        // === PAYOUTS ===
       // === PAYOUTS: add a new payout ===
    // === PAYOUTS: add a new payout (with success animation + toast) ===
    async function addPayout(event) {
      event.preventDefault();
    
      const form = event.target;
      const formData = new FormData(form);
    
      const contractor_id = formData.get("contractor_id");
      const amountStr     = formData.get("amount");
      const chain         = formData.get("chain");
      const tx_hash       = formData.get("tx_hash")?.trim();
      const tx_date       = formData.get("tx_date");
      const note          = formData.get("note")?.trim();
    
      if (!contractor_id || !amountStr || !chain || !tx_hash) {
        alert("Contractor, amount, chain, and TX hash are required.");
        return;
      }
    
      const amount = Number(amountStr);
      if (!amount || amount <= 0) {
        alert("Amount must be a positive number.");
        return;
      }
    
      const tx_timestamp = tx_date ? new Date(tx_date).toISOString() : new Date().toISOString();
    
      // 1) AUTH
      const { data: userData, error: userErr } = await sb.auth.getUser();
      const user = userData?.user;
      if (userErr || !user) {
        console.error("Not signed in / cannot fetch user:", userErr);
        alert("You must be signed in to log payouts.");
        return;
      }
    
      // 2) INSERT (only catch DB/network here)
      let newId = null;
      try {
        const { data: inserted, error } = await sb
          .from("payout") // your table name
          .insert([{
            contractor_id,
            amount,
            asset_symbol: "USDC",
            chain,
            tx_hash,
            tx_timestamp,
            note,
          }])
          .select("id")
          .single();
    
        if (error) throw error;
        newId = inserted?.id;
      } catch (err) {
        console.error("Error inserting payout:", err);
        alert(`Error saving payout: ${err.message || "Unknown error"}`);
        return;
      }
    
      // 3) UI UPDATE (don‚Äôt pretend save failed if render crashes)
      form.reset();
    
      try {
        await loadPayouts(newId);
        await loadDashboard(newId);
        highlightDashboard();
        // success animation hook can go here (toast, confetti, etc.)
        // fireSuccess("payout");
      } catch (uiErr) {
        console.error("Payout saved, but UI refresh failed:", uiErr);
        alert("Payout saved, but the UI failed to refresh. Check console for details.");
      }
    }



    async function loadPayoutContractorOptions() {
      const selectEl = document.getElementById('payout-contractor');
      if (!selectEl) return;
    
      selectEl.innerHTML = `<option value="">Loading contractors‚Ä¶</option>`;
      selectEl.disabled = true;
    
      const user = CURRENT_USER; // ‚úÖ single source of truth
      if (!user) {
        selectEl.innerHTML = `<option value="">Sign in to select a contractor</option>`;
        selectEl.disabled = true;
        return;
      }
    
      try {
        const { data, error } = await sb
          .from('contractors')
          .select('id, name, wallet_address')
          .eq('user_id', user.id)
          .order('name', { ascending: true });
    
        if (error) throw error;
    
        const rows = data || [];
        if (!rows.length) {
          selectEl.innerHTML = `<option value="">No contractors yet</option>`;
          selectEl.disabled = true;
          return;
        }
    
        selectEl.innerHTML = [
          `<option value="">Select contractor</option>`,
          ...rows.map(c => {
            const addr = c.wallet_address ? shortenAddress(c.wallet_address) : '';
            const label = addr ? `${c.name} ‚Ä¢ ${addr}` : c.name;
            return `<option value="${c.id}">${label}</option>`;
          })
        ].join('');
    
        selectEl.disabled = false;
      } catch (e) {
        console.error('loadPayoutContractorOptions error:', e);
        selectEl.innerHTML = `<option value="">Error loading contractors</option>`;
        selectEl.disabled = true;
      }
    }

    

    let currentPayoutRowIndex = -1;
    
    function getPayoutRows() {
      return Array.from(document.querySelectorAll('#payouts-body .payout-row'));
    }
    
    function setActivePayoutRow(index) {
      const rows = getPayoutRows();
      if (!rows.length) {
        currentPayoutRowIndex = -1;
        return;
      }
    
      // Clamp index
      if (index < 0) index = 0;
      if (index >= rows.length) index = rows.length - 1;
    
      currentPayoutRowIndex = index;
    
      rows.forEach(r => r.classList.remove('payout-row--active'));
      const row = rows[currentPayoutRowIndex];
      if (row) {
        row.classList.add('payout-row--active');
        row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    
      return row;
    }

        // === DASHBOARD ===
    async function loadDashboard(highlightId = null) {
      const totalEl       = document.getElementById('dash-total-30d');
      const payoutCountEl = document.getElementById('dash-payout-count');
      const contractorsEl = document.getElementById('dash-contractors');
      const chainsEl      = document.getElementById('dash-chains');
      const chainListEl   = document.getElementById('dash-chain-list');
      const tableBody     = document.getElementById('dash-payouts-table');

      if (dashboardLoading) return;
      dashboardLoading = true;

    
      if (!totalEl || !tableBody) return;
    
      // -----------------------------
      // Build date filter
      // -----------------------------
      let sinceISO = null;
      if (filterRange !== 'all') {
        const since = new Date();
        if (filterRange === '7d')  since.setDate(since.getDate() - 7);
        if (filterRange === '30d') since.setDate(since.getDate() - 30);
        if (filterRange === '90d') since.setDate(since.getDate() - 90);
        sinceISO = since.toISOString();
      }
    
      // -----------------------------
      // Query payouts
      // -----------------------------
      let query = sb
        .from('payout')
        .select(`
          id,
          amount,
          asset_symbol,
          chain,
          tx_hash,
          tx_timestamp,
          note,
          contractor_id,
          contractors ( name )
        `)
        .order('tx_timestamp', { ascending: false })
        .limit(500);
    
      if (sinceISO) query = query.gte('tx_timestamp', sinceISO);
      if (filterChain !== 'all') query = query.eq('chain', filterChain);
    
      try {
        const { data, error } = await query;
        if (error) throw error;
    
        const payouts = data || [];
    
        // -----------------------------
        // Cache (used by reports + charts)
        // -----------------------------
        dashboardPayoutsCache = payouts;
    
        // -----------------------------
        // KPIs
        // -----------------------------
        const totalAmount = payouts.reduce(
          (sum, p) => sum + (Number(p.amount) || 0),
          0
        );
    
        const payoutCount = payouts.length;
        const contractorIds = new Set(
          payouts.map(p => p.contractor_id).filter(Boolean)
        );
        const chains = new Set(
          payouts.map(p => (p.chain || '').toUpperCase()).filter(Boolean)
        );
    
        totalEl.textContent = formatUSD(totalAmount);
        payoutCountEl.textContent =
          payoutCount === 1 ? '1 payout' : `${payoutCount} payouts`;
    
        if (contractorsEl) contractorsEl.textContent = contractorIds.size;
        if (chainsEl) chainsEl.textContent = chains.size;
        if (chainListEl) {
          chainListEl.textContent = chains.size
            ? Array.from(chains).join(' ¬∑ ')
            : '‚Äî';
        dashboardLoading = false;
        }
    
        // Sidebar badge
        const sidebarCount = document.getElementById('sidebar-payouts-count');
        if (sidebarCount) {
          sidebarCount.textContent = payoutCount ? String(payoutCount) : '';
        }
    
        // -----------------------------
        // Snapshot (this month)
        // -----------------------------
        const now = new Date();
        const month = now.getMonth();
        const year  = now.getFullYear();
    
        const monthPayouts = payouts.filter(p => {
          if (!p.tx_timestamp) return false;
          const d = new Date(p.tx_timestamp);
          return d.getMonth() === month && d.getFullYear() === year;
        });
    
        const monthTotal = monthPayouts.reduce(
          (sum, p) => sum + (Number(p.amount) || 0),
          0
        );
    
        const snapshotContractors = new Set(
          monthPayouts.map(p => p.contractor_id).filter(Boolean)
        );
    
        const snapshotContractorsEl = document.getElementById('snapshot-contractors');
        const snapshotAvgEl         = document.getElementById('snapshot-avg');
    
        if (snapshotContractorsEl) {
          snapshotContractorsEl.textContent = snapshotContractors.size || 0;
        }
    
        if (snapshotAvgEl) {
          const avg = monthPayouts.length
            ? monthTotal / monthPayouts.length
            : 0;
          snapshotAvgEl.textContent = formatUSD(avg);
        }
    
        // -----------------------------
        // Recent payouts table
        // -----------------------------
        tableBody.innerHTML = '';
    
        if (!payouts.length) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <div class="empty-state-title">No payouts in this range</div>
                  <p class="empty-state-text">
                    Adjust filters or log a new payout.
                  </p>
                </div>
              </td>
            </tr>
          `;
        } else {
          payouts.slice(0, 10).forEach(p => {
            const date = p.tx_timestamp
              ? new Date(p.tx_timestamp).toLocaleDateString()
              : '‚Äî';
          
            const contractor = p.contractors?.name || 'Unknown';
            const amountText = `${p.amount} ${p.asset_symbol || 'USDC'}`;
            const chain = (p.chain || '').toUpperCase();
            const explorerUrl = getExplorerUrl(p.chain, p.tx_hash);
            const shortHash = shortenHash(p.tx_hash);
          
            const tr = document.createElement('tr');
            tr.className = 'payout-row';
          
            if (highlightId && p.id === highlightId) {
              tr.classList.add('payout-row--new');
            }
          
            tr.innerHTML = `
              <td>${date}</td>
              <td>${contractor}</td>
              <td>${amountText}</td>
              <td>${renderChainPill(p.chain)}</td>
              <td>
                ${
                  p.tx_hash
                    ? `<a href="${explorerUrl}" target="_blank" rel="noopener" class="tx-link">${shortHash}</a>`
                    : '‚Äî'
                }
              </td>
            `;
          
            tr.tabIndex = 0;
            tr.setAttribute('role', 'button');
          
            tr.dataset.date = date;
            tr.dataset.contractor = contractor;
            tr.dataset.amount = amountText;
            tr.dataset.chain = chain;
            tr.dataset.txhash = p.tx_hash || '';
            tr.dataset.note = p.note || '';
            tr.dataset.id = p.id;
          
            // ‚úÖ NO addEventListener here ‚Äî delegation handles it
            tableBody.appendChild(tr);
          });

        }
    
        // -----------------------------
        // ‚úÖ STEP 4 ‚Äî CHARTS (LAST)
        // -----------------------------
        buildMonthlyPayoutChart(payouts);
        renderDashboardChartsFromCache(); // chain split, etc.
        loadReportsFromCache();
    
      } catch (err) {
        console.error('Dashboard load failed:', err);
        totalEl.textContent = '$0';
        payoutCountEl.textContent = 'Error';
        tableBody.innerHTML =
          '<tr><td colspan="5">Error loading dashboard.</td></tr>';
        dashboardLoading = false;
      }
    }


    function formatUSDCompact(value) {
      if (value >= 1_000_000) return `$${(value / 1_000_000).toFixed(1)}M`;
      if (value >= 1_000) return `$${(value / 1_000).toFixed(0)}k`;
      return `$${value.toLocaleString()}`;
    }

    function buildMonthlyPayoutSeries(payouts) {
      const byMonth = {};
    
      (payouts || []).forEach((p) => {
        const ts = p.tx_timestamp ? new Date(p.tx_timestamp) : null;
        if (!ts || isNaN(ts.getTime())) return;
    
        const key = `${ts.getFullYear()}-${String(ts.getMonth() + 1).padStart(2, '0')}`;
        byMonth[key] = (byMonth[key] || 0) + (Number(p.amount) || 0);
      });
    
      // Always show last 6 months (even if zero)
      const end = new Date();
      end.setDate(1);
    
      const months = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date(end);
        d.setMonth(d.getMonth() - i);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        months.push(key);
      }
    
      return {
        labels: months.map((m) => new Date(m + '-01').toLocaleString('en-US', { month: 'short' })),
        values: months.map((m) => byMonth[m] || 0),
      };
    }


    function buildMonthlyPayoutChart() {
      const canvas = document.getElementById('payoutVolumeChart');
      if (!canvas) return;
    
      const ctx = canvas.getContext('2d');
    
      const { labels, values } = buildMonthlyPayoutSeries(dashboardPayoutsCache);
    
      // Update KPI total
      const total = values.reduce((a, b) => a + b, 0);
      const totalEl = document.getElementById('payoutVolumeTotal');
      if (totalEl) totalEl.textContent = formatUSD(total);
    
      // Destroy existing chart if present
      if (window.payoutVolumeChart && typeof window.payoutVolumeChart.destroy === 'function') {
        window.payoutVolumeChart.destroy();
      }
    
      window.payoutVolumeChart = new Chart(ctx, {
        type: 'bar',
    
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: '#f6c453',
            hoverBackgroundColor: '#ffd36a',
            borderRadius: 8,
            barThickness: 22,
            maxBarThickness: 26
          }]
        },
    
        options: {
          responsive: true,
          maintainAspectRatio: false,
    
          layout: {
            padding: { top: 6, right: 8, bottom: 0, left: 4 }
          },
    
          animation: {
            duration: 700,
            easing: 'easeOutQuart'
          },
    
          interaction: {
            mode: 'index',
            intersect: false
          },
    
          plugins: {
            legend: { display: false },
    
            tooltip: {
              displayColors: false,
              backgroundColor: 'rgba(10, 14, 22, 0.92)',
              borderColor: 'rgba(255,255,255,0.10)',
              borderWidth: 1,
              titleColor: 'rgba(255,255,255,0.85)',
              bodyColor: 'rgba(255,255,255,0.90)',
              padding: 10,
              cornerRadius: 10,
              callbacks: {
                title: () => '',
                label: (ctx) => `${formatUSDCompact(ctx.raw)} USDC`
              }
            }
          },
    
          scales: {
            x: {
              grid: { display: false },
              border: { display: false },
              ticks: {
                color: 'rgba(255,255,255,0.55)',
                font: { size: 12 }
              }
            },
    
            y: {
              beginAtZero: true,
              border: { display: false },
              grid: {
                color: 'rgba(255,255,255,0.06)',
                drawTicks: false
              },
              ticks: {
                callback: (v) => formatUSDCompact(v),
                color: 'rgba(255,255,255,0.55)',
                font: { size: 12 },
                padding: 8,
                maxTicksLimit: 5
              }
            }
          }
        }
      });
    }

    function buildChainSplitChart(payouts) {
      const canvas = document.getElementById('chainSplitChart');
      if (!canvas) return;
    
      const ctx = canvas.getContext('2d');
    
      // Count payouts per chain
      const counts = {};
      (payouts || []).forEach((p) => {
        const chain = (p.chain || 'UNKNOWN').toUpperCase();
        counts[chain] = (counts[chain] || 0) + 1;
      });
    
      // Nice ordering
      const ORDER = ['ETHEREUM', 'POLYGON', 'BASE', 'UNKNOWN'];
      const labels = Object.keys(counts).sort((a, b) => {
        const ai = ORDER.indexOf(a) === -1 ? 999 : ORDER.indexOf(a);
        const bi = ORDER.indexOf(b) === -1 ? 999 : ORDER.indexOf(b);
        return ai - bi;
      });
    
      const values = labels.map((k) => counts[k]);
      const total = values.reduce((a, b) => a + b, 0);
    
      // Friendly names for UI
      const LABEL_MAP = {
        ETHEREUM: 'Ethereum',
        POLYGON: 'Polygon',
        BASE: 'Base',
        UNKNOWN: 'Unknown',
      };
    
      const prettyLabels = labels.map((k) => LABEL_MAP[k] || k);
    
      const colors = labels.map((k) => CHAIN_COLORS?.[k] || CHAIN_COLORS?.UNKNOWN || '#6b7280');
    
      // Destroy previous chart
      if (window.chainSplitChart?.destroy) window.chainSplitChart.destroy();
    
      // Plugin: draw center label + % for hovered slice (or total if none hovered)
      const centerLabelPlugin = {
        id: 'centerLabelPlugin',
        afterDraw(chart, args, opts) {
          const { ctx, chartArea } = chart;
          if (!chartArea) return;
    
          const meta = chart.getDatasetMeta(0);
          if (!meta?.data?.length) return;
    
          // Determine active slice
          const active = chart.getActiveElements?.() || [];
          const activeIndex = active.length ? active[0].index : -1;
    
          const centerX = (chartArea.left + chartArea.right) / 2;
          const centerY = (chartArea.top + chartArea.bottom) / 2;
    
          // Values to show
          const label = activeIndex >= 0 ? prettyLabels[activeIndex] : 'Total payouts';
          const value = activeIndex >= 0 ? values[activeIndex] : total;
          const pct = total > 0 ? Math.round((value / total) * 100) : 0;
    
          ctx.save();
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
    
          // Small label
          ctx.fillStyle = 'rgba(255,255,255,0.70)';
          ctx.font = '600 12px "Space Grotesk", system-ui, -apple-system, Segoe UI, Roboto, Arial';
          ctx.fillText(label.toUpperCase(), centerX, centerY - 18);
    
          // Big percent
          ctx.fillStyle = 'rgba(255,255,255,0.92)';
          ctx.font = '700 34px "Space Grotesk", system-ui, -apple-system, Segoe UI, Roboto, Arial';
          ctx.fillText(total > 0 ? `${pct}%` : '‚Äî', centerX, centerY + 6);
    
          // Subtext
          ctx.fillStyle = 'rgba(255,255,255,0.55)';
          ctx.font = '600 12px "Space Grotesk", system-ui, -apple-system, Segoe UI, Roboto, Arial';
          ctx.fillText(total > 0 ? `${value} payout${value === 1 ? '' : 's'}` : 'No payouts yet', centerX, centerY + 34);
    
          ctx.restore();
        }
      };
    
      window.chainSplitChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: prettyLabels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderWidth: 0,
            hoverOffset: 10,
            spacing: 2,
            borderRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '76%',
          animation: {
            duration: 700,
            easing: 'easeOutQuart'
          },
          plugins: {
            legend: {
              position: 'top',
              align: 'start',
              labels: {
                boxWidth: 10,
                boxHeight: 10,
                usePointStyle: true,
                pointStyle: 'circle',
                padding: 14,
                color: 'rgba(255,255,255,0.72)',
                font: { size: 12, weight: '600' }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(10, 15, 25, 0.92)',
              borderColor: 'rgba(255,255,255,0.10)',
              borderWidth: 1,
              padding: 10,
              titleColor: 'rgba(255,255,255,0.90)',
              bodyColor: 'rgba(255,255,255,0.72)',
              displayColors: true,
              callbacks: {
                label: (c) => {
                  const v = c.raw || 0;
                  const p = total > 0 ? Math.round((v / total) * 100) : 0;
                  return ` ${v} payout${v === 1 ? '' : 's'} ‚Ä¢ ${p}%`;
                }
              }
            }
          },
          onHover: (evt, elements, chart) => {
            // Make center label react immediately on hover
            chart.draw();
          }
        },
        plugins: [centerLabelPlugin]
      });
    }




    // === AUTH ===
    async function handleAuthSubmit(e) {
      e.preventDefault();
    
      const form = e.target;
      const email = form.email.value.trim();
      const password = form.password.value;
    
      if (!email || !password) {
        setAuthMessage('Email and password are required.', 'error');
        return;
      }
    
      setAuthMessage('Working...');
    
      try {
        if (authMode === 'signup') {
          const { error } = await sb.auth.signUp({ email, password });
          if (error) throw error;
    
          setAuthMessage('Account created. Now sign in.', 'success');
          setAuthMode('signin');
          return;
        }
    
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
    
        console.log('SIGNIN RESULT:', { data, error });
    
        if (error) {
          setAuthMessage(error.message || 'Sign-in failed.', 'error');
          return;
        }
    
        setAuthMessage('');
        // onAuthStateChange will handle UI + loading, but call once to be instant:
        await onAuthChanged();
    
      } catch (err) {
        console.error('AUTH EXCEPTION:', err);
        setAuthMessage(err?.message || 'Auth error.', 'error');
      }
    }
    
    async function handleSignOut() {
      await sb.auth.signOut();
      await onAuthChanged();
    }

    function renderDashboardChartsFromCache() {
      // build the monthly chart from whatever is in the cache
      if (typeof buildMonthlyPayoutChart === 'function') {
        buildMonthlyPayoutChart(dashboardPayoutsCache || []);
      }
    
      // build chain split chart if you have it wired
      if (typeof buildChainSplitChart === 'function') {
        buildChainSplitChart(dashboardPayoutsCache || []);
      }
    }

    
    async function onAuthChanged(event) {
      const signedIn = !!CURRENT_USER;
    
      const authWrapper = document.getElementById("auth-wrapper");
      const appShell = document.querySelector(".app-shell");
      const signoutBtn = document.getElementById("signout-btn");
    
      // Toggle UI
      if (authWrapper) authWrapper.style.display = signedIn ? "none" : "flex";
      if (appShell) appShell.style.display = signedIn ? "block" : "none";
      if (signoutBtn) signoutBtn.style.display = signedIn ? "inline-block" : "none";
    
      // If signed out, stop here (prevents data calls)
      if (!signedIn) return;
    
      // Load data AFTER we know user exists
      try {
        await loadContractors?.();
        await loadPayoutContractorOptions?.();
        await loadPayouts?.();
        await loadDashboard?.();
        await loadWallets?.();
      } catch (e) {
        console.error("onAuthChanged load error:", e);
      }
    }



    // =============================
    // On-chain helpers (Base)
    // =============================
    const BASE = {
      chainId: 8453,
      rpc: "https://mainnet.base.org",
      usdc: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", // Base USDC :contentReference[oaicite:2]{index=2}
      usdcDecimals: 6,
    };
    
    // basic JSON-RPC
    async function rpc(rpcUrl, method, params = []) {
      const res = await fetch(rpcUrl, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ jsonrpc: "2.0", id: Date.now(), method, params }),
      });
      const json = await res.json();
      if (json.error) throw new Error(json.error.message || "RPC error");
      return json.result;
    }
    
    // pad topic (address -> 32-byte topic)
    function topicAddress(addr) {
      return "0x" + addr.toLowerCase().replace(/^0x/, "").padStart(64, "0");
    }
    
    // hex -> number
    function hexToInt(hex) {
      return parseInt(hex, 16);
    }
    
    // ERC20 balanceOf(address) selector = 0x70a08231
    async function erc20BalanceOf(rpcUrl, token, holder) {
      const data =
        "0x70a08231" + holder.toLowerCase().replace(/^0x/, "").padStart(64, "0");
      const result = await rpc(rpcUrl, "eth_call", [{ to: token, data }, "latest"]);
      return BigInt(result);
    }
    
    function formatUnits(amountBigInt, decimals) {
      const s = amountBigInt.toString().padStart(decimals + 1, "0");
      const whole = s.slice(0, -decimals);
      const frac = s.slice(-decimals).replace(/0+$/, "");
      return frac ? `${whole}.${frac}` : whole;
    }
    
    // Pull recent USDC transfers for a wallet using Transfer topic logs
    async function getUsdcTransfersBase(wallet, fromBlockHex, toBlockHex = "latest") {
      const TRANSFER_TOPIC =
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef";
    
      // incoming: topics[2] = to
      const incoming = await rpc(BASE.rpc, "eth_getLogs", [{
        fromBlock: fromBlockHex,
        toBlock: toBlockHex,
        address: BASE.usdc,
        topics: [TRANSFER_TOPIC, null, topicAddress(wallet)],
      }]);
    
      // outgoing: topics[1] = from
      const outgoing = await rpc(BASE.rpc, "eth_getLogs", [{
        fromBlock: fromBlockHex,
        toBlock: toBlockHex,
        address: BASE.usdc,
        topics: [TRANSFER_TOPIC, topicAddress(wallet), null],
      }]);
    
      // normalize
      const parseLog = (log, direction) => {
        const from = "0x" + log.topics[1].slice(26);
        const to = "0x" + log.topics[2].slice(26);
        const value = BigInt(log.data);
        return {
          direction,
          from,
          to,
          value,
          txHash: log.transactionHash,
          blockNumber: hexToInt(log.blockNumber),
        };
      };
    
      return [
        ...incoming.map(l => parseLog(l, "in")),
        ...outgoing.map(l => parseLog(l, "out")),
      ].sort((a, b) => b.blockNumber - a.blockNumber);
    }


    function initWalletSelector() {
      const selector = document.querySelector('.wallet-selector');
      if (!selector) return;
    
      const current = selector.querySelector('.wallet-selector-current');
    
      // Toggle open/close + click outside closes
      document.addEventListener('click', (event) => {
        const clickedInside = selector.contains(event.target);
        const clickedToggle = event.target.closest('.wallet-selector-toggle');
    
        if (clickedInside && clickedToggle) {
          selector.classList.toggle('is-open');
          return;
        }
    
        if (!clickedInside) {
          selector.classList.remove('is-open');
        }
      });
    
      // Pick an item
      selector.addEventListener('click', (e) => {
        const item = e.target.closest('.wallet-selector-item');
        if (!item) return;
    
        // Active UI
        selector.querySelectorAll('.wallet-selector-item').forEach(btn =>
          btn.classList.remove('wallet-selector-item--active')
        );
        item.classList.add('wallet-selector-item--active');
    
        // Update label
        const name = item.querySelector('.wallet-selector-item-name')?.textContent?.trim();
        if (current && name) current.textContent = name;
    
        // Close menu
        selector.classList.remove('is-open');
    
        // TODO: set your wallet filter state here
        // selectedWallet = item.dataset.wallet;  // e.g. global var
        // loadDashboard(); loadPayouts(); highlightDashboard();
      });
    }

    function animateOnce(el, className, ms = 600) {
      if (!el) return;
      el.classList.remove(className);
      void el.offsetWidth; // force reflow so it restarts
      el.classList.add(className);
      setTimeout(() => el.classList.remove(className), ms);
    }
    
    // Use your existing showToast() if you want.
    // If you already have showToast(message) keep it and ignore this.
    function toastSuccess(msg) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.classList.add('toast-success');
      showToast(msg);
      setTimeout(() => toast.classList.remove('toast-success'), 800);
    }


    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ DOMContentLoaded: Soltra init starting...');
    
      // ---------- small helper ----------
      const bindOnce = (el, key, fn) => {
        if (!el) return;
        const host = el.dataset ? el : document.body;
        const k = `bound_${key}`;
        if (host.dataset[k] === '1') return;
        host.dataset[k] = '1';
        fn();
      };
    
      // ---------- dropdown UI ----------
      if (typeof initWalletLabelToggle === 'function') initWalletLabelToggle();
      if (typeof initWalletTypeDropdown === 'function') initWalletTypeDropdown();
      if (typeof initWalletSelector === 'function') initWalletSelector();
    
      // ---------- tabs ----------
      if (typeof initTabs === 'function') initTabs();
    
      // ---------- payout detail side panel ----------
      if (typeof wirePayoutRowClicks === 'function') {
        bindOnce(document.body, 'wire_payout_rows', () => wirePayoutRowClicks());
      }
      if (typeof wirePayoutDetailPanel === 'function') {
        bindOnce(document.body, 'wire_payout_detail_panel', () => wirePayoutDetailPanel());
      }
    
      // ---------- wallet modal open/close + submit ----------
      const walletModal = document.getElementById('wallet-modal');
      const openWalletBtn =
        document.getElementById('open-wallet-modal') || document.getElementById('wallet-add-btn');
    
      bindOnce(openWalletBtn, 'wallet_open', () => {
        openWalletBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (typeof openWalletModal === 'function') {
            openWalletModal();
          } else if (walletModal) {
            walletModal.classList.remove('hidden');
          }
        });
      });
    
      if (walletModal) {
        bindOnce(walletModal, 'wallet_close_clicks', () => {
          walletModal.addEventListener('click', (e) => {
            // close on backdrop or any element with data-close="wallet-modal"
            if (e.target.classList.contains('modal-backdrop') || e.target.closest('[data-close="wallet-modal"]')) {
              if (typeof closeWalletModal === 'function') closeWalletModal();
              else walletModal.classList.add('hidden');
            }
          });
        });
    
        bindOnce(document, 'wallet_esc', () => {
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !walletModal.classList.contains('hidden')) {
              if (typeof closeWalletModal === 'function') closeWalletModal();
              else walletModal.classList.add('hidden');
            }
          });
        });
      }
    
      const walletFormEl = document.getElementById('wallet-form');
      bindOnce(walletFormEl, 'wallet_submit', () => {
        walletFormEl.addEventListener('submit', (e) => {
          if (typeof addWalletFromForm === 'function') return addWalletFromForm(e);
          e.preventDefault();
          console.warn('No addWalletFromForm() found.');
        });
      });
    
      const walletsListEl = document.getElementById('wallets-list');
      bindOnce(walletsListEl, 'wallet_list_clicks', () => {
        if (typeof onWalletListClick !== 'function') return;
        walletsListEl.addEventListener('click', onWalletListClick);
      });
    
      // ---------- forms ----------
      const payoutForm = document.getElementById('payout-form');
      bindOnce(payoutForm, 'payout_form', () => {
        payoutForm.addEventListener('submit', addPayout);
      });
    
      const contractorAddForm = document.getElementById('add-contractor-form');
      bindOnce(contractorAddForm, 'contractor_form', () => {
        contractorAddForm.addEventListener('submit', addContractor);
      });
    
      // ---------- filters ----------
      const rangeSelect = document.getElementById('dash-range');
      bindOnce(rangeSelect, 'dash_range', () => {
        rangeSelect.addEventListener('change', () => {
          filterRange = rangeSelect.value;
          loadDashboard?.();
          loadPayouts?.();
          highlightDashboard?.();
        });
      });
    
      const chainSelect = document.getElementById('dash-chain');
      bindOnce(chainSelect, 'dash_chain', () => {
        chainSelect.addEventListener('change', () => {
          filterChain = chainSelect.value;
          loadDashboard?.();
          loadPayouts?.();
          highlightDashboard?.();
        });
      });
    
      // ---------- auth ----------
      const authForm = document.getElementById('auth-form');
      bindOnce(authForm, 'auth_form', () => {
        authForm.addEventListener('submit', handleAuthSubmit);
      });
    
      const toggle = document.getElementById('auth-toggle-mode');
      bindOnce(toggle, 'auth_toggle', () => {
        toggle.addEventListener('click', () => {
          setAuthMode(authMode === 'signin' ? 'signup' : 'signin');
        });
      });
    
      const signoutBtn = document.getElementById('signout-btn');
      bindOnce(signoutBtn, 'signout', () => {
        signoutBtn.addEventListener('click', handleSignOut);
      });
    
      // ---------- payout modal copy (ONE place) ----------
      const payoutCopyBtn = document.getElementById('payout-modal-copy');
      bindOnce(payoutCopyBtn, 'payout_copy', () => {
        payoutCopyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          const hashEl = document.getElementById('payout-modal-txhash');
          const text = (hashEl?.textContent || '').trim();
          if (!text || text === '‚Äî') return;
    
          try {
            await navigator.clipboard.writeText(text);
            showToast?.('Copied!');
          } catch (err) {
            console.error('Failed to copy:', err);
            alert('Copy failed ‚Äî browser blocked clipboard.');
          }
        });
      });
    
      // ---------- export button ----------
      if (typeof bindExportButton === 'function') bindExportButton();
    
      console.log('‚úÖ DOMContentLoaded: Soltra init complete.');
    });



      
    

  </script>
      <div id="payout-detail-modal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card">
        <div class="modal-header">
          <h3>Payout details</h3>
          <button id="payout-modal-close" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-row"><span>Date</span><strong id="payout-modal-date"></strong></div>
          <div class="modal-row"><span>Contractor</span><strong id="payout-modal-contractor"></strong></div>
          <div class="modal-row"><span>Amount</span><strong id="payout-modal-amount"></strong></div>
          <div class="modal-row"><span>Chain</span><strong id="payout-modal-chain"></strong></div>
          <div class="modal-row">
            <span>Tx hash</span>
            <a id="payout-modal-txhash" href="#" target="_blank" rel="noopener noreferrer"></a>
          </div>
          <div class="modal-row">
            <span>Notes</span>
            <p id="payout-modal-note" class="modal-note"></p>
          </div>
        </div>
      </div>
    </div>
        <!-- Payout detail modal -->
    <div id="payout-modal" class="payout-modal hidden">
      <div class="payout-modal-backdrop"></div>
    
      <div class="payout-modal-dialog">
        <div class="payout-modal-header">
          <h3>Payout details</h3>
          <button
            id="payout-modal-close"
            class="payout-modal-close"
            aria-label="Close"
          >
            &times;
          </button>
        </div>
    
        <!-- turn body into a form so we can save the note -->
        <form id="payout-modal-form" class="payout-modal-body">
          <!-- hidden id so we know which payout to update/delete -->
          <input type="hidden" id="payout-modal-id" />
    
          <!-- Main details -->
          <dl class="payout-modal-grid">
            <div>
              <dt>Contractor</dt>
              <dd id="payout-modal-contractor">‚Äî</dd>
            </div>
            <div>
              <dt>Amount</dt>
              <dd id="payout-modal-amount">‚Äî</dd>
            </div>
            <div>
              <dt>Date</dt>
              <dd id="payout-modal-date">‚Äî</dd>
            </div>
            <div>
              <dt>Chain</dt>
              <dd id="payout-modal-chain">‚Äî</dd>
            </div>
          </dl>
    
          <!-- Tx hash with copy button (unchanged functionally) -->
          <div class="payout-modal-field">
            <div class="modal-label-row">
              <span class="modal-label">TX hash</span>
              <button
                type="button"
                id="payout-modal-copy"
                class="modal-copy-btn"
              >
                Copy
              </button>
            </div>
            <code id="payout-modal-txhash" class="modal-code">‚Äî</code>
          </div>
    
          <!-- Editable Notes -->
          <div class="payout-modal-field">
            <span class="modal-label">Notes</span>
            <textarea
              id="payout-modal-note"
              class="modal-note-input"
              rows="3"
              placeholder="Add an internal note about this payout‚Ä¶"
            ></textarea>
          </div>
    
          <!-- Footer buttons -->
          <div class="payout-modal-footer">
            <button
              type="button"
              id="payout-modal-delete"
              class="modal-btn secondary danger"
            >
              Delete payout
            </button>
    
            <button type="submit" class="modal-btn primary">
              Save changes
            </button>
          </div>
        </form>
      </div>
    </div>


      <!-- Contractor detail modal -->
      <div id="contractor-modal" class="payout-modal hidden">
        <div class="payout-modal-backdrop"></div>
      
        <div class="payout-modal-dialog">
          <div class="payout-modal-header">
            <h3 id="contractor-modal-title">Edit contractor</h3>
            <button
              id="contractor-modal-close"
              class="payout-modal-close"
              aria-label="Close"
            >
              &times;
            </button>
          </div>
      
          <form id="contractor-modal-form" class="payout-modal-body">
            <input type="hidden" id="contractor-modal-id" />
      
            <dl class="payout-modal-grid">
              <div>
                <dt>Name</dt>
                <dd>
                  <input
                    id="contractor-modal-name"
                    type="text"
                    class="modal-input"
                    required
                  />
                </dd>
              </div>
      
              <div>
                <dt>Role</dt>
                <dd>
                  <input
                    id="contractor-modal-role"
                    type="text"
                    class="modal-input"
                  />
                </dd>
              </div>
      
              <div>
                <dt>Wallet address</dt>
                <dd>
                  <input
                    id="contractor-modal-wallet"
                    type="text"
                    class="modal-input"
                  />
                </dd>
              </div>
      
              <div>
                <dt>Country</dt>
                <dd>
                  <input
                    id="contractor-modal-country"
                    type="text"
                    class="modal-input"
                  />
                </dd>
              </div>
            </dl>
      
            <div class="payout-modal-footer">
              <button
                type="button"
                id="contractor-modal-delete"
                class="modal-btn secondary danger"
              >
                Delete contractor
              </button>
      
              <button type="submit" class="modal-btn primary">
                Save changes
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Wallet modal (FULL wallet-card UI inside) -->
      <div id="wallet-modal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" data-close-wallet></div>

        <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="wallet-modal-title">
          <div class="modal-head">
            <div>
              <div id="wallet-modal-title" class="modal-title">Add treasury wallet</div>
              <div class="modal-subtitle">
                Track balances and on-chain activity across your organization.
              </div>
            </div>

            <button class="icon-btn" type="button" aria-label="Close" data-close-wallet>‚úï</button>
          </div>

          <!-- Treasury wallets (Custom wallet type dropdown + address + submit + saved list) -->
          <section class="wallet-card">
            <div class="wallet-card-header">
              <h3 class="wallet-card-title">Treasury wallets</h3>
              <p class="wallet-card-subtitle">Add wallets to track balances and on-chain activity.</p>
            </div>

            <form id="wallet-form" class="wallet-form">
              <!-- WALLET TYPE (CUSTOM DROPDOWN) -->
              <div class="field">
                <label class="field-label" for="wallet-type-btn">Wallet type</label>

                <div class="dropdown" data-dropdown="walletType">
                  <!-- Trigger button -->
                  <button
                    id="wallet-type-btn"
                    class="select-btn"
                    type="button"
                    aria-haspopup="listbox"
                    aria-expanded="false"
                  >
                    <span class="select-left">
                      <img class="select-icon" src="images/safe-logo.svg" alt="Safe" />
                      <span id="wallet-type-text">Safe (Gnosis)</span>
                    </span>
                    <span class="select-caret" aria-hidden="true"></span>
                  </button>

                  <!-- Menu -->
                  <div class="select-menu hidden" role="listbox" aria-label="Wallet type">
                    <!-- Safe -->
                    <div
                      class="select-option is-selected"
                      role="option"
                      tabindex="0"
                      data-value="safe"
                      data-label="Safe (Gnosis)"
                      data-icon="images/safe-logo.svg"
                    >
                      <img class="option-icon" src="images/safe-logo.svg" alt="" />
                      <span class="option-text">Safe (Gnosis)</span>
                    </div>

                    <!-- Ledger -->
                    <div
                      class="select-option"
                      role="option"
                      tabindex="0"
                      data-value="ledger"
                      data-label="Ledger"
                      data-icon="images/ledger.svg"
                    >
                      <img class="option-icon" src="images/ledger.svg" alt="" />
                      <span class="option-text">Ledger</span>
                    </div>

                    <!-- MetaMask -->
                    <div
                      class="select-option"
                      role="option"
                      tabindex="0"
                      data-value="metamask"
                      data-label="MetaMask"
                      data-icon="images/metamask.svg"
                    >
                      <img class="option-icon" src="images/metamask.svg" alt="" />
                      <span class="option-text">MetaMask</span>
                    </div>

                    <!-- Coinbase Wallet -->
                    <div
                      class="select-option"
                      role="option"
                      tabindex="0"
                      data-value="coinbase"
                      data-label="Coinbase Wallet"
                      data-icon="images/coinbase-wallet.svg"
                    >
                      <img class="option-icon" src="images/coinbase-wallet.svg" alt="" />
                      <span class="option-text">Coinbase Wallet</span>
                    </div>

                    <!-- Other -->
                    <div
                      class="select-option"
                      role="option"
                      tabindex="0"
                      data-value="other"
                      data-label="Other wallet"
                      data-icon="images/wallet-generic.svg"
                    >
                      <img class="option-icon" src="images/wallet-generic.svg" alt="" />
                      <span class="option-text">Other wallet</span>
                    </div>
                  </div>

                  <!-- What FormData reads -->
                  <input type="hidden" name="wallet_type" id="wallet_type" value="safe" />
                </div>
              </div>

              <!-- Chain -->
              <div class="field">
                <label class="field-label" for="wallet-chain">Chain<span>*</span></label>

                <select id="wallet-chain" name="chain" class="input-control" required>
                  <option value="base" selected>Base</option>
                  <option value="ethereum">Ethereum</option>
                  <option value="polygon">Polygon</option>
                </select>

                <p class="field-help">Pick the chain where this address is active (for real feeds later).</p>
              </div>

              <!-- ADDRESS -->
              <div class="field">
                <label class="field-label" for="wallet-address">Address</label>
                <input
                  id="wallet-address"
                  name="address"
                  class="input-control mono"
                  type="text"
                  placeholder="0x‚Ä¶"
                  required
                  autocomplete="off"
                  spellcheck="false"
                />
              </div>

              <!-- SUBMIT -->
              <div class="wallet-actions">
                <button id="add-wallet-btn" type="submit" class="btn primary-btn">Add wallet</button>
                <p id="wallet-message" class="form-message" aria-live="polite"></p>
              </div>
            </form>

            <!-- SAVED WALLETS -->
            <div class="wallet-saved">
              <h4 class="wallet-saved-title">Saved wallets</h4>

              <div id="wallets-list" class="wallets-list">
                <div class="empty-state" id="wallet-empty">
                  <div class="empty-state-title">No wallets yet</div>
                  <p class="empty-state-text">Add a treasury wallet address to start your feed.</p>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

  <div id="toast" class="toast hidden">Copied!</div>
  <div id="copy-toast" class="copy-toast">Copied!</div>
</body>
</html>


